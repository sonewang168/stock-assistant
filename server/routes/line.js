/**
 * ğŸ’¬ LINE Bot è·¯ç”±
 */

const express = require('express');
const router = express.Router();
const stockService = require('../services/stockService');
const technicalService = require('../services/technicalService');
const lineService = require('../services/lineService');
const { pool } = require('../db');

/**
 * POST /webhook
 * LINE Webhook æ¥æ”¶è¨Šæ¯
 * 
 * é‡è¦ï¼šå¿…é ˆåœ¨ 1 ç§’å…§å›è¦† 200ï¼Œå¦å‰‡ LINE æœƒé‡è©¦ï¼
 */

// é˜²é‡æ©Ÿåˆ¶ï¼šè¨˜éŒ„å·²è™•ç†çš„è¨Šæ¯ IDï¼ˆç”¨ message.id è€Œé webhookEventIdï¼‰
const processedMessages = new Map();
const MESSAGE_COOLDOWN = 60000; // 60 ç§’å…§åŒä¸€è¨Šæ¯ä¸é‡è¤‡è™•ç†

function isProcessed(messageId) {
  const now = Date.now();
  
  // æ¸…ç†éæœŸè¨˜éŒ„
  for (const [id, time] of processedMessages) {
    if (now - time > MESSAGE_COOLDOWN) {
      processedMessages.delete(id);
    }
  }
  
  if (processedMessages.has(messageId)) {
    console.log(`â­ï¸ è·³éé‡è¤‡è¨Šæ¯: ${messageId}`);
    return true;
  }
  
  processedMessages.set(messageId, now);
  return false;
}

router.post('/', (req, res) => {
  // âš¡ ç«‹å³å›è¦† 200ï¼ˆé¿å… LINE é‡è©¦ï¼‰
  res.status(200).send('OK');
  
  // ç•°æ­¥è™•ç†è¨Šæ¯ï¼ˆä¸é˜»å¡å›è¦†ï¼‰
  setImmediate(async () => {
    try {
      // è§£æ body
      const body = typeof req.body === 'string' 
        ? JSON.parse(req.body) 
        : req.body;
      
      if (!body.events || body.events.length === 0) {
        return;
      }
      
      const event = body.events[0];
      
      // ğŸ›¡ï¸ ç”¨ message.id é˜²é‡ï¼ˆé€™å€‹ ID ä¸æœƒå› é‡è©¦è€Œæ”¹è®Šï¼‰
      const messageId = event.message?.id;
      if (!messageId) {
        console.log('âš ï¸ è¨Šæ¯æ²’æœ‰ IDï¼Œè·³é');
        return;
      }
      
      if (isProcessed(messageId)) {
        return; // å·²è™•ç†éï¼Œè·³é
      }
      
      console.log(`ğŸ“© è™•ç†è¨Šæ¯ ID: ${messageId}`);
      
      // è™•ç†è¨Šæ¯äº‹ä»¶
      if (event.type === 'message' && event.message.type === 'text') {
        const userId = event.source.userId;
        const userMessage = event.message.text.trim();
        
        // å„²å­˜ User ID
        await saveLineUserId(userId);
        
        // è™•ç†æŒ‡ä»¤ï¼ˆåªç”¨ pushï¼Œä¸ç”¨ replyï¼‰
        const response = await handleCommand(userMessage, userId);
        
        if (response) {
          await lineService.sendTextMessage(userId, response.text || 'è™•ç†å®Œæˆ');
        }
      }
      
      // Follow äº‹ä»¶
      if (event.type === 'follow') {
        const userId = event.source.userId;
        await saveLineUserId(userId);
        
        await lineService.sendTextMessage(userId, 
          'ğŸ‘‹ æ­¡è¿ä½¿ç”¨è‚¡æµ·ç§˜æ›¸ï¼\n\nè¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼ˆå¦‚ 2330ï¼‰æŸ¥è©¢è‚¡åƒ¹\nè¼¸å…¥ã€Œèªªæ˜ã€æŸ¥çœ‹æ‰€æœ‰æŒ‡ä»¤'
        );
      }
      
    } catch (error) {
      console.error('Webhook è™•ç†éŒ¯èª¤:', error);
    }
  });
});

/**
 * è™•ç†ä½¿ç”¨è€…æŒ‡ä»¤
 */
async function handleCommand(message, userId) {
  const msg = message.trim();
  
  // æŸ¥è©¢è‚¡åƒ¹ï¼šè¼¸å…¥ä»£ç¢¼
  if (/^\d{4,6}$/.test(msg)) {
    return await getStockInfoReply(msg);
  }
  
  // åŠ ç›£æ§æŒ‡ä»¤ï¼š+2330 æˆ– åŠ 2330 æˆ– ç›£æ§2330
  if (/^[+ï¼‹åŠ ç›£æ§]\s*\d{4,6}$/.test(msg)) {
    const stockId = msg.replace(/^[+ï¼‹åŠ ç›£æ§]\s*/, '').trim();
    return await addToWatchlist(stockId);
  }
  
  // ç§»é™¤ç›£æ§ï¼š-2330 æˆ– åˆª2330
  if (/^[-ï¼åˆªç§»é™¤]\s*\d{4,6}$/.test(msg)) {
    const stockId = msg.replace(/^[-ï¼åˆªç§»é™¤]\s*/, '').trim();
    return await removeFromWatchlist(stockId);
  }
  
  // æœå°‹è‚¡ç¥¨ï¼šæŸ¥ å°ç©é›»ã€æ‰¾ é´»æµ·
  if (/^[æŸ¥æ‰¾æœ]\s*.+$/.test(msg)) {
    const keyword = msg.replace(/^[æŸ¥æ‰¾æœ]\s*/, '').trim();
    return await searchStock(keyword);
  }
  
  // æŒ‡ä»¤åˆ—è¡¨
  const commands = {
    'æŒè‚¡': () => getPortfolioReply(),
    'ç›£æ§': () => getWatchlistReply(),
    'ç†±é–€': () => getHotStocksReply(),
    'å¤§ç›¤': () => getMarketReply(),
    'æŒ‡æ•¸': () => getMarketReply(),
    'èªªæ˜': () => getHelpReply(),
    'help': () => getHelpReply()
  };
  
  // èªéŸ³æŒ‡ä»¤ï¼šèªéŸ³ 2330
  if (msg.startsWith('èªéŸ³') || msg.startsWith('æ’­å ±')) {
    const stockId = msg.replace(/^(èªéŸ³|æ’­å ±)\s*/, '').trim();
    if (/^\d{4,6}$/.test(stockId)) {
      return await sendVoiceReport(stockId, userId);
    }
    return { type: 'text', text: 'è«‹è¼¸å…¥ï¼šèªéŸ³ è‚¡ç¥¨ä»£ç¢¼\nä¾‹å¦‚ï¼šèªéŸ³ 2330' };
  }
  
  for (const [cmd, handler] of Object.entries(commands)) {
    if (msg.includes(cmd)) {
      return await handler();
    }
  }
  
  // å˜—è©¦ç”¨åç¨±æœå°‹
  if (msg.length >= 2 && !/^\d+$/.test(msg)) {
    const searchResult = await searchStock(msg);
    if (searchResult.text.includes('æ‰¾åˆ°')) {
      return searchResult;
    }
  }
  
  // æ‰¾ä¸åˆ°æŒ‡ä»¤
  return {
    type: 'text',
    text: `ğŸ¤” ä¸èªè­˜ã€Œ${msg}ã€\n\n` +
      `ğŸ“ æŸ¥è‚¡åƒ¹ï¼šè¼¸å…¥ä»£ç¢¼å¦‚ 2330\n` +
      `ğŸ” æœè‚¡ç¥¨ï¼šæŸ¥ å°ç©é›»\n` +
      `â• åŠ ç›£æ§ï¼š+2330\n` +
      `ğŸ“‹ è¼¸å…¥ã€Œèªªæ˜ã€çœ‹æ›´å¤š`
  };
}

/**
 * å–å¾—è‚¡ç¥¨è³‡è¨Šå›è¦†
 */
async function getStockInfoReply(stockId) {
  const stockData = await stockService.getRealtimePrice(stockId);
  
  if (!stockData) {
    return { type: 'text', text: `âŒ æ‰¾ä¸åˆ°è‚¡ç¥¨ ${stockId}` };
  }
  
  const indicators = await technicalService.getFullIndicators(stockId);
  const chip = await stockService.getInstitutionalData(stockId);
  
  let info = `ğŸ“Š ${stockData.name}ï¼ˆ${stockId}ï¼‰\n`;
  info += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  info += `ğŸ’° ç¾åƒ¹ï¼š${stockData.price}\n`;
  info += `ğŸ“ˆ æ¼²è·Œï¼š${stockData.change > 0 ? '+' : ''}${stockData.change}ï¼ˆ${stockData.changePercent}%ï¼‰\n`;
  info += `ğŸ“Š é–‹ï¼š${stockData.open} é«˜ï¼š${stockData.high}\n`;
  info += `ğŸ“Š ä½ï¼š${stockData.low} æ˜¨ï¼š${stockData.yesterday}\n`;
  
  if (indicators) {
    info += `\nğŸ“ˆ æŠ€è¡“æŒ‡æ¨™\n`;
    info += `RSI(14)ï¼š${indicators.rsi || 'N/A'}\n`;
    if (indicators.kd) {
      info += `KD(9)ï¼š${indicators.kd.k}/${indicators.kd.d}\n`;
    }
  }
  
  if (chip) {
    info += `\nğŸ’° ä¸‰å¤§æ³•äºº\n`;
    info += `å¤–è³‡ï¼š${chip.foreign > 0 ? '+' : ''}${(chip.foreign/1000).toFixed(0)}å¼µ\n`;
    info += `æŠ•ä¿¡ï¼š${chip.investment > 0 ? '+' : ''}${(chip.investment/1000).toFixed(0)}å¼µ\n`;
  }
  
  return { type: 'text', text: info };
}

/**
 * å–å¾—æŒè‚¡å›è¦†
 */
async function getPortfolioReply() {
  const sql = `
    SELECT p.stock_id, p.shares, p.avg_cost, s.name as stock_name
    FROM portfolio p
    LEFT JOIN stocks s ON p.stock_id = s.id
    WHERE p.user_id = 'default' AND p.shares > 0
    LIMIT 20
  `;
  
  const result = await pool.query(sql);
  
  if (result.rows.length === 0) {
    return { type: 'text', text: 'ğŸ“­ ç›®å‰æ²’æœ‰æŒè‚¡ç´€éŒ„\n\nè«‹åœ¨ç¶²é ç‰ˆæ–°å¢æŒè‚¡' };
  }
  
  let info = 'ğŸ’¼ æˆ‘çš„æŒè‚¡\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
  
  for (const row of result.rows) {
    const name = row.stock_name || row.stock_id;
    info += `â€¢ ${name}ï¼š${row.shares}è‚¡ @ $${row.avg_cost}\n`;
  }
  
  return { type: 'text', text: info };
}

/**
 * å–å¾—ç›£æ§æ¸…å–®å›è¦†ï¼ˆä½¿ç”¨ default ç”¨æˆ¶ï¼Œèˆ‡ç¶²é ç‰ˆåŒæ­¥ï¼‰
 */
async function getWatchlistReply() {
  const sql = `
    SELECT w.stock_id, s.name as stock_name
    FROM watchlist w
    LEFT JOIN stocks s ON w.stock_id = s.id
    WHERE w.user_id = 'default' AND w.is_active = true
    ORDER BY w.created_at DESC
    LIMIT 20
  `;
  
  const result = await pool.query(sql);
  
  if (result.rows.length === 0) {
    return { type: 'text', text: 'ğŸ“­ ç›®å‰æ²’æœ‰ç›£æ§è‚¡ç¥¨\n\nè¼¸å…¥ã€Œ+2330ã€åŠ å…¥ç›£æ§' };
  }
  
  let info = 'ğŸ“‹ ç›£æ§æ¸…å–®\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
  
  for (const row of result.rows) {
    const name = row.stock_name || row.stock_id;
    info += `â€¢ ${name}ï¼ˆ${row.stock_id}ï¼‰\n`;
  }
  
  info += `\nğŸ’¡ è¼¸å…¥ã€Œ+ä»£ç¢¼ã€åŠ å…¥\nğŸ’¡ è¼¸å…¥ã€Œ-ä»£ç¢¼ã€ç§»é™¤`;
  
  return { type: 'text', text: info };
}

/**
 * åŠ å…¥ç›£æ§æ¸…å–®
 */
async function addToWatchlist(stockId) {
  try {
    // å…ˆç¢ºèªè‚¡ç¥¨å­˜åœ¨
    const stockData = await stockService.getRealtimePrice(stockId);
    
    if (!stockData) {
      return { type: 'text', text: `âŒ æ‰¾ä¸åˆ°è‚¡ç¥¨ ${stockId}` };
    }
    
    // ç¢ºä¿ stocks è¡¨æœ‰é€™æ”¯è‚¡ç¥¨
    await pool.query(`
      INSERT INTO stocks (id, name, market) 
      VALUES ($1, $2, $3)
      ON CONFLICT (id) DO UPDATE SET name = $2
    `, [stockId, stockData.name, stockData.market || 'TSE']);
    
    // åŠ å…¥ç›£æ§ï¼ˆä½¿ç”¨ default ç”¨æˆ¶ï¼‰
    const sql = `
      INSERT INTO watchlist (stock_id, user_id)
      VALUES ($1, 'default')
      ON CONFLICT (stock_id, user_id) 
      DO UPDATE SET is_active = true
      RETURNING *
    `;
    
    await pool.query(sql, [stockId]);
    
    return { 
      type: 'text', 
      text: `âœ… å·²åŠ å…¥ç›£æ§\n\nğŸ“Š ${stockData.name}ï¼ˆ${stockId}ï¼‰\nğŸ’° ç¾åƒ¹ï¼š${stockData.price} å…ƒ\n\nğŸ’¡ è¼¸å…¥ã€Œç›£æ§ã€æŸ¥çœ‹æ¸…å–®` 
    };
    
  } catch (error) {
    console.error('åŠ å…¥ç›£æ§éŒ¯èª¤:', error);
    return { type: 'text', text: 'âš ï¸ åŠ å…¥ç›£æ§å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦' };
  }
}

/**
 * ç§»é™¤ç›£æ§
 */
async function removeFromWatchlist(stockId) {
  try {
    const sql = `
      UPDATE watchlist 
      SET is_active = false 
      WHERE stock_id = $1 AND user_id = 'default'
      RETURNING *
    `;
    
    const result = await pool.query(sql, [stockId]);
    
    if (result.rows.length === 0) {
      return { type: 'text', text: `âŒ ${stockId} ä¸åœ¨ç›£æ§æ¸…å–®ä¸­` };
    }
    
    return { 
      type: 'text', 
      text: `âœ… å·²ç§»é™¤ç›£æ§ï¼š${stockId}\n\nğŸ’¡ è¼¸å…¥ã€Œç›£æ§ã€æŸ¥çœ‹æ¸…å–®` 
    };
    
  } catch (error) {
    console.error('ç§»é™¤ç›£æ§éŒ¯èª¤:', error);
    return { type: 'text', text: 'âš ï¸ ç§»é™¤ç›£æ§å¤±æ•—' };
  }
}

/**
 * å–å¾—æŒ‡æ•¸/å¤§ç›¤å›è¦†
 */
async function getMarketReply() {
  try {
    // å–å¾—å¤§ç›¤æŒ‡æ•¸
    const taiex = await stockService.getRealtimePrice('t00');
    
    if (!taiex) {
      return { type: 'text', text: 'âš ï¸ ç„¡æ³•å–å¾—å¤§ç›¤è³‡è¨Š' };
    }
    
    const isUp = taiex.change >= 0;
    
    let info = `ğŸ“ˆ å°è‚¡å¤§ç›¤\n`;
    info += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    info += `åŠ æ¬ŠæŒ‡æ•¸ï¼š${taiex.price}\n`;
    info += `æ¼²è·Œï¼š${isUp ? 'ğŸ“ˆ +' : 'ğŸ“‰ '}${taiex.change}ï¼ˆ${taiex.changePercent}%ï¼‰\n`;
    info += `æˆäº¤é‡ï¼š${(taiex.volume / 100000000).toFixed(0)} å„„\n\n`;
    
    // ç†±é–€è‚¡ç°¡å ±
    const hotStocks = ['2330', '2317', '2454', '2308', '3008'];
    info += `ğŸ”¥ æ¬Šå€¼è‚¡å‹•æ…‹\n`;
    
    for (const id of hotStocks.slice(0, 3)) {
      const stock = await stockService.getRealtimePrice(id);
      if (stock) {
        const up = stock.change >= 0;
        info += `â€¢ ${stock.name}ï¼š${stock.price}ï¼ˆ${up ? '+' : ''}${stock.changePercent}%ï¼‰\n`;
      }
    }
    
    return { type: 'text', text: info };
    
  } catch (error) {
    console.error('å–å¾—å¤§ç›¤éŒ¯èª¤:', error);
    return { type: 'text', text: 'âš ï¸ å–å¾—å¤§ç›¤è³‡è¨Šå¤±æ•—' };
  }
}

/**
 * æœå°‹è‚¡ç¥¨ï¼ˆç”¨åç¨±ï¼‰
 */
async function searchStock(keyword) {
  try {
    // å…ˆå¾è³‡æ–™åº«æœå°‹
    const dbResult = await pool.query(`
      SELECT id, name, market FROM stocks 
      WHERE name LIKE $1 OR id LIKE $1
      LIMIT 5
    `, [`%${keyword}%`]);
    
    if (dbResult.rows.length > 0) {
      let info = `ğŸ” æœå°‹ã€Œ${keyword}ã€\n`;
      info += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
      
      for (const row of dbResult.rows) {
        info += `â€¢ ${row.name}ï¼ˆ${row.id}ï¼‰\n`;
      }
      
      info += `\nğŸ’¡ è¼¸å…¥ä»£ç¢¼æŸ¥è©¢è©³æƒ…`;
      return { type: 'text', text: info };
    }
    
    // å®Œæ•´è‚¡ç¥¨å°ç…§è¡¨
    const stockMap = {
      // ===== æ¬Šå€¼è‚¡ / å¤§å‹è‚¡ =====
      'å°ç©é›»': '2330', 'å°ç©': '2330', 'TSMC': '2330',
      'é´»æµ·': '2317', 'è¯ç™¼ç§‘': '2454', 'è¯ç™¼': '2454',
      'å°é”é›»': '2308', 'å°é”': '2308',
      'å¤§ç«‹å…‰': '3008', 'è¯é›»': '2303',
      'æ—¥æœˆå…‰æŠ•æ§': '3711', 'æ—¥æœˆå…‰': '3711',
      'ä¸­è¯é›»': '2412', 'ä¸­è¯é›»ä¿¡': '2412',
      'å°å¡‘': '1301', 'å—äº': '1303', 'å°åŒ–': '1326',
      'å°å¡‘åŒ–': '6505', 'å°æ³¥': '1101', 'äºæ³¥': '1102',
      'çµ±ä¸€': '1216', 'çµ±ä¸€è¶…': '2912',
      'å’Œæ³°è»Š': '2207', 'è£•éš†': '2201',
      
      // ===== é‡‘èè‚¡ =====
      'åœ‹æ³°é‡‘': '2882', 'åœ‹æ³°': '2882',
      'å¯Œé‚¦é‡‘': '2881', 'å¯Œé‚¦': '2881',
      'ä¸­ä¿¡é‡‘': '2891', 'ä¸­ä¿¡': '2891',
      'ç‰å±±é‡‘': '2884', 'ç‰å±±': '2884',
      'å…ƒå¤§é‡‘': '2885', 'å…ƒå¤§': '2885',
      'å…†è±é‡‘': '2886', 'å…†è±': '2886',
      'ç¬¬ä¸€é‡‘': '2892', 'åˆåº«é‡‘': '5880',
      'è¯å—é‡‘': '2880', 'å°æ–°é‡‘': '2887',
      'æ°¸è±é‡‘': '2890', 'æ–°å…‰é‡‘': '2888',
      'é–‹ç™¼é‡‘': '2883', 'åœ‹ç¥¨é‡‘': '2889',
      'å°ä¼éŠ€': '2834', 'å½°éŠ€': '2801',
      'ä¸Šæµ·å•†éŠ€': '5876', 'äº¬åŸéŠ€': '2809',
      'é æ±éŠ€': '2845', 'å®‰æ³°éŠ€': '2849',
      'ç‹é“éŠ€': '2897', 'è¯é‚¦éŠ€': '2838',
      'å°ä¸­éŠ€': '2812', 'é«˜é›„éŠ€': '2836',
      'ä¸‰ä¿¡å•†éŠ€': '2806', 'è¯ç¥¨': '2820',
      'åœ‹æ³°äººå£½': '2882', 'å¯Œé‚¦äººå£½': '2881',
      'æ–°å…‰äººå£½': '2888', 'å°ç£äººå£½': '2833',
      'å…ƒå¤§è­‰': '6016', 'å‡±åŸºè­‰': '6008',
      'ç¾¤ç›Šè­‰': '6005', 'çµ±ä¸€è­‰': '2855',
      'æ°¸è±é‡‘è­‰': '2890', 'å…ƒå¯Œè­‰': '2856',
      'æ—¥ç››é‡‘': '5820', 'åº·å’Œè­‰': '6016',
      
      // ===== åŠå°é«” - æ™¶åœ“ä»£å·¥ =====
      'åŠ›ç©é›»': '6770', 'ä¸–ç•Œå…ˆé€²': '5347',
      'ç©©æ‡‹': '3105', 'å®æ·ç§‘': '8086',
      'ç’°çƒæ™¶': '6488', 'åˆæ™¶': '6182', 'ä¸­ç¾æ™¶': '5483',
      'å°å‹ç§‘': '3532', 'å˜‰æ™¶': '3016',
      
      // ===== åŠå°é«” - è¨˜æ†¶é«” =====
      'è¯é‚¦é›»': '2344', 'æ—ºå®': '2337', 'å—äºç§‘': '2408',
      'å¨å‰›': '3260', 'åéŠ“': '4967', 'å‰µè¦‹': '2451',
      'éˆºå‰µ': '5351', 'æ™¶è±ªç§‘': '3006', 'è¯æ³°': '2329',
      'åŠ›æ™¶': '5765', 'èŒ‚å¾·': '5765',
      
      // ===== åŠå°é«” - ICè¨­è¨ˆ =====
      'ç‘æ˜±': '2379', 'è¯è© ': '3034', 'çŸ½åŠ›': '6415',
      'ç¾¤è¯': '8299', 'ç¥¥ç¢©': '5269', 'å‰µæ„': '3443',
      'ä¸–èŠ¯': '3661', 'æ™ºåŸ': '3035', 'M31': '6643',
      'è­œç‘': '4966', 'éˆºå¤ª': '6679', 'æ•¦æ³°': '3545',
      'å¥‡æ™¯': '3545', 'ç¾©éš†': '2458', 'ç››ç¾¤': '6202',
      'å‡Œé™½': '2401', 'æ¾ç¿°': '5471', 'æ–°å”': '4919',
      'ä¹é½Š': '5765', 'ç¬™æ³‰': '3122', 'è‡´æ–°': '8081',
      'èŒ‚é”': '6138', 'é¡æ¯”ç§‘': '3438', 'ç«‹éŒ¡': '6286',
      'é€šå˜‰': '3588', 'å‰è©®é›»': '2436', 'æ²›äº¨': '6291',
      'åŸç›¸': '3227', 'æ˜‡ä½³': '6732', 'å¥•åŠ›': '3598',
      'æ™¶ç›¸å…‰': '3530', 'æ™®èª ': '4977', 'ä¹æš˜': '3780',
      'é©Šè¨Š': '6237', 'é‘«å‰µ': '3259', 'å¨ç››': '2388',
      
      // ===== åŠå°é«” - å°æ¸¬ =====
      'åŠ›æˆ': '6239', 'äº¬å…ƒé›»å­': '2449', 'äº¬å…ƒé›»': '2449',
      'çŸ½æ ¼': '6257', 'é é‚¦': '6147', 'è¶…è±': '2441',
      'è±ç”Ÿ': '2369', 'å—èŒ‚': '8150', 'è¯æ±': '8110',
      'æ¬£éŠ“': '3264', 'ç²¾æ': '3374', 'åŒæ¬£é›»': '6271',
      'ä¹…å…ƒ': '6261', 'æ·æ•': '6525',
      
      // ===== åŠå°é«” - è¨­å‚™/ææ–™ =====
      'å¼˜å¡‘': '3131', 'è¾›è€˜': '3583', 'å®¶ç™»': '3680',
      'æ¼¢å”': '2404', 'å¸†å®£': '6196', 'äº¬é¼': '3413',
      'è¬æ½¤': '6187', 'ç¿”å': '8091', 'æ¿¾èƒ½': '6823',
      'é–åº·': '3587', 'æ±éŠ“': '6830', 'å´‡è¶Š': '5765',
      'ä¸­ç ‚': '1560', 'å…‰æ´‹ç§‘': '1785', 'é•·èˆˆ': '1717',
      'å‹ä¸€': '1773', 'æ˜‡é™½åŠ': '8028', 'å°ç‡¿': '6274',
      'é”èˆˆææ–™': '5765', 'è¯ç«‹': '3010',
      
      // ===== åŠå°é«” - æ¸¬è©¦ =====
      'ç²¾æ¸¬': '6510', 'é›æ™º': '6861', 'ç©å´´': '6515',
      'æ—ºçŸ½': '6223', 'ä¸­è¯ç²¾æ¸¬': '6510',
      
      // ===== é›»å­ - ä»£å·¥ =====
      'å»£é”': '2382', 'ä»å¯¶': '2324', 'ç·¯å‰µ': '3231',
      'è‹±æ¥­é”': '2356', 'å’Œç¢©': '4938', 'è¯ç¢©': '2357',
      'å®ç¢': '2353', 'å¾®æ˜Ÿ': '2377', 'æŠ€å˜‰': '2376',
      'è—å¤©': '2362', 'å€«é£›': '2364', 'è‡´ä¼¸': '4915',
      'å…‰å¯¶ç§‘': '2301', 'ä½³ä¸–é”': '2352', 'æ˜åŸº': '2352',
      'é´»æº–': '2354', 'å¯æˆ': '2474', 'å˜‰æ¾¤': '3533',
      
      // ===== é›»å­ - é¢æ¿ =====
      'å‹é”': '2409', 'ç¾¤å‰µ': '3481', 'å½©æ™¶': '6116',
      'ç€šå®‡å½©æ™¶': '6116', 'å‡Œå·¨': '8105', 'è¯æ˜ ': '2475',
      
      // ===== é›»å­ - PCB =====
      'æ¬£èˆˆ': '3037', 'æ™¯ç¢©': '3189', 'å—é›»': '8046',
      'è¯é€š': '2313', 'ç‡¿è¯': '2367', 'å¥é¼': '3044',
      'å°å…‰é›»': '2383', 'è¯èŒ‚': '6213', 'é‡‘åƒé›»': '2368',
      'è€€è¯': '2367', 'æ•¬éµ¬': '2355', 'æ¥ æ¢“é›»': '2316',
      'å˜‰è¯ç›Š': '6153', 'è‡»é¼': '4958', 'å¿—è¶…': '8213',
      'å®šç©': '3715', 'åšæ™º': '8155', 'å…ˆè±': '5765',
      'å°ç‡¿': '6274', 'é¨°è¼': '6672', 'æŸæ‰¿': '6141',
      
      // ===== é›»å­ - è¢«å‹•å…ƒä»¶ =====
      'åœ‹å·¨': '2327', 'è¯æ–°ç§‘': '2492', 'ç¦¾ä¼¸å ‚': '3026',
      'å¤§æ¯…': '2478', 'å¥‡åŠ›æ–°': '2456', 'æ—ºè©®': '2437',
      'ä¿¡æ˜Œé›»': '6173', 'å‡±ç¾': '2375', 'éˆºé‚¦': '6449',
      'ç«‹éš†é›»': '2472', 'æ™ºå¯¶': '2375', 'èšé¼': '6224',
      
      // ===== é›»å­ - é€£æ¥å™¨ =====
      'é´»æµ·ç²¾å¯†': '2317', 'æ­£å´´': '2392', 'è‰¯ç¶­': '6290',
      'å®£å¾·': '5765', 'ä¿¡é‚¦': '3023', 'å˜‰åŸº': '5765',
      'ç¦¾æ˜Œ': '6158', 'å‡¡ç”²': '3526', 'æ¹§å¾·': '3546',
      
      // ===== é›»å­ - é€šè¨Š/ç¶²é€š =====
      'æ­£æ–‡': '4906', 'å•Ÿç¢': '6285', 'ä¸­ç£Š': '5388',
      'æ™ºé‚¦': '2345', 'æ˜æ³°': '3380', 'åˆå‹¤': '2391',
      'å‹è¨Š': '2332', 'å…†èµ«': '2485', 'è€€ç™»': '3138',
      'æ˜‡é”ç§‘': '3491', 'è­è£•': '3419', 'å°æš': '2314',
      'äºä¿¡': '3169', 'æ™¶è¨Š': '5765', 'å•Ÿç™¼é›»': '2502',
      'è¨ŠèˆŸ': '3047', 'æ™ºæ˜“': '3596', 'ç¥æº–': '3558',
      'å»ºæ¼¢': '3062', 'ç«‹ç«¯': '6245', 'ç™¾ä¸€': '6152',
      
      // ===== é›»å­ - é›»æº =====
      'å°é”é›»': '2308', 'å…‰å¯¶ç§‘': '2301', 'åº·èˆ’': '6282',
      'å…¨æ¼¢': '3015', 'ç¾¤é›»': '6412', 'é£›å®': '2457',
      'æ–°å·¨': '2420', 'åƒ‘å¨': '3078', 'æ˜ç·¯': '8937',
      'åšå¤§': '8109', 'å¥ç­–': '3653', 'åŠ›è‡´': '3447',
      
      // ===== é›»å­ - å…‰å­¸ =====
      'å¤§ç«‹å…‰': '3008', 'ç‰æ™¶å…‰': '3406', 'äºå…‰': '3019',
      'ä»Šåœ‹å…‰': '6209', 'å…ˆé€²å…‰': '3362', 'ä½³å‡Œ': '4976',
      'æ–°é‰…ç§‘': '3630', 'æšæ˜å…‰': '3504', 'è¯ä¸€å…‰': '3441',
      
      // ===== é›»å­ - LED =====
      'å„„å…‰': '2393', 'æ™¶é›»': '2448', 'ç’¨åœ“': '3061',
      'éš†é”': '3698', 'å®é½Š': '6168', 'æ¦®å‰µ': '3036',
      'è‰¾ç¬›æ£®': '3591', 'è¯ä¸Š': '6289', 'æ³°è°·': '3545',
      
      // ===== AI / ä¼ºæœå™¨ =====
      'ç·¯ç©': '6669', 'å·æ¹–': '2059', 'å‹¤èª ': '8210',
      'å¥‡é‹': '3017', 'é›™é´»': '3324', 'è¶…çœ¾': '6230',
      'ä¿¡é©Š': '5274', 'ç¥åŸº': '3005', 'ç ”è¯': '2395',
      'æ¨ºæ¼¢': '6414', 'å®‰å‹¤': '3479', 'æŒ¯æ¨ºé›»': '8114',
      'å»£ç©': '8050', 'é£›æ·': '6206', 'è‰¾è¨Š': '3088',
      'å‡Œè¯': '6166', 'ç ”æš': '2463', 'ç‡Ÿé‚¦': '3559',
      'å‰µæ–°': '5765', 'ç«‹ç«¯': '6245', 'è‹±æ¥­é”': '2356',
      'æŠ€é¼': '6263', 'å…¶é™½': '3338', 'æ³“æ ¼': '3577',
      
      // ===== é›»å­ - é€šè·¯ =====
      'å¤§è¯å¤§': '3702', 'æ–‡æ›„': '3036', 'è‡³ä¸Š': '8112',
      'å¢ä½ å¼·': '3078', 'è¯å¼·': '2347', 'è©®æ¬£': '6205',
      'ç›Šç™»': '3048', 'å¨å¥': '3033', 'å´‡è¶Šé›»': '3388',
      'å°šç«‹': '3390', 'å…‰è–': '6442', 'å”é‹’': '4610',
      
      // ===== é›»å­ - è»Ÿé«”/SI =====
      'ç²¾èª ': '6214', 'å®ç¢è³‡è¨Š': '6811', 'é›¶å£¹': '3029',
      'æ•¦é™½ç§‘': '2480', 'è³‡é€š': '2471', 'ä¸­è²': '5765',
      'å¡æš': '6752', 'äº’å‹•': '6486', 'é¼æ–°': '5765',
      'ä¼Šé›²è°·': '6689', 'ç¶²å®¶': '8044', 'å¯Œé‚¦åª’': '8454',
      'æ•¸å­—': '5765', 'æ˜•åŠ›': '6851', 'é—œè²¿': '6183',
      'ä¾†æ¯…': '5765', 'åšå¼ˆ': '3625', 'è¨Šé€£': '5765',
      
      // ===== å‚³ç”¢ - èˆªé‹ =====
      'é•·æ¦®': '2603', 'é™½æ˜': '2609', 'è¬æµ·': '2615',
      'é•·æ¦®èˆª': '2618', 'è¯èˆª': '2610', 'æ˜Ÿå®‡': '2646',
      'å°é©ŠæŠ•æ§': '2636', 'æ…§æ´‹': '2637', 'è£•æ°‘': '2606',
      'æ–°èˆˆ': '2605', 'å››ç¶­èˆª': '5765', 'ä¸­èˆª': '2612',
      'å°èˆª': '2617', 'å»ºæ–°': '2622', 'æ±æ£®': '5765',
      'å˜‰é‡Œå¤§æ¦®': '2608', 'å®…é…é€š': '2642', 'ä¸­ä¿ç§‘': '9917',
      
      // ===== å‚³ç”¢ - æ±½è»Š =====
      'å’Œæ³°è»Š': '2207', 'è£•éš†': '2201', 'è£•æ—¥è»Š': '2227',
      'ä¸­è¯æ±½è»Š': '2204', 'ä¸‰é™½å·¥æ¥­': '2206', 'å…‰é™½': '5765',
      'æ±é™½': '1319', 'å¸å¯¶': '6605', 'å ¤ç¶­è¥¿': '1522',
      'ç‚ºå‡': '2231', 'çš‡ç”°': '9951', 'æ°¸å½°': '4523',
      'æ™ºä¼¸ç§‘': '4551', 'åŠéºŸ': '2228', 'å’Œå¤§': '1536',
      'åŒè‡´': '3552', 'æœ‹ç¨‹': '8255', 'èƒ¡é€£': '6279',
      
      // ===== å‚³ç”¢ - ç´¡ç¹” =====
      'é æ±æ–°': '1402', 'æ–°çº–': '1409', 'åŠ›éº—': '1444',
      'å°åŒ–çº–': '1326', 'å„’é´»': '1476', 'èšé™½': '1477',
      'å»£è¶Š': '4438', 'éŠ˜æ—ºå¯¦': '4432', 'å¾—åŠ›': '1464',
      'å¹´èˆˆ': '1451', 'å®é ': '1460', 'å—ç´¡': '1440',
      'åˆ©å‹¤': '4426', 'å…‰æ˜': '4420', 'æ±éš†èˆˆ': '4401',
      
      // ===== å‚³ç”¢ - å¡‘åŒ– =====
      'å°å¡‘': '1301', 'å—äº': '1303', 'å°åŒ–': '1326',
      'å°å¡‘åŒ–': '6505', 'å°èš': '1304', 'è¯å¤': '1305',
      'äºèš': '1308', 'åœ‹å–¬': '1312', 'è¯æˆ': '1313',
      'ä¸­çŸ³åŒ–': '1314', 'æ±è¯': '1710', 'æ¦®åŒ–': '1704',
      'å’Œæ¡': '1714', 'æ°¸å…‰': '1711', 'ä¸‰èŠ³': '1307',
      
      // ===== å‚³ç”¢ - é£Ÿå“ =====
      'çµ±ä¸€': '1216', 'å‘³å…¨': '1201', 'å¤§æˆ': '1210',
      'åœèœ‚': '1215', 'æ³°å±±': '1218', 'æ„›ä¹‹å‘³': '1217',
      'ç¦æ‡‹æ²¹': '1225', 'è¯è¯': '1229', 'å¤©ä»': '1233',
      'é»‘æ¾': '1234', 'ç¦å£½': '1219', 'å—åƒ‘': '1702',
      'ä½³æ ¼': '1227', 'å®äº': '1236', 'é®®æ´»æœæ±': '1256',
      'å¤§çµ±ç›Š': '1232', 'è‘¡è„ç‹': '1707', 'ç¾é£Ÿé”äºº': '2723',
      
      // ===== å‚³ç”¢ - é‹¼éµ =====
      'ä¸­é‹¼': '2002', 'ä¸­é´»': '2014', 'æ±é‹¼': '2006',
      'å¤§æˆé‹¼': '2027', 'æ¦®å‰›': '5009', 'åƒé™„': '8383',
      'å¨è‡´': '2028', 'æ–°å…‰é‹¼': '2031', 'ç‡è¼': '2023',
      'è±èˆˆ': '2015', 'æ˜¥æº': '2010', 'æµ·å…‰': '2038',
      'å®˜ç”°é‹¼': '2017', 'ç››é¤˜': '2029', 'èšäº¨': '2022',
      
      // ===== å‚³ç”¢ - æ°´æ³¥ =====
      'å°æ³¥': '1101', 'äºæ³¥': '1102', 'å˜‰æ³¥': '1103',
      'ä¿¡å¤§': '1109', 'ç’°æ³¥': '1104', 'å¹¸ç¦': '1108',
      
      // ===== å‚³ç”¢ - é›»æ©Ÿ =====
      'æ±å…ƒ': '1504', 'å¤§åŒ': '2371', 'å£«é›»': '1503',
      'è¯åŸ': '1519', 'ä¸­èˆˆé›»': '1513', 'äºåŠ›': '1514',
      'å¤§äº': '1609', 'è¯é›»': '1603', 'å¤§å±±': '1615',
      'å±±éš†': '2616', 'æ­£é“': '1519', 'æ°¸å¤§': '1507',
      'ä¸­é›»': '1611', 'æ’è€€': '8349', 'åº·é‚£é¦™': '9919',
      
      // ===== å‚³ç”¢ - ç‡Ÿå»º =====
      'èˆˆå¯Œç™¼': '2542', 'è¯å›º': '2548', 'é•·è™¹': '5534',
      'æ½¤æ³°æ–°': '9945', 'é é›„': '5522', 'åœ‹å»º': '2501',
      'å† å¾·': '2520', 'çš‡ç¿”': '2545', 'é”éº—': '6177',
      'å®ç’Ÿ': '2527', 'æ«»èŠ±å»º': '2539', 'å®æ™®': '2536',
      'å¤ªå­': '2511', 'è¯å»º': '2530', 'æ—¥å‹ç”Ÿ': '2547',
      'é„‰æ—': '5765', 'åŸºæ³°': '2538', 'çš‡æ™®': '2528',
      'å¤§è¯å»º': '2530', 'é¾é‚¦': '2514', 'å—æ¸¯': '2101',
      
      // ===== å‚³ç”¢ - è§€å…‰ =====
      'æ™¶è¯': '2707', 'é›„ç…': '2731', 'ç‹å“': '2727',
      'ç“¦åŸ': '2729', 'å…­è§’': '2732', 'ç¾é£Ÿé”äºº': '2723',
      'é³³å‡°': '5765', 'å±±å¯Œ': '2743', 'äº”ç¦': '2745',
      'æ˜“éŠç¶²': '5765', 'å¯’èˆ': '2739', 'æ¼¢ä¾†ç¾é£Ÿ': '1268',
      'è±†åºœ': '2752', 'å…«æ–¹é›²é›†': '2753', 'äºæ´²è—å£½å¸': '2754',
      'è·¯æ˜“è': '2758', 'éº¥å‘³ç™»': '2742', 'é¥—è³“': '2742',
      
      // ===== å‚³ç”¢ - é›¶å”® =====
      'çµ±ä¸€è¶…': '2912', 'å…¨å®¶': '5903', 'å¯¶é›…': '5904',
      'ä¸‰å•†å®¶è³¼': '2945', 'èª å“ç”Ÿæ´»': '2926', 'ç‰¹åŠ›': '2908',
      'æ½¤æ³°å…¨': '2915', 'ç‡¦å¤': '2430', 'å¤§æ½¤ç™¼': '5765',
      'å…¨è¯': '5765', 'å¥½å¸‚å¤š': '5765', 'å®¶æ¨‚ç¦': '5765',
      'ç¾å»‰ç¤¾': '5765', 'é ç™¾': '2903', 'æ–°å…‰ä¸‰è¶Š': '2888',
      
      // ===== å‚³ç”¢ - é›»ä¿¡ =====
      'ä¸­è¯é›»': '2412', 'é å‚³': '4904', 'å°ç£å¤§': '3045',
      'äºå¤ªé›»': '3682', 'å°å›ºåª’': '3045', 'å°ç£ä¹‹æ˜Ÿ': '5765',
      
      // ===== å‚³ç”¢ - è¼ªèƒ =====
      'æ­£æ–°': '2105', 'å»ºå¤§': '2106', 'å—æ¸¯è¼ªèƒ': '2101',
      'æ³°è±': '2102', 'è¯è±': '2109', 'åšç”Ÿ': '2107',
      
      // ===== å‚³ç”¢ - è£½é‹/é‹å‹• =====
      'è±æ³°': '9910', 'å¯¶æˆ': '9904', 'éˆºé½Š': '9802',
      'ç™¾å’Œ': '9938', 'é¿éˆ¦': '4163', 'å¿—å¼·': '5765',
      'å·¨å¤§': '9921', 'ç¾åˆ©é”': '9914', 'æ„›åœ°é›…': '8933',
      
      // ===== å‚³ç”¢ - ç»ç’ƒ/é™¶ç“· =====
      'å°ç»': '1802', 'è¯æ–°': '1605', 'å† è»': '1806',
      
      // ===== å‚³ç”¢ - é€ ç´™ =====
      'æ°¸è±é¤˜': '1907', 'æ­£éš†': '1904', 'æ¦®æˆ': '1909',
      'è¯ç´™': '1905', 'å£«ç´™': '1903', 'å¯¶éš†': '1906',
      
      // ===== ç”ŸæŠ€é†«ç™‚ =====
      'ä¿ç‘': '6472', 'å¤§æ±Ÿ': '8436', 'ç¾æ™‚': '1795',
      'ä¸­è£•': '4147', 'è—¥è¯è—¥': '6446', 'åˆä¸€': '4743',
      'æ™Ÿå¾·': '4123', 'æ±æ´‹': '4105', 'æè¼': '1734',
      'ä½³é†«': '4104', 'å¤§æ¨¹': '6469', 'æä¸€': '4175',
      'ç²¾è¯': '1565', 'æ˜åŸºé†«': '4116', 'é‚¦ç‰¹': '4107',
      'æ°¸ä¿¡': '3705', 'ç”Ÿé”': '1720', 'ä¸­åŒ–': '1701',
      'å°è€€': '4746', 'å¥å–¬': '4114', 'å‹è¯': '4120',
      'äº”é¼': '1733', 'æåœ‹': '4192', 'æµ©é¼': '4174',
      'åŸºäº': '3176', 'é€¸é”': '6576', 'æ™ºæ“': '4162',
      'å¤ªæ™¯': '4157', 'åŒ—æ¥µæ˜Ÿè—¥æ¥­': '6550', 'å¿ƒæ‚…': '6575',
      'æ³°ç¦': '6541', 'å› è¯': '4172', 'æ³°ç·¯': '6528',
      'åœ‹å…‰ç”Ÿ': '4142', 'é«˜ç«¯': '6547', 'è¯äºè—¥': '6562',
      'åº·å‹': '6452', 'æ‰¿æ¥­é†«': '4164', 'é†£è¯': '4168',
      
      // ===== é‡‘èç§Ÿè³ƒ =====
      'è£•è': '9941', 'ä¸­ç§Ÿ': '5871', 'å’Œæ½¤': '6592',
      'è£•å¯Œ': '5765', 'è£•åœ‹': '5765', 'ä»²ä¿¡': '5765',
      
      // ===== ETF - å¸‚å€¼å‹ =====
      'å…ƒå¤§50': '0050', '0050': '0050', 'å°ç£50': '0050',
      'å¯Œé‚¦å°50': '006208', '006208': '006208',
      'å…ƒå¤§ä¸­å‹100': '0051', '0051': '0051',
      'æ°¸è±å°ç£åŠ æ¬Š': '006204', '006204': '006204',
      'å…ƒå¤§MSCIå°ç£': '006203', '006203': '006203',
      'å¯Œé‚¦æ‘©å°': '0057', '0057': '0057',
      'å…ƒå¤§å°ç£ESGæ°¸çºŒ': '00850', '00850': '00850', 'ESG': '00850',
      'æ°¸è±å°ç£ESG': '00888', '00888': '00888',
      'åœ‹æ³°å°ç£é ˜è¢–50': '00922', '00922': '00922',
      
      // ===== ETF - é«˜è‚¡æ¯ =====
      'å…ƒå¤§é«˜è‚¡æ¯': '0056', '0056': '0056', 'é«˜è‚¡æ¯': '0056',
      'åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯': '00878', '00878': '00878', 'æ°¸çºŒé«˜è‚¡æ¯': '00878',
      'å¾©è¯å°ç£ç§‘æŠ€å„ªæ¯': '00929', '00929': '00929', 'ç§‘æŠ€å„ªæ¯': '00929',
      'å…ƒå¤§å°ç£åƒ¹å€¼é«˜æ¯': '00940', '00940': '00940', 'åƒ¹å€¼é«˜æ¯': '00940',
      'çµ±ä¸€å°ç£é«˜æ¯å‹•èƒ½': '00939', '00939': '00939', 'é«˜æ¯å‹•èƒ½': '00939',
      'ç¾¤ç›Šå°ç£ç²¾é¸é«˜æ¯': '00919', '00919': '00919', 'ç²¾é¸é«˜æ¯': '00919',
      'å¯Œé‚¦ç‰¹é¸é«˜è‚¡æ¯': '00900', '00900': '00900',
      'åœ‹æ³°è‚¡åˆ©ç²¾é¸30': '00701', '00701': '00701',
      'å…ƒå¤§å„ªæ¯': '00932', '00932': '00932',
      'å‡±åŸºå„ªé¸é«˜è‚¡æ¯': '00915', '00915': '00915',
      'ä¸­ä¿¡æˆé•·é«˜è‚¡æ¯': '00934', '00934': '00934',
      'å°æ–°è‡ºç£æ°¸çºŒé«˜æ¯': '00936', '00936': '00936',
      'é‡æ‘è‡ºç£æ–°ç§‘æŠ€50': '00935', '00935': '00935',
      'å¤§è¯å„ªåˆ©é«˜å¡«æ¯': '00918', '00918': '00918',
      'FHå¯Œæ™‚é«˜æ¯ä½æ³¢': '00731', '00731': '00731',
      
      // ===== ETF - ç§‘æŠ€ =====
      'åœ‹æ³°è²»åŸåŠå°é«”': '00830', '00830': '00830', 'è²»åŠ': '00830',
      'å¯Œé‚¦ç§‘æŠ€': '0052', '0052': '0052',
      'å…ƒå¤§é›»å­': '0053', '0053': '0053',
      'å¯Œé‚¦NASDAQ': '00662', '00662': '00662', 'NASDAQ': '00662',
      'åœ‹æ³°ç¶²è·¯è³‡å®‰': '00875', '00875': '00875',
      'çµ±ä¸€FANG+': '00757', '00757': '00757', 'FANG': '00757',
      'ä¸­ä¿¡é—œéµåŠå°é«”': '00891', '00891': '00891',
      'å¯Œé‚¦å°ç£åŠå°é«”': '00892', '00892': '00892',
      'æ–°å…‰è‡ºç£åŠå°é«”': '00904', '00904': '00904',
      'ä¸­ä¿¡é›»æ± åŠå„²èƒ½': '00902', '00902': '00902',
      'åœ‹æ³°æ™ºèƒ½é›»å‹•è»Š': '00893', '00893': '00893',
      'å¯Œé‚¦æœªä¾†è»Š': '00895', '00895': '00895',
      'ä¸­ä¿¡ç¶ èƒ½åŠé›»å‹•è»Š': '00896', '00896': '00896',
      
      // ===== ETF - ç¾è‚¡ =====
      'å…ƒå¤§S&P500': '00646', '00646': '00646', 'S&P500': '00646', 'SPY': '00646',
      'åœ‹æ³°é“ç“Š': '00668', '00668': '00668',
      'å¯Œé‚¦NASDAQ': '00662', 'QQQ': '00662',
      'å…ƒå¤§S&PåŸæ²¹æ­£2': '00672L', '00672L': '00672L',
      'å…ƒå¤§æ¨™æ™®500': '00646',
      'æ°¸è±ç¾åœ‹500å¤§': '00858', '00858': '00858',
      'åœ‹æ³°æ¨™æ™®500': '00864', '00864': '00864',
      
      // ===== ETF - æ—¥æœ¬ =====
      'åœ‹æ³°æ—¥ç¶“225': '00657', '00657': '00657', 'æ—¥ç¶“': '00657',
      'å¯Œé‚¦æ—¥æœ¬': '00645', '00645': '00645',
      'å…ƒå¤§æ—¥ç¶“225': '00661', '00661': '00661',
      
      // ===== ETF - ä¸­åœ‹ =====
      'å…ƒå¤§å¯¶æ»¬æ·±': '0061', '0061': '0061',
      'å¯Œé‚¦ä¸Šè­‰': '006205', '006205': '006205',
      'å…ƒå¤§æ»¬æ·±300': '0060', '0060': '0060',
      'ä¸­ä¿¡ä¸­åœ‹é«˜è‚¡æ¯': '00882', '00882': '00882', 'ä¸­åœ‹é«˜è‚¡æ¯': '00882',
      'å¾©è¯ä¸­åœ‹5G': '00877', '00877': '00877',
      'åœ‹æ³°ä¸­åœ‹A50': '00636', '00636': '00636',
      
      // ===== ETF - æ–°èˆˆå¸‚å ´ =====
      'å¯Œé‚¦è¶Šå—': '00885', '00885': '00885', 'è¶Šå—': '00885',
      'ä¸­ä¿¡è¶Šå—æ©Ÿæœƒ': '00894', '00894': '00894',
      'åœ‹æ³°æ–°èˆˆå¸‚å ´': '00736', '00736': '00736',
      'å¯Œé‚¦å°åº¦': '00652', '00652': '00652', 'å°åº¦': '00652',
      
      // ===== ETF - å‚µåˆ¸ =====
      'å…ƒå¤§ç¾å‚µ20å¹´': '00679B', '00679B': '00679B', 'ç¾å‚µ20': '00679B',
      'åœ‹æ³°20å¹´ç¾å‚µ': '00687B', '00687B': '00687B',
      'å…ƒå¤§æŠ•è³‡ç´šå…¬å¸å‚µ': '00720B', '00720B': '00720B',
      'å…ƒå¤§AAAè‡³Aå…¬å¸å‚µ': '00751B', '00751B': '00751B',
      'åœ‹æ³°æŠ•è³‡ç´šå…¬å¸å‚µ': '00725B', '00725B': '00725B',
      'å¯Œé‚¦ç¾å‚µ7-10': '00695B', '00695B': '00695B',
      'å…ƒå¤§ç¾å‚µ7-10': '00697B', '00697B': '00697B',
      'åœ‹æ³°Aç´šå…¬å¸å‚µ': '00761B', '00761B': '00761B',
      
      // ===== ETF - æ§“æ¡¿/åå‘ =====
      'å…ƒå¤§å°ç£50æ­£2': '00631L', '00631L': '00631L', 'å°ç£50æ­£2': '00631L',
      'å…ƒå¤§å°ç£50å1': '00632R', '00632R': '00632R', 'å°ç£50å1': '00632R',
      'å¯Œé‚¦å°ç£åŠ æ¬Šæ­£2': '00675L', '00675L': '00675L',
      'å¯Œé‚¦å°ç£åŠ æ¬Šå1': '00676R', '00676R': '00676R',
      'åœ‹æ³°è‡ºç£åŠ æ¬Šæ­£2': '00663L', '00663L': '00663L',
      'åœ‹æ³°è‡ºç£åŠ æ¬Šå1': '00664R', '00664R': '00664R',
      
      // ===== å…¶ä»– =====
      'å°ç©ADR': '2330', 'è¯é›»ADR': '2303',
      'å°ç£å¤§ç›¤': 't00', 'åŠ æ¬ŠæŒ‡æ•¸': 't00', 'TAIEX': 't00'
    };
    
    // å˜—è©¦åŒ¹é…
    for (const [name, id] of Object.entries(stockMap)) {
      if (name.includes(keyword) || keyword.includes(name)) {
        // æ‰¾åˆ°åŒ¹é…ï¼Œç›´æ¥æŸ¥è©¢
        return await getStockInfoReply(id);
      }
    }
    
    return { 
      type: 'text', 
      text: `ğŸ” æ‰¾ä¸åˆ°ã€Œ${keyword}ã€\n\nğŸ’¡ è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼\nå¦‚ï¼š2330ã€0050` 
    };
    
  } catch (error) {
    console.error('æœå°‹è‚¡ç¥¨éŒ¯èª¤:', error);
    return { type: 'text', text: 'âš ï¸ æœå°‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦' };
  }
}

/**
 * å–å¾—ç†±é–€è‚¡ç¥¨
 */
async function getHotStocksReply() {
  try {
    const hotStocks = [
      { id: '2330', name: 'å°ç©é›»' },
      { id: '2317', name: 'é´»æµ·' },
      { id: '2454', name: 'è¯ç™¼ç§‘' },
      { id: '0050', name: 'å…ƒå¤§50' },
      { id: '0056', name: 'å…ƒå¤§é«˜è‚¡æ¯' },
      { id: '00878', name: 'åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯' },
      { id: '2882', name: 'åœ‹æ³°é‡‘' },
      { id: '2881', name: 'å¯Œé‚¦é‡‘' }
    ];
    
    let info = `ğŸ”¥ ç†±é–€è‚¡ç¥¨\n`;
    info += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    
    for (const stock of hotStocks) {
      const data = await stockService.getRealtimePrice(stock.id);
      if (data) {
        const up = data.change >= 0;
        info += `${stock.name}ï¼ˆ${stock.id}ï¼‰\n`;
        info += `  ğŸ’° ${data.price}ï¼ˆ${up ? 'ğŸ“ˆ+' : 'ğŸ“‰'}${data.changePercent}%ï¼‰\n`;
      }
    }
    
    info += `\nğŸ’¡ è¼¸å…¥ä»£ç¢¼æŸ¥çœ‹è©³æƒ…`;
    
    return { type: 'text', text: info };
    
  } catch (error) {
    console.error('å–å¾—ç†±é–€è‚¡ç¥¨éŒ¯èª¤:', error);
    return { type: 'text', text: 'âš ï¸ å–å¾—ç†±é–€è‚¡ç¥¨å¤±æ•—' };
  }
}

/**
 * ğŸ”Š ç™¼é€èªéŸ³æ’­å ±ï¼ˆæœ‰é˜²é‡æ©Ÿåˆ¶ï¼‰
 */
// èªéŸ³è«‹æ±‚é˜²é‡
const voiceRequests = new Map();
const VOICE_COOLDOWN = 60000; // 60 ç§’å…§ä¸é‡è¤‡ç™¼é€åŒä¸€è‚¡ç¥¨

async function sendVoiceReport(stockId, userId) {
  // ğŸ›¡ï¸ é˜²é‡æª¢æŸ¥
  const requestKey = `voice_${userId}_${stockId}`;
  const lastRequest = voiceRequests.get(requestKey);
  const now = Date.now();
  
  if (lastRequest && (now - lastRequest) < VOICE_COOLDOWN) {
    console.log(`â­ï¸ èªéŸ³å†·å»ä¸­: ${stockId}`);
    return null; // å†·å»ä¸­ï¼Œä¸å›æ‡‰
  }
  
  // è¨˜éŒ„è«‹æ±‚æ™‚é–“
  voiceRequests.set(requestKey, now);
  
  // æ¸…ç†éæœŸçš„è«‹æ±‚è¨˜éŒ„
  for (const [key, time] of voiceRequests) {
    if (now - time > VOICE_COOLDOWN * 2) {
      voiceRequests.delete(key);
    }
  }

  try {
    const voiceService = require('../services/voiceService');
    const stockData = await stockService.getRealtimePrice(stockId);
    
    if (!stockData) {
      return { type: 'text', text: `âŒ æ‰¾ä¸åˆ°è‚¡ç¥¨ ${stockId}` };
    }
    
    // æª¢æŸ¥èªéŸ³æ˜¯å¦å•Ÿç”¨
    const settings = await voiceService.getVoiceSettings();
    
    if (!settings.enabled) {
      // èªéŸ³æœªå•Ÿç”¨ï¼Œç™¼é€æ–‡å­—
      const isUp = stockData.change >= 0;
      return { 
        type: 'text', 
        text: `ğŸ”Š ${stockData.name}ï¼ˆ${stockId}ï¼‰\n` +
          `ç¾åƒ¹ï¼š${stockData.price} å…ƒ\n` +
          `æ¼²è·Œï¼š${isUp ? '+' : ''}${stockData.change}ï¼ˆ${stockData.changePercent}%ï¼‰\n\n` +
          `ğŸ’¡ èªéŸ³æ’­å ±æœªå•Ÿç”¨ï¼Œè«‹è‡³ç¶²é è¨­å®šé–‹å•Ÿ`
      };
    }
    
    console.log(`ğŸ”Š ç™¼é€èªéŸ³: ${stockData.name}`);
    
    // ç™¼é€èªéŸ³ï¼ˆåŒæ­¥ç­‰å¾…ï¼‰
    const success = await lineService.sendStockVoiceAlert(userId, stockData, voiceService);
    
    if (!success) {
      return { type: 'text', text: `âš ï¸ èªéŸ³ç”Ÿæˆå¤±æ•—` };
    }
    
    // èªéŸ³å·²ç™¼é€ï¼Œä¸éœ€è¦é¡å¤–å›æ‡‰
    return null;
    
  } catch (error) {
    console.error('èªéŸ³æ’­å ±éŒ¯èª¤:', error);
    return { type: 'text', text: 'âš ï¸ èªéŸ³æ’­å ±å¤±æ•—' };
  }
}

/**
 * å–å¾—èªªæ˜å›è¦†
 */
function getHelpReply() {
  const help = `ğŸ“± è‚¡æµ·ç§˜æ›¸æŒ‡ä»¤èªªæ˜\n` +
    `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
    `ğŸ” æŸ¥è©¢è‚¡åƒ¹\n` +
    `   2330ï¼ˆè¼¸å…¥ä»£ç¢¼ï¼‰\n` +
    `   æŸ¥ å°ç©é›»ï¼ˆæœåç¨±ï¼‰\n\n` +
    `ğŸ“ˆ å¤§ç›¤/ç†±é–€\n` +
    `   ã€Œå¤§ç›¤ã€çœ‹åŠ æ¬ŠæŒ‡æ•¸\n` +
    `   ã€Œç†±é–€ã€çœ‹ç†±é–€è‚¡\n\n` +
    `â• ç›£æ§ç®¡ç†\n` +
    `   +2330ï¼ˆåŠ å…¥ç›£æ§ï¼‰\n` +
    `   -2330ï¼ˆç§»é™¤ç›£æ§ï¼‰\n` +
    `   ã€Œç›£æ§ã€çœ‹æ¸…å–®\n\n` +
    `ğŸ”Š èªéŸ³æ’­å ±\n` +
    `   èªéŸ³ 2330\n\n` +
    `ğŸ’¼ã€ŒæŒè‚¡ã€çœ‹æŒè‚¡\n` +
    `â“ã€Œèªªæ˜ã€é¡¯ç¤ºæ­¤è¨Šæ¯`;

  return { type: 'text', text: help };
}

/**
 * å„²å­˜ LINE User ID
 */
async function saveLineUserId(userId) {
  const sql = `
    INSERT INTO settings (key, value) 
    VALUES ('line_user_id', $1)
    ON CONFLICT (key) DO UPDATE SET value = $1
  `;
  
  try {
    await pool.query(sql, [userId]);
  } catch (error) {
    console.error('å„²å­˜ User ID å¤±æ•—:', error.message);
  }
}

/**
 * POST /api/line/push
 * æ‰‹å‹•æ¨æ’­æ¸¬è©¦
 */
router.post('/push', async (req, res) => {
  try {
    const { message } = req.body;
    
    // å–å¾— User ID
    const result = await pool.query(
      "SELECT value FROM settings WHERE key = 'line_user_id'"
    );
    const userId = result.rows[0]?.value || process.env.LINE_USER_ID;
    
    if (!userId) {
      return res.status(400).json({ error: 'å°šæœªè¨­å®š LINE User ID' });
    }
    
    const success = await lineService.sendFlexMessage(userId, {
      type: 'text',
      text: message || 'ğŸ‰ æ¸¬è©¦æ¨æ’­æˆåŠŸï¼'
    });
    
    res.json({ success });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

module.exports = router;
