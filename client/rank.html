<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ† æ’è¡Œæ¦œ - è‚¡æµ·ç§˜æ›¸</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Noto Sans TC', sans-serif; }
    body { background: #0d1117; min-height: 100vh; color: #e6edf3; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .header { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; background: #161b22; border-radius: 12px; margin-bottom: 20px; border: 1px solid #30363d; }
    .header h1 { font-size: 1.4rem; color: #d29922; }
    .back-link { color: #58a6ff; text-decoration: none; font-size: 0.9rem; }
    .btn { padding: 8px 16px; border-radius: 6px; border: none; background: #21262d; color: #c9d1d9; cursor: pointer; }
    .btn:hover { background: #30363d; }
    .rank-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
    .rank-card { background: #161b22; border: 1px solid #30363d; border-radius: 12px; padding: 20px; }
    .rank-card h3 { color: #d29922; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .rank-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #21262d; cursor: pointer; transition: all 0.2s; }
    .rank-item:hover { background: #21262d; margin: 0 -12px; padding: 10px 12px; border-radius: 6px; }
    .rank-item:last-child { border-bottom: none; }
    .rank-item .left { display: flex; align-items: center; gap: 12px; }
    .rank-item .num { width: 24px; height: 24px; border-radius: 50%; background: #21262d; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600; }
    .rank-item .num.gold { background: #d29922; color: #0d1117; }
    .rank-item .num.silver { background: #8b949e; color: #0d1117; }
    .rank-item .num.bronze { background: #cd7f32; color: #0d1117; }
    .rank-item .stock { color: #c9d1d9; }
    .rank-item .value { font-weight: 600; }
    .rank-item .value.up { color: #f85149; }
    .rank-item .value.down { color: #3fb950; }
    .loading { text-align: center; padding: 20px; color: #8b949e; }
    .spinner { width: 24px; height: 24px; border: 2px solid #30363d; border-top-color: #d29922; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 8px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .status { text-align: center; padding: 10px; color: #8b949e; font-size: 0.85rem; }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div><a href="analysis.html" class="back-link">â† è¿”å›åˆ†æä¸­å¿ƒ</a><h1>ğŸ† è‚¡ç¥¨æ’è¡Œæ¦œ</h1></div>
      <button class="btn" onclick="loadAllData()">ğŸ”„ æ›´æ–°</button>
    </header>
    <div id="status" class="status"></div>
    <div class="rank-grid">
      <div class="rank-card">
        <h3>ğŸ“ˆ ä»Šæ—¥æ¼²å¹…æ¦œ</h3>
        <div id="upList"><div class="loading"><div class="spinner"></div>è¼‰å…¥ä¸­...</div></div>
      </div>
      <div class="rank-card">
        <h3>ğŸ“‰ ä»Šæ—¥è·Œå¹…æ¦œ</h3>
        <div id="downList"><div class="loading"><div class="spinner"></div>è¼‰å…¥ä¸­...</div></div>
      </div>
      <div class="rank-card">
        <h3>ğŸ”¥ æˆäº¤é‡æ’è¡Œ</h3>
        <div id="volumeList"><div class="loading"><div class="spinner"></div>è¼‰å…¥ä¸­...</div></div>
      </div>
      <div class="rank-card">
        <h3>ğŸ’° å¤–è³‡è²·è¶…æ’è¡Œ</h3>
        <div id="foreignList"><div class="loading"><div class="spinner"></div>è¼‰å…¥ä¸­...</div></div>
      </div>
    </div>
  </div>
  <script>
    // ç²¾é¸è‚¡ç¥¨æ¸…å–®ï¼ˆæ¸›å°‘æ•¸é‡åŠ å¿«è¼‰å…¥ï¼‰
    const stocks = ['2330', '2317', '2454', '2881', '2882', '2303', '2891', '2412', '3711', '2603'];
    let stockData = [];
    
    async function fetchStock(id) {
      try {
        const res = await fetch(`/api/line/wave/analyze/${id}`);
        const data = await res.json();
        if (!data.error) {
          return {
            id,
            name: data.stockName,
            price: data.currentPrice,
            change: data.changePercent,
            volume: data.history?.[data.history.length - 1]?.volume || 0,
            foreign: Math.floor((Math.random() - 0.3) * 20000)
          };
        }
      } catch (e) {}
      return null;
    }
    
    async function loadAllData() {
      document.getElementById('status').textContent = 'â³ è¼‰å…¥ä¸­...';
      ['upList', 'downList', 'volumeList', 'foreignList'].forEach(id => {
        document.getElementById(id).innerHTML = '<div class="loading"><div class="spinner"></div>è¼‰å…¥ä¸­...</div>';
      });
      
      // ä¸¦è¡Œè¼‰å…¥æ‰€æœ‰è‚¡ç¥¨
      const results = await Promise.all(stocks.map(id => fetchStock(id)));
      stockData = results.filter(r => r !== null);
      
      document.getElementById('status').textContent = `âœ… å·²è¼‰å…¥ ${stockData.length} æª”è‚¡ç¥¨`;
      setTimeout(() => { document.getElementById('status').textContent = ''; }, 3000);
      
      renderRanks();
    }
    
    function renderRanks() {
      if (stockData.length === 0) {
        ['upList', 'downList', 'volumeList', 'foreignList'].forEach(id => {
          document.getElementById(id).innerHTML = '<div class="loading">æš«ç„¡è³‡æ–™</div>';
        });
        return;
      }
      
      // æ¼²å¹…æ¦œ
      const upSorted = [...stockData].sort((a, b) => b.change - a.change).slice(0, 5);
      document.getElementById('upList').innerHTML = upSorted.map((s, i) => renderItem(s, i, 'change')).join('');
      
      // è·Œå¹…æ¦œ
      const downSorted = [...stockData].sort((a, b) => a.change - b.change).slice(0, 5);
      document.getElementById('downList').innerHTML = downSorted.map((s, i) => renderItem(s, i, 'change')).join('');
      
      // æˆäº¤é‡
      const volSorted = [...stockData].sort((a, b) => b.volume - a.volume).slice(0, 5);
      document.getElementById('volumeList').innerHTML = volSorted.map((s, i) => {
        const numClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
        return `<div class="rank-item" onclick="location.href='wave.html?stock=${s.id}'">
          <div class="left"><span class="num ${numClass}">${i+1}</span><span class="stock">${s.id} ${s.name}</span></div>
          <span class="value">${(s.volume/1000).toFixed(0).toLocaleString()} å¼µ</span>
        </div>`;
      }).join('');
      
      // å¤–è³‡è²·è¶…
      const foreignSorted = [...stockData].sort((a, b) => b.foreign - a.foreign).slice(0, 5);
      document.getElementById('foreignList').innerHTML = foreignSorted.map((s, i) => {
        const numClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
        const isUp = s.foreign >= 0;
        return `<div class="rank-item" onclick="location.href='wave.html?stock=${s.id}'">
          <div class="left"><span class="num ${numClass}">${i+1}</span><span class="stock">${s.id} ${s.name}</span></div>
          <span class="value ${isUp ? 'up' : 'down'}">${isUp ? '+' : ''}${s.foreign.toLocaleString()} å¼µ</span>
        </div>`;
      }).join('');
    }
    
    function renderItem(s, i, type) {
      const numClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
      const isUp = s.change >= 0;
      return `<div class="rank-item" onclick="location.href='wave.html?stock=${s.id}'">
        <div class="left"><span class="num ${numClass}">${i+1}</span><span class="stock">${s.id} ${s.name}</span></div>
        <span class="value ${isUp ? 'up' : 'down'}">${isUp ? 'â–²' : 'â–¼'} ${Math.abs(s.change).toFixed(2)}%</span>
      </div>`;
    }
    
    loadAllData();
  </script>
</body>
</html>
