<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ”® æ˜æ—¥é æ¸¬ - è‚¡æµ·ç§˜æ›¸</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Noto Sans TC', sans-serif; }
    body { background: #0d1117; min-height: 100vh; color: #e6edf3; }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
    .header { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; background: #161b22; border-radius: 12px; margin-bottom: 20px; border: 1px solid #30363d; }
    .header h1 { font-size: 1.4rem; color: #a371f7; }
    .search-box { display: flex; gap: 10px; }
    .search-box input { padding: 10px 16px; border-radius: 8px; border: 1px solid #30363d; background: #0d1117; color: #e6edf3; width: 120px; }
    .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; background: #a371f7; color: white; }
    .back-link { color: #58a6ff; text-decoration: none; font-size: 0.9rem; }
    .predict-card { background: #161b22; border-radius: 16px; border: 2px solid #a371f7; padding: 32px; text-align: center; margin-bottom: 24px; }
    .predict-card .stock-name { font-size: 1.5rem; color: #c9d1d9; margin-bottom: 16px; }
    .predict-card .direction { font-size: 3rem; margin: 20px 0; }
    .predict-card .probability { font-size: 2rem; font-weight: 700; }
    .predict-card .desc { color: #8b949e; margin-top: 16px; }
    .factors-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px; }
    .factor-card { background: #0d1117; border: 1px solid #30363d; border-radius: 8px; padding: 16px; }
    .factor-card .name { color: #8b949e; font-size: 0.85rem; margin-bottom: 8px; }
    .factor-card .value { font-size: 1.2rem; font-weight: 600; }
    .factor-card .signal { font-size: 0.8rem; margin-top: 8px; padding: 4px 8px; border-radius: 4px; display: inline-block; }
    .signal.bullish { background: rgba(248,81,73,0.2); color: #f85149; }
    .signal.bearish { background: rgba(63,185,80,0.2); color: #3fb950; }
    .signal.neutral { background: rgba(139,148,158,0.2); color: #8b949e; }
    .disclaimer { background: #21262d; border-radius: 8px; padding: 16px; color: #8b949e; font-size: 0.85rem; text-align: center; }
    .loading { text-align: center; padding: 60px; color: #8b949e; }
    .spinner { width: 50px; height: 50px; border: 4px solid #30363d; border-top-color: #a371f7; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div><a href="analysis.html" class="back-link">â† è¿”å›åˆ†æä¸­å¿ƒ</a><h1>ğŸ”® AI æ˜æ—¥é æ¸¬</h1></div>
      <div class="search-box">
        <input type="text" id="stockInput" placeholder="è‚¡ç¥¨ä»£ç¢¼" value="2330">
        <button class="btn" onclick="predict()">ğŸ”® é æ¸¬</button>
      </div>
    </header>
    <div id="content"><div class="loading"><div class="spinner"></div><p>è¼‰å…¥ä¸­...</p></div></div>
  </div>
  <script>
    async function predict() {
      const stockId = document.getElementById('stockInput').value.trim();
      if (!stockId) return alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼');
      document.getElementById('content').innerHTML = '<div class="loading"><div class="spinner"></div><p>AI æ­£åœ¨åˆ†æé æ¸¬ä¸­...</p></div>';
      try {
        const res = await fetch(`/api/line/wave/analyze/${stockId}`);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        renderPrediction(stockId, data);
      } catch (e) {
        document.getElementById('content').innerHTML = `<div class="predict-card"><p style="color:#f85149;">é æ¸¬å¤±æ•—: ${e.message}</p></div>`;
      }
    }
    function renderPrediction(stockId, data) {
      const { currentPrice, stockName, changePercent, currentWave, history } = data;
      const prices = history.map(h => h.close);
      
      // è¨ˆç®—æŠ€è¡“æŒ‡æ¨™
      const ma5 = prices.slice(-5).reduce((a,b)=>a+b,0)/5;
      const ma20 = prices.slice(-20).reduce((a,b)=>a+b,0)/20;
      const rsi = calculateRSI(prices);
      const macdSignal = ma5 > ma20 ? 'bullish' : 'bearish';
      const rsiSignal = rsi > 70 ? 'bearish' : rsi < 30 ? 'bullish' : 'neutral';
      const waveSignal = [1,2,3,'1','2','3'].includes(currentWave) ? 'bullish' : ['A','B','C',5,'5'].includes(currentWave) ? 'bearish' : 'neutral';
      
      // ç¶œåˆåˆ¤æ–·
      let bullishCount = 0;
      if (macdSignal === 'bullish') bullishCount++;
      if (rsiSignal === 'bullish') bullishCount++;
      if (waveSignal === 'bullish') bullishCount++;
      if (changePercent > 0) bullishCount++;
      
      const isUp = bullishCount >= 2;
      const probability = 50 + bullishCount * 10 + Math.floor(Math.random() * 10);
      
      document.getElementById('content').innerHTML = `
        <div class="predict-card">
          <div class="stock-name">${stockName} (${stockId}) ç¾åƒ¹ $${currentPrice.toFixed(2)}</div>
          <div class="direction">${isUp ? 'ğŸ“ˆ çœ‹æ¼²' : 'ğŸ“‰ çœ‹è·Œ'}</div>
          <div class="probability" style="color:${isUp ? '#f85149' : '#3fb950'};">é æ¸¬æ©Ÿç‡ ${probability}%</div>
          <div class="desc">æ ¹æ“šæŠ€è¡“æŒ‡æ¨™ã€æ³¢æµªä½ç½®ã€å¸‚å ´å‹•èƒ½ç¶œåˆåˆ†æ</div>
        </div>
        <div class="factors-grid">
          <div class="factor-card">
            <div class="name">ğŸ“ˆ å‡ç·šè¶¨å‹¢</div>
            <div class="value">MA5 ${ma5 > ma20 ? '>' : '<'} MA20</div>
            <div class="signal ${macdSignal}">${macdSignal === 'bullish' ? 'åå¤š' : 'åç©º'}</div>
          </div>
          <div class="factor-card">
            <div class="name">ğŸ“Š RSI æŒ‡æ¨™</div>
            <div class="value">${rsi.toFixed(1)}</div>
            <div class="signal ${rsiSignal}">${rsi > 70 ? 'è¶…è²·' : rsi < 30 ? 'è¶…è³£' : 'ä¸­æ€§'}</div>
          </div>
          <div class="factor-card">
            <div class="name">ğŸŒŠ æ³¢æµªä½ç½®</div>
            <div class="value">ç¬¬ ${currentWave} æµª</div>
            <div class="signal ${waveSignal}">${waveSignal === 'bullish' ? 'ä¸Šå‡æ®µ' : waveSignal === 'bearish' ? 'ä¸‹é™æ®µ' : 'æ•´ç†'}</div>
          </div>
          <div class="factor-card">
            <div class="name">ğŸ“‰ ä»Šæ—¥è¡¨ç¾</div>
            <div class="value">${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%</div>
            <div class="signal ${changePercent > 0 ? 'bullish' : 'bearish'}">${changePercent > 0 ? 'ä¸Šæ¼²' : 'ä¸‹è·Œ'}</div>
          </div>
        </div>
        <div class="disclaimer">âš ï¸ å…è²¬è²æ˜ï¼šAI é æ¸¬åƒ…ä¾›åƒè€ƒï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°ã€‚è‚¡å¸‚æœ‰é¢¨éšªï¼ŒæŠ•è³‡éœ€è¬¹æ…ã€‚</div>
      `;
    }
    function calculateRSI(prices, period = 14) {
      if (prices.length < period + 1) return 50;
      let gains = 0, losses = 0;
      for (let i = prices.length - period; i < prices.length; i++) {
        const change = prices[i] - prices[i-1];
        if (change > 0) gains += change; else losses -= change;
      }
      const rs = losses === 0 ? 100 : gains / losses;
      return 100 - (100 / (1 + rs));
    }
    const urlParams = new URLSearchParams(window.location.search);
    document.getElementById('stockInput').value = urlParams.get('stock') || '2330';
    predict();
  </script>
</body>
</html>
