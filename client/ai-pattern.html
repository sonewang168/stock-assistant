<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ‘ï¸ AI Kç·šå‹æ…‹ - è‚¡æµ·ç§˜æ›¸</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Noto Sans TC', sans-serif; }
    body { background: #0d1117; min-height: 100vh; color: #e6edf3; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .header { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; background: #161b22; border-radius: 12px; margin-bottom: 20px; border: 1px solid #30363d; }
    .header h1 { font-size: 1.4rem; color: #a371f7; }
    .search-box { display: flex; gap: 10px; }
    .search-box input { padding: 10px 16px; border-radius: 8px; border: 1px solid #30363d; background: #0d1117; color: #e6edf3; width: 120px; }
    .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; background: #a371f7; color: white; }
    .back-link { color: #58a6ff; text-decoration: none; font-size: 0.9rem; }
    .main-card { background: #161b22; border-radius: 12px; border: 1px solid #30363d; padding: 24px; margin-bottom: 20px; }
    .chart-container { height: 300px; }
    .pattern-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 20px; }
    .pattern-card { background: #0d1117; border: 1px solid #30363d; border-radius: 12px; padding: 20px; }
    .pattern-card.detected { border-color: #a371f7; background: rgba(163,113,247,0.05); }
    .pattern-card .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .pattern-card .name { font-size: 1.1rem; font-weight: 600; color: #c9d1d9; }
    .pattern-card .badge { padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
    .pattern-card .badge.bullish { background: rgba(248,81,73,0.2); color: #f85149; }
    .pattern-card .badge.bearish { background: rgba(63,185,80,0.2); color: #3fb950; }
    .pattern-card .badge.neutral { background: rgba(139,148,158,0.2); color: #8b949e; }
    .pattern-card .desc { color: #8b949e; font-size: 0.9rem; line-height: 1.5; }
    .pattern-card .confidence { margin-top: 12px; display: flex; align-items: center; gap: 8px; }
    .confidence-bar { flex: 1; height: 6px; background: #21262d; border-radius: 3px; overflow: hidden; }
    .confidence-fill { height: 100%; background: #a371f7; border-radius: 3px; }
    .result-card { background: linear-gradient(135deg, #a371f7, #8957e5); border-radius: 12px; padding: 24px; margin-bottom: 20px; }
    .result-card .title { color: rgba(255,255,255,0.9); margin-bottom: 8px; }
    .result-card .pattern { font-size: 1.5rem; font-weight: 700; color: white; }
    .result-card .suggestion { color: rgba(255,255,255,0.9); margin-top: 12px; }
    .loading { text-align: center; padding: 60px; color: #8b949e; }
    .spinner { width: 40px; height: 40px; border: 3px solid #30363d; border-top-color: #a371f7; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div><a href="analysis.html" class="back-link">â† è¿”å›åˆ†æä¸­å¿ƒ</a><h1>ğŸ‘ï¸ AI Kç·šå‹æ…‹è¾¨è­˜</h1></div>
      <div class="search-box">
        <input type="text" id="stockInput" placeholder="è‚¡ç¥¨ä»£ç¢¼" value="2330">
        <button class="btn" onclick="analyze()">ğŸ”® è¾¨è­˜</button>
      </div>
    </header>
    <div id="content"><div class="loading"><div class="spinner"></div><p>è¼‰å…¥ä¸­...</p></div></div>
  </div>
  <script>
    const patterns = {
      hammer: { name: 'ğŸ”¨ éŒ˜å­ç·š', type: 'bullish', desc: 'ä¸‹å½±ç·šé•·ï¼Œå¯¦é«”å°ï¼Œå‡ºç¾åœ¨ä¸‹è·Œè¶¨å‹¢æœ«ç«¯ï¼Œç‚ºåè½‰ä¿¡è™Ÿã€‚' },
      hangingMan: { name: 'ğŸ­ åŠäººç·š', type: 'bearish', desc: 'èˆ‡éŒ˜å­ç·šå½¢æ…‹ç›¸åŒï¼Œä½†å‡ºç¾åœ¨ä¸Šæ¼²è¶¨å‹¢æœ«ç«¯ï¼Œç‚ºè³£å‡ºä¿¡è™Ÿã€‚' },
      doji: { name: 'âœï¸ åå­—ç·š', type: 'neutral', desc: 'é–‹ç›¤åƒ¹èˆ‡æ”¶ç›¤åƒ¹ç›¸è¿‘ï¼Œè¡¨ç¤ºå¤šç©ºæ‹‰é‹¸ï¼Œè¶¨å‹¢å¯èƒ½åè½‰ã€‚' },
      engulfingBull: { name: 'ğŸ‚ å¤šé ­åå™¬', type: 'bullish', desc: 'é™½ç·šå®Œå…¨åå™¬å‰ä¸€æ ¹é™°ç·šï¼Œå¼·çƒˆè²·å…¥ä¿¡è™Ÿã€‚' },
      engulfingBear: { name: 'ğŸ» ç©ºé ­åå™¬', type: 'bearish', desc: 'é™°ç·šå®Œå…¨åå™¬å‰ä¸€æ ¹é™½ç·šï¼Œå¼·çƒˆè³£å‡ºä¿¡è™Ÿã€‚' },
      morningStar: { name: 'ğŸŒ… æ™¨æ˜Ÿ', type: 'bullish', desc: 'ä¸‰æ ¹Kç·šçµ„åˆï¼Œç”±ä¸‹è·Œè½‰ä¸Šæ¼²çš„ä¿¡è™Ÿã€‚' },
      eveningStar: { name: 'ğŸŒ† æš®æ˜Ÿ', type: 'bearish', desc: 'ä¸‰æ ¹Kç·šçµ„åˆï¼Œç”±ä¸Šæ¼²è½‰ä¸‹è·Œçš„ä¿¡è™Ÿã€‚' },
      threeWhite: { name: 'â¬œ ä¸‰ç™½å…µ', type: 'bullish', desc: 'é€£çºŒä¸‰æ ¹ä¸Šæ¼²é™½ç·šï¼Œå¼·å‹¢å¤šé ­ä¿¡è™Ÿã€‚' }
    };
    
    function detectPatterns(history) {
      const detected = [];
      const len = history.length;
      if (len < 3) return detected;
      
      const last = history[len - 1];
      const prev = history[len - 2];
      const body = Math.abs(last.close - last.open);
      const upperShadow = last.high - Math.max(last.close, last.open);
      const lowerShadow = Math.min(last.close, last.open) - last.low;
      
      // éŒ˜å­ç·š
      if (lowerShadow > body * 2 && upperShadow < body * 0.5 && last.close < prev.close) {
        detected.push({ ...patterns.hammer, confidence: 75 });
      }
      
      // åå­—ç·š
      if (body < (last.high - last.low) * 0.1) {
        detected.push({ ...patterns.doji, confidence: 80 });
      }
      
      // å¤šé ­åå™¬
      if (last.close > last.open && prev.close < prev.open && 
          last.close > prev.open && last.open < prev.close) {
        detected.push({ ...patterns.engulfingBull, confidence: 85 });
      }
      
      // ç©ºé ­åå™¬
      if (last.close < last.open && prev.close > prev.open &&
          last.close < prev.open && last.open > prev.close) {
        detected.push({ ...patterns.engulfingBear, confidence: 85 });
      }
      
      // ä¸‰ç™½å…µ
      if (len >= 3) {
        const h3 = history.slice(-3);
        if (h3.every(h => h.close > h.open) && h3[2].close > h3[1].close && h3[1].close > h3[0].close) {
          detected.push({ ...patterns.threeWhite, confidence: 70 });
        }
      }
      
      return detected.length > 0 ? detected : [{ name: 'ğŸ“Š ç„¡æ˜é¡¯å‹æ…‹', type: 'neutral', desc: 'ç›®å‰Kç·šç„¡æ˜é¡¯çš„æŠ€è¡“å‹æ…‹ï¼Œå»ºè­°è§€æœ›ã€‚', confidence: 50 }];
    }
    
    async function analyze() {
      const stockId = document.getElementById('stockInput').value.trim();
      if (!stockId) return alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼');
      document.getElementById('content').innerHTML = '<div class="loading"><div class="spinner"></div><p>AI æ­£åœ¨è¾¨è­˜Kç·šå‹æ…‹...</p></div>';
      try {
        const res = await fetch(`/api/line/wave/analyze/${stockId}`);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        renderAnalysis(stockId, data);
      } catch (e) {
        document.getElementById('content').innerHTML = `<div class="main-card"><p style="color:#f85149;">åˆ†æå¤±æ•—: ${e.message}</p></div>`;
      }
    }
    
    function renderAnalysis(stockId, data) {
      const { history, stockName, currentPrice } = data;
      const detected = detectPatterns(history);
      const mainPattern = detected[0];
      
      document.getElementById('content').innerHTML = `
        <div class="result-card">
          <div class="title">AI è¾¨è­˜çµæœ - ${stockName} (${stockId})</div>
          <div class="pattern">${mainPattern.name}</div>
          <div class="suggestion">ğŸ’¡ ${mainPattern.desc}</div>
        </div>
        <div class="main-card">
          <div style="color:#c9d1d9; margin-bottom:16px;">ğŸ“ˆ è¿‘æœŸKç·šèµ°å‹¢</div>
          <div class="chart-container"><canvas id="chart"></canvas></div>
        </div>
        <div class="pattern-grid">
          ${detected.map(p => `
            <div class="pattern-card detected">
              <div class="header">
                <span class="name">${p.name}</span>
                <span class="badge ${p.type}">${p.type === 'bullish' ? 'çœ‹å¤š' : p.type === 'bearish' ? 'çœ‹ç©º' : 'ä¸­æ€§'}</span>
              </div>
              <div class="desc">${p.desc}</div>
              <div class="confidence">
                <span style="font-size:0.8rem; color:#8b949e;">ä¿¡å¿ƒåº¦</span>
                <div class="confidence-bar"><div class="confidence-fill" style="width:${p.confidence}%;"></div></div>
                <span style="font-size:0.8rem; color:#a371f7;">${p.confidence}%</span>
              </div>
            </div>
          `).join('')}
        </div>
      `;
      
      const labels = history.slice(-30).map(h => new Date(h.date).toLocaleDateString('zh-TW', {month:'numeric', day:'numeric'}));
      const prices = history.slice(-30).map(h => h.close);
      new Chart(document.getElementById('chart'), {
        type: 'line',
        data: { labels, datasets: [{ data: prices, borderColor: '#a371f7', backgroundColor: 'rgba(163,113,247,0.1)', fill: true, tension: 0.3, pointRadius: 2 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
          scales: { x: { grid: { color: '#21262d' }, ticks: { color: '#8b949e', maxTicksLimit: 10 } }, y: { grid: { color: '#21262d' }, ticks: { color: '#8b949e' } } }
        }
      });
    }
    
    const urlParams = new URLSearchParams(window.location.search);
    document.getElementById('stockInput').value = urlParams.get('stock') || '2330';
    analyze();
  </script>
</body>
</html>
