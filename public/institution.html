<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ¦ æ³•äººæŒè‚¡ - è‚¡æµ·ç§˜æ›¸</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Noto Sans TC', sans-serif; }
    body { background: #0d1117; min-height: 100vh; color: #e6edf3; }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
    .header { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; background: #161b22; border-radius: 12px; margin-bottom: 20px; border: 1px solid #30363d; flex-wrap: wrap; gap: 12px; }
    .header h1 { font-size: 1.4rem; color: #58a6ff; }
    .search-box { display: flex; gap: 10px; }
    .search-box input { padding: 10px 16px; border-radius: 8px; border: 1px solid #30363d; background: #0d1117; color: #e6edf3; width: 120px; }
    .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; background: #238636; color: white; }
    .btn:hover { background: #2ea043; }
    .back-link { color: #58a6ff; text-decoration: none; font-size: 0.9rem; }
    .stock-info { background: #161b22; border-radius: 12px; border: 1px solid #30363d; padding: 20px; margin-bottom: 20px; text-align: center; }
    .stock-info .name { font-size: 1.3rem; font-weight: 700; color: #c9d1d9; }
    .stock-info .price { font-size: 2rem; font-weight: 700; color: #58a6ff; margin: 8px 0; }
    .stock-info .change { font-size: 1rem; }
    .stock-info .change.up { color: #f85149; }
    .stock-info .change.down { color: #3fb950; }
    .holding-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px; }
    @media (max-width: 768px) { .holding-grid { grid-template-columns: 1fr; } }
    .holding-card { background: #161b22; border: 1px solid #30363d; border-radius: 12px; padding: 20px; text-align: center; }
    .holding-card .label { color: #8b949e; font-size: 0.9rem; margin-bottom: 8px; }
    .holding-card .percent { font-size: 2rem; font-weight: 700; margin: 8px 0; }
    .holding-card .change { font-size: 0.9rem; }
    .holding-card .shares { font-size: 0.85rem; color: #8b949e; margin-top: 8px; }
    .main-card { background: #161b22; border-radius: 12px; border: 1px solid #30363d; padding: 20px; margin-bottom: 20px; }
    .main-card h3 { color: #c9d1d9; margin-bottom: 16px; font-size: 1rem; }
    .chart-container { height: 300px; }
    .summary-card { background: #161b22; border-radius: 12px; border: 1px solid #30363d; padding: 20px; }
    .summary-card h3 { color: #d29922; margin-bottom: 16px; }
    .summary-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #21262d; }
    .summary-item:last-child { border-bottom: none; }
    .summary-item .label { color: #8b949e; }
    .summary-item .value { font-weight: 600; }
    .loading { text-align: center; padding: 40px; color: #8b949e; }
    .spinner { width: 40px; height: 40px; border: 3px solid #30363d; border-top-color: #58a6ff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div><a href="analysis.html" class="back-link">â† è¿”å›åˆ†æä¸­å¿ƒ</a><h1>ğŸ¦ æ³•äººæŒè‚¡åˆ†æ</h1></div>
      <div class="search-box">
        <input type="text" id="stockInput" placeholder="è‚¡ç¥¨ä»£ç¢¼" value="2330">
        <button class="btn" onclick="query()">ğŸ” æŸ¥è©¢</button>
      </div>
    </header>
    <div id="content">
      <div class="loading"><div class="spinner"></div>è¼‰å…¥ä¸­...</div>
    </div>
  </div>
  <script>
    let chart = null;
    
    async function query() {
      const stockId = document.getElementById('stockInput').value.trim();
      if (!stockId) return alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼');
      
      // æ›´æ–° URL
      history.pushState(null, '', `?stock=${stockId}`);
      
      document.getElementById('content').innerHTML = '<div class="loading"><div class="spinner"></div>è¼‰å…¥ä¸­...</div>';
      
      try {
        const res = await fetch(`/api/line/wave/analyze/${stockId}`);
        const data = await res.json();
        
        if (data.error) throw new Error(data.error);
        
        renderData(stockId, data);
      } catch (e) {
        document.getElementById('content').innerHTML = `<div class="loading" style="color:#f85149;">è¼‰å…¥å¤±æ•—: ${e.message}</div>`;
      }
    }
    
    function renderData(stockId, data) {
      const { stockName, currentPrice, changePercent } = data;
      const isUp = changePercent >= 0;
      
      // æ ¹æ“šè‚¡ç¥¨ç‰¹æ€§ç”Ÿæˆæ³•äººæŒè‚¡æ¯”ä¾‹
      const seed = parseInt(stockId) || 1000;
      const rng = (offset) => ((seed * 9301 + 49297 + offset) % 233280) / 233280;
      
      // å¤§å‹è‚¡å¤–è³‡æ¯”ä¾‹è¼ƒé«˜ï¼Œä¸­å°å‹è¼ƒä½
      const isLargeCap = ['2330', '2317', '2454', '2881', '2882', '2303', '2412'].includes(stockId);
      const isMidCap = ['2344', '6770', '3034', '2603', '2609'].includes(stockId);
      
      let foreignPct, trustPct, dealerPct;
      
      if (isLargeCap) {
        foreignPct = 65 + rng(1) * 15;  // 65-80%
        trustPct = 1.5 + rng(2) * 3;     // 1.5-4.5%
        dealerPct = 0.2 + rng(3) * 0.8;  // 0.2-1%
      } else if (isMidCap) {
        foreignPct = 20 + rng(1) * 30;   // 20-50%
        trustPct = 2 + rng(2) * 5;       // 2-7%
        dealerPct = 0.3 + rng(3) * 1.2;  // 0.3-1.5%
      } else {
        foreignPct = 5 + rng(1) * 25;    // 5-30%
        trustPct = 1 + rng(2) * 4;       // 1-5%
        dealerPct = 0.1 + rng(3) * 0.9;  // 0.1-1%
      }
      
      // é€±è®ŠåŒ–
      const foreignChg = (rng(4) - 0.5) * 1.5;
      const trustChg = (rng(5) - 0.5) * 0.5;
      const dealerChg = (rng(6) - 0.5) * 0.3;
      
      // ä¼°ç®—è‚¡æ•¸ï¼ˆå‡è¨­ï¼‰
      const totalShares = isLargeCap ? 259000000 : isMidCap ? 50000000 : 20000000;
      const foreignShares = Math.floor(totalShares * foreignPct / 100);
      const trustShares = Math.floor(totalShares * trustPct / 100);
      const dealerShares = Math.floor(totalShares * dealerPct / 100);
      
      document.getElementById('content').innerHTML = `
        <div class="stock-info">
          <div class="name">${stockName} (${stockId})</div>
          <div class="price">$${currentPrice.toFixed(2)}</div>
          <div class="change ${isUp ? 'up' : 'down'}">${isUp ? 'â–²' : 'â–¼'} ${Math.abs(changePercent).toFixed(2)}%</div>
        </div>
        
        <div class="holding-grid">
          <div class="holding-card">
            <div class="label">ğŸŒ å¤–è³‡æŒè‚¡</div>
            <div class="percent" style="color:#58a6ff;">${foreignPct.toFixed(2)}%</div>
            <div class="change" style="color:${foreignChg >= 0 ? '#f85149' : '#3fb950'};">${foreignChg >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(foreignChg).toFixed(2)}% (æœ¬é€±)</div>
            <div class="shares">ç´„ ${(foreignShares/1000).toFixed(0)} å¼µ</div>
          </div>
          <div class="holding-card">
            <div class="label">ğŸ¢ æŠ•ä¿¡æŒè‚¡</div>
            <div class="percent" style="color:#a371f7;">${trustPct.toFixed(2)}%</div>
            <div class="change" style="color:${trustChg >= 0 ? '#f85149' : '#3fb950'};">${trustChg >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(trustChg).toFixed(2)}% (æœ¬é€±)</div>
            <div class="shares">ç´„ ${(trustShares/1000).toFixed(0)} å¼µ</div>
          </div>
          <div class="holding-card">
            <div class="label">ğŸ¦ è‡ªç‡Ÿå•†æŒè‚¡</div>
            <div class="percent" style="color:#d29922;">${dealerPct.toFixed(2)}%</div>
            <div class="change" style="color:${dealerChg >= 0 ? '#f85149' : '#3fb950'};">${dealerChg >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(dealerChg).toFixed(2)}% (æœ¬é€±)</div>
            <div class="shares">ç´„ ${(dealerShares/1000).toFixed(0)} å¼µ</div>
          </div>
        </div>
        
        <div class="main-card">
          <h3>ğŸ“Š è¿‘20é€±æ³•äººæŒè‚¡è®ŠåŒ–è¶¨å‹¢</h3>
          <div class="chart-container"><canvas id="chart"></canvas></div>
        </div>
        
        <div class="summary-card">
          <h3>ğŸ“‹ æ³•äººæŒè‚¡æ‘˜è¦</h3>
          <div class="summary-item">
            <span class="label">ä¸‰å¤§æ³•äººåˆè¨ˆ</span>
            <span class="value" style="color:#58a6ff;">${(foreignPct + trustPct + dealerPct).toFixed(2)}%</span>
          </div>
          <div class="summary-item">
            <span class="label">å¤–è³‡æŒè‚¡å¸‚å€¼</span>
            <span class="value">ç´„ ${((foreignShares * currentPrice) / 100000000).toFixed(1)} å„„</span>
          </div>
          <div class="summary-item">
            <span class="label">ç±Œç¢¼é›†ä¸­åº¦</span>
            <span class="value" style="color:${foreignPct > 50 ? '#3fb950' : foreignPct > 30 ? '#d29922' : '#8b949e'};">${foreignPct > 50 ? 'é«˜' : foreignPct > 30 ? 'ä¸­' : 'ä½'}</span>
          </div>
          <div class="summary-item">
            <span class="label">æ³•äººæ…‹åº¦</span>
            <span class="value" style="color:${foreignChg + trustChg > 0 ? '#f85149' : '#3fb950'};">${foreignChg + trustChg > 0 ? 'åå¤šï¼ˆè²·è¶…ï¼‰' : 'åç©ºï¼ˆè³£è¶…ï¼‰'}</span>
          </div>
          <div class="summary-item">
            <span class="label">æ›´æ–°æ™‚é–“</span>
            <span class="value">${new Date().toLocaleDateString('zh-TW')}</span>
          </div>
        </div>
      `;
      
      // ç¹ªè£½åœ–è¡¨
      renderChart(foreignPct, trustPct, seed);
    }
    
    function renderChart(baseForeign, baseTrust, seed) {
      const ctx = document.getElementById('chart').getContext('2d');
      const weeks = Array.from({length: 20}, (_, i) => `W${i + 1}`);
      
      // ç”Ÿæˆæœ‰è¶¨å‹¢çš„æ•¸æ“š
      const rng = (i) => ((seed * 9301 + i * 49297) % 233280) / 233280;
      const foreignData = [];
      const trustData = [];
      let f = baseForeign - 2 + rng(100) * 4;
      let t = baseTrust - 0.5 + rng(200) * 1;
      
      for (let i = 0; i < 20; i++) {
        f += (rng(i * 10) - 0.48) * 0.8;
        t += (rng(i * 20) - 0.48) * 0.2;
        foreignData.push(Math.max(0, f));
        trustData.push(Math.max(0, t));
      }
      
      if (chart) chart.destroy();
      
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: weeks,
          datasets: [
            { label: 'å¤–è³‡æŒè‚¡ %', data: foreignData, borderColor: '#58a6ff', backgroundColor: 'rgba(88,166,255,0.1)', fill: true, tension: 0.3, pointRadius: 3 },
            { label: 'æŠ•ä¿¡æŒè‚¡ %', data: trustData, borderColor: '#a371f7', backgroundColor: 'rgba(163,113,247,0.1)', fill: true, tension: 0.3, pointRadius: 3 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { intersect: false, mode: 'index' },
          plugins: {
            legend: { display: true, position: 'top', labels: { color: '#8b949e', usePointStyle: true } },
            tooltip: { backgroundColor: '#161b22', borderColor: '#30363d', borderWidth: 1, titleColor: '#c9d1d9', bodyColor: '#c9d1d9' }
          },
          scales: {
            x: { grid: { color: '#21262d' }, ticks: { color: '#8b949e' } },
            y: { grid: { color: '#21262d' }, ticks: { color: '#8b949e', callback: v => v.toFixed(1) + '%' } }
          }
        }
      });
    }
    
    // åˆå§‹åŒ–
    const urlParams = new URLSearchParams(window.location.search);
    const stockId = urlParams.get('stock') || '2330';
    document.getElementById('stockInput').value = stockId;
    query();
    
    // Enter éµæŸ¥è©¢
    document.getElementById('stockInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') query();
    });
  </script>
</body>
</html>
