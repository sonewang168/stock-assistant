<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“ˆ ç¸¾æ•ˆè¿½è¹¤ - è‚¡æµ·ç§˜æ›¸</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Noto Sans TC', sans-serif; }
    body { background: #0d1117; min-height: 100vh; color: #e6edf3; }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
    .header { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; background: #161b22; border-radius: 12px; margin-bottom: 20px; border: 1px solid #30363d; flex-wrap: wrap; gap: 12px; }
    .header h1 { font-size: 1.4rem; color: #58a6ff; }
    .back-link { color: #58a6ff; text-decoration: none; font-size: 0.9rem; }
    .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; background: #238636; color: white; }
    .btn:hover { background: #2ea043; }
    
    .summary-card { border-radius: 16px; padding: 32px; text-align: center; margin-bottom: 24px; }
    .summary-card.profit { background: linear-gradient(135deg, #238636, #2ea043); }
    .summary-card.loss { background: linear-gradient(135deg, #da3633, #f85149); }
    .summary-card.neutral { background: linear-gradient(135deg, #6e7681, #8b949e); }
    .summary-card .title { color: rgba(255,255,255,0.9); font-size: 1rem; }
    .summary-card .value { font-size: 3rem; font-weight: 700; color: white; margin: 12px 0; }
    .summary-card .sub { color: rgba(255,255,255,0.8); font-size: 1.1rem; }
    
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 20px; }
    .stat-card { background: #161b22; border: 1px solid #30363d; border-radius: 12px; padding: 20px; text-align: center; }
    .stat-card .label { color: #8b949e; font-size: 0.85rem; }
    .stat-card .value { font-size: 1.4rem; font-weight: 700; margin-top: 8px; }
    
    .main-card { background: #161b22; border-radius: 12px; border: 1px solid #30363d; padding: 20px; margin-bottom: 20px; }
    .main-card h3 { color: #c9d1d9; margin-bottom: 16px; }
    .chart-container { height: 300px; }
    
    .holdings-table { background: #161b22; border: 1px solid #30363d; border-radius: 12px; padding: 20px; }
    .holdings-table h3 { color: #c9d1d9; margin-bottom: 16px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 8px; text-align: right; border-bottom: 1px solid #21262d; }
    th { color: #8b949e; font-weight: 500; font-size: 0.85rem; }
    td { color: #c9d1d9; }
    td:first-child, th:first-child { text-align: left; }
    td a { color: #58a6ff; text-decoration: none; }
    
    .empty-state { text-align: center; padding: 60px 20px; color: #8b949e; }
    .empty-state .icon { font-size: 3rem; margin-bottom: 16px; }
    
    .loading { text-align: center; padding: 40px; color: #8b949e; }
    .spinner { width: 40px; height: 40px; border: 3px solid #30363d; border-top-color: #58a6ff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div><a href="analysis.html" class="back-link">â† è¿”å›åˆ†æä¸­å¿ƒ</a><h1>ğŸ“ˆ ç¸¾æ•ˆè¿½è¹¤</h1></div>
      <button class="btn" onclick="loadPerformance()">ğŸ”„ æ›´æ–°</button>
    </header>
    <div id="content">
      <div class="loading"><div class="spinner"></div>è¼‰å…¥ç¸¾æ•ˆæ•¸æ“šä¸­...</div>
    </div>
  </div>
  
  <script>
    let chart = null;
    
    async function loadPerformance() {
      document.getElementById('content').innerHTML = '<div class="loading"><div class="spinner"></div>è¼‰å…¥ç¸¾æ•ˆæ•¸æ“šä¸­...</div>';
      
      try {
        // è®€å–æŒè‚¡ä¸­
        const holdingRes = await fetch('/api/holdings');
        const holdingData = await holdingRes.json();
        const holdings = holdingData.holdings || [];
        
        // è®€å–å·²è³£å‡º
        const soldRes = await fetch('/api/holdings?sold=true');
        const soldData = await soldRes.json();
        const soldHoldings = soldData.holdings || [];
        
        if (holdings.length === 0 && soldHoldings.length === 0) {
          document.getElementById('content').innerHTML = `
            <div class="empty-state">
              <div class="icon">ğŸ“Š</div>
              <div>å°šç„¡ç¸¾æ•ˆæ•¸æ“š</div>
              <div style="margin-top:12px;font-size:0.9rem;">
                è«‹å…ˆåˆ° <a href="holdings.html" style="color:#58a6ff;">æŒè‚¡ç®¡ç†</a> æ–°å¢æ‚¨çš„æŒè‚¡
              </div>
            </div>
          `;
          return;
        }
        
        // åˆ†ææŒè‚¡
        const analysis = [];
        let totalCost = 0;
        let totalValue = 0;
        
        for (const h of holdings) {
          const stockId = h.stock_id;
          const lots = h.lots || 0;
          const oddShares = h.odd_shares || 0;
          const totalShares = lots * 1000 + oddShares;
          const costPrice = parseFloat(h.won_price) || parseFloat(h.bid_price) || 0;
          const cost = costPrice * totalShares;
          
          if (!stockId || totalShares === 0) continue;
          
          try {
            const res = await fetch(`/api/line/wave/analyze/${stockId}`);
            const data = await res.json();
            
            if (!data.error) {
              const currentPrice = data.currentPrice;
              const value = currentPrice * totalShares;
              const profit = value - cost;
              const profitPct = cost > 0 ? (profit / cost * 100) : 0;
              
              analysis.push({
                stockId,
                stockName: data.stockName || h.stock_name,
                lots,
                oddShares,
                totalShares,
                costPrice,
                currentPrice,
                cost,
                value,
                profit,
                profitPct,
                isWon: h.is_won
              });
              
              if (h.is_won && cost > 0) {
                totalCost += cost;
                totalValue += value;
              }
            }
          } catch (e) {}
        }
        
        // è¨ˆç®—å·²å¯¦ç¾ç²åˆ©
        let realizedProfit = 0;
        let realizedCost = 0;
        for (const s of soldHoldings) {
          const sellPrice = parseFloat(s.sell_price) || 0;
          const costPrice = parseFloat(s.won_price) || parseFloat(s.bid_price) || 0;
          const lots = s.lots || 0;
          const oddShares = s.odd_shares || 0;
          const totalShares = lots * 1000 + oddShares;
          
          if (sellPrice > 0 && costPrice > 0) {
            realizedProfit += (sellPrice - costPrice) * totalShares;
            realizedCost += costPrice * totalShares;
          }
        }
        
        // è¨ˆç®—ç¸½ç¸¾æ•ˆ
        const unrealizedProfit = totalValue - totalCost;
        const totalProfit = realizedProfit + unrealizedProfit;
        const totalInvested = totalCost + realizedCost;
        const totalReturnPct = totalInvested > 0 ? (totalProfit / totalInvested * 100) : 0;
        
        renderPerformance({
          totalCost,
          totalValue,
          unrealizedProfit,
          realizedProfit,
          totalProfit,
          totalReturnPct,
          holdings: analysis,
          soldCount: soldHoldings.length
        });
        
      } catch (e) {
        document.getElementById('content').innerHTML = `<div class="loading" style="color:#f85149;">è¼‰å…¥å¤±æ•—: ${e.message}</div>`;
      }
    }
    
    function formatMoney(v) {
      if (Math.abs(v) >= 100000000) return (v / 100000000).toFixed(2) + ' å„„';
      if (Math.abs(v) >= 10000) return (v / 10000).toFixed(1) + ' è¬';
      return '$' + Math.round(v).toLocaleString();
    }
    
    function renderPerformance(data) {
      const { totalCost, totalValue, unrealizedProfit, realizedProfit, totalProfit, totalReturnPct, holdings, soldCount } = data;
      
      const isProfit = totalProfit >= 0;
      const cardClass = totalProfit > 0 ? 'profit' : totalProfit < 0 ? 'loss' : 'neutral';
      
      document.getElementById('content').innerHTML = `
        <div class="summary-card ${cardClass}">
          <div class="title">ç¸½å ±é…¬ç‡</div>
          <div class="value">${isProfit ? '+' : ''}${totalReturnPct.toFixed(2)}%</div>
          <div class="sub">${isProfit ? 'ç¸½ç²åˆ©' : 'ç¸½è™§æ'} ${formatMoney(Math.abs(totalProfit))}</div>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="label">æŠ•å…¥æˆæœ¬</div>
            <div class="value" style="color:#58a6ff;">${formatMoney(totalCost)}</div>
          </div>
          <div class="stat-card">
            <div class="label">ç›®å‰å¸‚å€¼</div>
            <div class="value" style="color:#c9d1d9;">${formatMoney(totalValue)}</div>
          </div>
          <div class="stat-card">
            <div class="label">æœªå¯¦ç¾æç›Š</div>
            <div class="value" style="color:${unrealizedProfit >= 0 ? '#f85149' : '#3fb950'};">${unrealizedProfit >= 0 ? '+' : ''}${formatMoney(unrealizedProfit)}</div>
          </div>
          <div class="stat-card">
            <div class="label">å·²å¯¦ç¾æç›Š</div>
            <div class="value" style="color:${realizedProfit >= 0 ? '#f85149' : '#3fb950'};">${realizedProfit >= 0 ? '+' : ''}${formatMoney(realizedProfit)}</div>
          </div>
        </div>
        
        <div class="main-card">
          <h3>ğŸ“Š å„æŒè‚¡æç›Šåˆ†å¸ƒ</h3>
          <div class="chart-container"><canvas id="chart"></canvas></div>
        </div>
        
        <div class="holdings-table">
          <h3>ğŸ“‹ æŒè‚¡ç¸¾æ•ˆæ˜ç´° (${holdings.length} æª”æŒè‚¡ä¸­${soldCount > 0 ? `, ${soldCount} ç­†å·²è³£å‡º` : ''})</h3>
          <table>
            <thead>
              <tr><th>è‚¡ç¥¨</th><th>è‚¡æ•¸</th><th>æˆæœ¬</th><th>å¸‚å€¼</th><th>æç›Š</th><th>å ±é…¬ç‡</th></tr>
            </thead>
            <tbody>
              ${holdings.filter(h => h.isWon && h.cost > 0).map(h => {
                const sharesText = h.lots > 0 && h.oddShares > 0 ? `${h.lots}å¼µ${h.oddShares}è‚¡` :
                                  h.lots > 0 ? `${h.lots}å¼µ` : `${h.oddShares}è‚¡`;
                return `
                  <tr>
                    <td><a href="wave.html?stock=${h.stockId}">${h.stockId} ${h.stockName}</a></td>
                    <td>${sharesText}</td>
                    <td>${formatMoney(h.cost)}</td>
                    <td>${formatMoney(h.value)}</td>
                    <td style="color:${h.profit >= 0 ? '#f85149' : '#3fb950'};">${h.profit >= 0 ? '+' : ''}${formatMoney(h.profit)}</td>
                    <td style="color:${h.profitPct >= 0 ? '#f85149' : '#3fb950'};">${h.profitPct >= 0 ? '+' : ''}${h.profitPct.toFixed(1)}%</td>
                  </tr>
                `;
              }).join('')}
              ${holdings.filter(h => h.isWon && h.cost > 0).length === 0 ? '<tr><td colspan="6" style="text-align:center;color:#8b949e;">å°šç„¡å·²å¾—æ¨™æŒè‚¡</td></tr>' : ''}
            </tbody>
          </table>
        </div>
      `;
      
      // ç¹ªè£½åœ–è¡¨
      renderChart(holdings.filter(h => h.isWon && h.cost > 0));
    }
    
    function renderChart(holdings) {
      const ctx = document.getElementById('chart').getContext('2d');
      
      if (holdings.length === 0) {
        ctx.font = '14px sans-serif';
        ctx.fillStyle = '#8b949e';
        ctx.textAlign = 'center';
        ctx.fillText('å°šç„¡æ•¸æ“š', ctx.canvas.width / 2, ctx.canvas.height / 2);
        return;
      }
      
      const labels = holdings.map(h => h.stockId);
      const profits = holdings.map(h => h.profit);
      const colors = profits.map(p => p >= 0 ? 'rgba(248,81,73,0.8)' : 'rgba(63,185,80,0.8)');
      
      if (chart) chart.destroy();
      
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'æç›Š',
            data: profits,
            backgroundColor: colors,
            borderColor: colors.map(c => c.replace('0.8', '1')),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const v = ctx.raw;
                  return (v >= 0 ? '+' : '') + '$' + Math.round(v).toLocaleString();
                }
              }
            }
          },
          scales: {
            x: { grid: { color: '#21262d' }, ticks: { color: '#8b949e' } },
            y: {
              grid: { color: '#21262d' },
              ticks: {
                color: '#8b949e',
                callback: v => {
                  if (Math.abs(v) >= 10000) return (v / 10000).toFixed(0) + 'è¬';
                  return v;
                }
              }
            }
          }
        }
      });
    }
    
    loadPerformance();
  </script>
</body>
</html>
