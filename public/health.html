<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ¥ å¥æª¢å ±å‘Š - è‚¡æµ·ç§˜æ›¸</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Noto Sans TC', sans-serif; }
    body { background: #0d1117; min-height: 100vh; color: #e6edf3; }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
    .header { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; background: #161b22; border-radius: 12px; margin-bottom: 20px; border: 1px solid #30363d; flex-wrap: wrap; gap: 12px; }
    .header h1 { font-size: 1.4rem; color: #58a6ff; }
    .back-link { color: #58a6ff; text-decoration: none; font-size: 0.9rem; }
    .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; background: #238636; color: white; }
    .btn:hover { background: #2ea043; }
    
    .score-card { border-radius: 16px; padding: 32px; text-align: center; margin-bottom: 24px; }
    .score-card.excellent { background: linear-gradient(135deg, #238636, #2ea043); }
    .score-card.good { background: linear-gradient(135deg, #1f6feb, #58a6ff); }
    .score-card.fair { background: linear-gradient(135deg, #9e6a03, #d29922); }
    .score-card.poor { background: linear-gradient(135deg, #da3633, #f85149); }
    .score-card .title { color: rgba(255,255,255,0.9); font-size: 1rem; }
    .score-card .score { font-size: 4rem; font-weight: 700; color: white; }
    .score-card .grade { font-size: 1.5rem; color: white; margin-top: 8px; }
    
    .summary-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 24px; }
    .summary-item { background: #161b22; border: 1px solid #30363d; border-radius: 10px; padding: 16px; text-align: center; }
    .summary-item .label { color: #8b949e; font-size: 0.85rem; }
    .summary-item .value { font-size: 1.3rem; font-weight: 700; margin-top: 4px; }
    
    .check-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 20px; }
    .check-item { background: #161b22; border: 1px solid #30363d; border-radius: 12px; padding: 20px; }
    .check-item .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .check-item .name { font-weight: 600; color: #c9d1d9; }
    .check-item .status { padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; }
    .check-item .status.good { background: rgba(63,185,80,0.2); color: #3fb950; }
    .check-item .status.warn { background: rgba(210,153,34,0.2); color: #d29922; }
    .check-item .status.bad { background: rgba(248,81,73,0.2); color: #f85149; }
    .check-item .desc { color: #8b949e; font-size: 0.9rem; line-height: 1.6; }
    
    .holdings-table { background: #161b22; border: 1px solid #30363d; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    .holdings-table h3 { color: #c9d1d9; margin-bottom: 16px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px; text-align: right; border-bottom: 1px solid #21262d; }
    th { color: #8b949e; font-weight: 500; font-size: 0.9rem; }
    td { color: #c9d1d9; }
    td:first-child, th:first-child { text-align: left; }
    td a { color: #58a6ff; text-decoration: none; }
    
    .suggestion { background: #21262d; border-radius: 12px; padding: 20px; }
    .suggestion h4 { color: #d29922; margin-bottom: 12px; }
    .suggestion ul { color: #c9d1d9; padding-left: 20px; line-height: 1.8; }
    
    .empty-state { text-align: center; padding: 60px 20px; color: #8b949e; }
    .empty-state .icon { font-size: 3rem; margin-bottom: 16px; }
    
    .loading { text-align: center; padding: 40px; color: #8b949e; }
    .spinner { width: 40px; height: 40px; border: 3px solid #30363d; border-top-color: #58a6ff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div><a href="analysis.html" class="back-link">â† è¿”å›åˆ†æä¸­å¿ƒ</a><h1>ğŸ¥ æŒè‚¡å¥æª¢å ±å‘Š</h1></div>
      <button class="btn" onclick="runHealthCheck()">ğŸ”„ é‡æ–°æª¢æŸ¥</button>
    </header>
    <div id="content">
      <div class="loading"><div class="spinner"></div>æ­£åœ¨åˆ†ææ‚¨çš„æŒè‚¡...</div>
    </div>
  </div>
  
  <script>
    // å¾å¾Œç«¯ API è®€å–æŒè‚¡
    async function getHoldingsFromAPI() {
      try {
        const res = await fetch('/api/holdings');
        const data = await res.json();
        return data.holdings || [];
      } catch (e) {
        console.log('API è®€å–å¤±æ•—ï¼Œå˜—è©¦ localStorage');
        return null;
      }
    }
    
    // å¾ localStorage è®€å–æŒè‚¡ï¼ˆå‚™ç”¨ï¼‰
    function getHoldingsFromStorage() {
      const keys = ['holdings', 'stock_holdings', 'portfolio', 'watchlist_stocks'];
      for (const key of keys) {
        const data = localStorage.getItem(key);
        if (data) {
          try {
            const parsed = JSON.parse(data);
            if (Array.isArray(parsed) && parsed.length > 0) return parsed;
          } catch (e) {}
        }
      }
      return [];
    }
    
    async function runHealthCheck() {
      document.getElementById('content').innerHTML = '<div class="loading"><div class="spinner"></div>æ­£åœ¨åˆ†ææ‚¨çš„æŒè‚¡...</div>';
      
      // å„ªå…ˆå¾ API è®€å–
      let holdings = await getHoldingsFromAPI();
      
      // å¦‚æœ API å¤±æ•—ï¼Œå˜—è©¦ localStorage
      if (!holdings || holdings.length === 0) {
        holdings = getHoldingsFromStorage();
      }
      
      if (!holdings || holdings.length === 0) {
        document.getElementById('content').innerHTML = `
          <div class="empty-state">
            <div class="icon">ğŸ“‹</div>
            <div>å°šæœªæœ‰æŒè‚¡è³‡æ–™</div>
            <div style="margin-top:12px;font-size:0.9rem;">
              è«‹å…ˆåˆ° <a href="holdings.html" style="color:#58a6ff;">æŒè‚¡ç®¡ç†</a> æ–°å¢æ‚¨çš„æŒè‚¡
            </div>
          </div>
        `;
        return;
      }
      
      // åˆ†ææ¯æª”æŒè‚¡
      const analysis = [];
      let totalLots = 0;
      let totalOddShares = 0;
      let totalValue = 0;
      let totalCost = 0;
      
      for (const h of holdings) {
        // é©æ‡‰ä¸åŒçš„æ•¸æ“šæ ¼å¼
        const stockId = h.stock_id || h.stockId || h.id || h.code;
        const lots = h.lots || Math.floor((h.shares || h.quantity || 0) / 1000) || 0;
        const oddShares = h.odd_shares !== undefined ? h.odd_shares : ((h.shares || 0) % 1000);
        const totalShares = lots * 1000 + oddShares;
        const costPrice = parseFloat(h.won_price) || parseFloat(h.bid_price) || parseFloat(h.cost) || parseFloat(h.avgCost) || 0;
        
        if (!stockId) continue;
        
        try {
          const res = await fetch(`/api/line/wave/analyze/${stockId}`);
          const data = await res.json();
          
          if (!data.error) {
            const currentPrice = data.currentPrice;
            const value = currentPrice * totalShares;
            const costValue = costPrice * totalShares;
            const profit = costPrice > 0 ? ((currentPrice - costPrice) / costPrice * 100) : 0;
            
            analysis.push({
              stockId,
              stockName: data.stockName || h.stock_name,
              lots,
              oddShares,
              totalShares,
              costPrice,
              currentPrice,
              changePercent: data.changePercent,
              currentWave: data.currentWave,
              value,
              costValue,
              profit,
              isWon: h.is_won !== false
            });
            
            totalLots += lots;
            totalOddShares += oddShares;
            totalValue += value;
            totalCost += costValue;
          }
        } catch (e) {
          console.log('åˆ†æå¤±æ•—:', stockId);
        }
      }
      
      if (analysis.length === 0) {
        document.getElementById('content').innerHTML = `
          <div class="empty-state">
            <div class="icon">âš ï¸</div>
            <div>ç„¡æ³•å–å¾—æŒè‚¡è³‡æ–™</div>
            <div style="margin-top:8px;font-size:0.9rem;">è«‹ç¢ºèªç¶²è·¯é€£ç·šå¾Œé‡è©¦</div>
          </div>
        `;
        return;
      }
      
      // è¨ˆç®—å¥åº·åˆ†æ•¸
      const report = calculateHealthScore(analysis, totalValue, totalCost);
      renderReport(analysis, report, totalLots, totalOddShares, totalValue, totalCost);
    }
    
    function calculateHealthScore(analysis, totalValue, totalCost) {
      let score = 60;
      const checks = [];
      const suggestions = [];
      
      const count = analysis.length;
      const totalProfit = totalCost > 0 ? ((totalValue - totalCost) / totalCost * 100) : 0;
      
      // 1. é¢¨éšªåˆ†æ•£
      if (count >= 5) {
        score += 15;
        checks.push({ name: 'ğŸ“Š é¢¨éšªåˆ†æ•£', status: 'good', desc: `æŒæœ‰ ${count} æª”è‚¡ç¥¨ï¼Œåˆ†æ•£åº¦è‰¯å¥½ã€‚` });
      } else if (count >= 3) {
        score += 8;
        checks.push({ name: 'ğŸ“Š é¢¨éšªåˆ†æ•£', status: 'warn', desc: `æŒæœ‰ ${count} æª”è‚¡ç¥¨ï¼Œå»ºè­°å¢åŠ åˆ†æ•£ã€‚` });
        suggestions.push('è€ƒæ…®å¢åŠ æŒè‚¡æ•¸é‡ä»¥åˆ†æ•£é¢¨éšª');
      } else {
        checks.push({ name: 'ğŸ“Š é¢¨éšªåˆ†æ•£', status: 'bad', desc: `åƒ…æŒæœ‰ ${count} æª”è‚¡ç¥¨ï¼Œé›†ä¸­åº¦é«˜ã€‚` });
        suggestions.push('æŒè‚¡éæ–¼é›†ä¸­ï¼Œå»ºè­°åˆ†æ•£æŠ•è³‡');
      }
      
      // 2. æ³¢æµªä½ç½®
      const upWaves = analysis.filter(a => ['1', '2', '3', 1, 2, 3].includes(a.currentWave)).length;
      const upRatio = upWaves / count;
      
      if (upRatio >= 0.6) {
        score += 15;
        checks.push({ name: 'ğŸŒŠ æ³¢æµªä½ç½®', status: 'good', desc: `${(upRatio * 100).toFixed(0)}% æŒè‚¡è™•æ–¼ä¸Šå‡æµªã€‚` });
      } else if (upRatio >= 0.4) {
        score += 8;
        checks.push({ name: 'ğŸŒŠ æ³¢æµªä½ç½®', status: 'warn', desc: `${(upRatio * 100).toFixed(0)}% æŒè‚¡è™•æ–¼ä¸Šå‡æµªã€‚` });
        suggestions.push('éƒ¨åˆ†æŒè‚¡æ³¢æµªä½ç½®è¼ƒé«˜ï¼Œæ³¨æ„ç²åˆ©äº†çµ');
      } else {
        checks.push({ name: 'ğŸŒŠ æ³¢æµªä½ç½®', status: 'bad', desc: `åƒ… ${(upRatio * 100).toFixed(0)}% æŒè‚¡è™•æ–¼ä¸Šå‡æµªã€‚` });
        suggestions.push('å¤šæ•¸æŒè‚¡è™•æ–¼ä¿®æ­£æµªï¼Œå»ºè­°æ¸›ç¢¼è§€æœ›');
      }
      
      // 3. ç²åˆ©ç‹€æ³
      if (totalProfit > 10) {
        score += 15;
        checks.push({ name: 'ğŸ’° ç²åˆ©è¡¨ç¾', status: 'good', desc: `æ•´é«”å ±é…¬ç‡ ${totalProfit.toFixed(1)}%ï¼Œè¡¨ç¾å„ªç•°ï¼` });
      } else if (totalProfit > 0) {
        score += 8;
        checks.push({ name: 'ğŸ’° ç²åˆ©è¡¨ç¾', status: 'warn', desc: `æ•´é«”å ±é…¬ç‡ ${totalProfit.toFixed(1)}%ã€‚` });
      } else {
        checks.push({ name: 'ğŸ’° ç²åˆ©è¡¨ç¾', status: 'bad', desc: `æ•´é«”å ±é…¬ç‡ ${totalProfit.toFixed(1)}%ï¼Œè™•æ–¼è™§æã€‚` });
        suggestions.push('æ•´é«”è™•æ–¼è™§æï¼Œå»ºè­°æª¢è¦–æŒè‚¡åŸºæœ¬é¢');
      }
      
      // 4. ä»Šæ—¥æ¼²è·Œ
      const upToday = analysis.filter(a => a.changePercent > 0).length;
      const downToday = analysis.filter(a => a.changePercent < 0).length;
      
      if (upToday > downToday) {
        score += 5;
        checks.push({ name: 'ğŸ“ˆ ä»Šæ—¥è¡¨ç¾', status: 'good', desc: `ä»Šæ—¥ ${upToday} æ¼² ${downToday} è·Œã€‚` });
      } else {
        checks.push({ name: 'ğŸ“ˆ ä»Šæ—¥è¡¨ç¾', status: downToday > upToday ? 'bad' : 'warn', desc: `ä»Šæ—¥ ${upToday} æ¼² ${downToday} è·Œã€‚` });
      }
      
      score = Math.max(0, Math.min(100, score));
      return { score, checks, suggestions };
    }
    
    function renderReport(analysis, report, totalLots, totalOddShares, totalValue, totalCost) {
      const { score, checks, suggestions } = report;
      const totalProfit = totalCost > 0 ? ((totalValue - totalCost) / totalCost * 100) : 0;
      
      let grade, gradeText, cardClass;
      if (score >= 85) { grade = 'â­â­â­â­â­'; gradeText = 'å„ªç§€'; cardClass = 'excellent'; }
      else if (score >= 70) { grade = 'â­â­â­â­'; gradeText = 'è‰¯å¥½'; cardClass = 'good'; }
      else if (score >= 50) { grade = 'â­â­â­'; gradeText = 'æ™®é€š'; cardClass = 'fair'; }
      else { grade = 'â­â­'; gradeText = 'å¾…æ”¹å–„'; cardClass = 'poor'; }
      
      // æ ¼å¼åŒ–å¼µæ•¸
      const sharesDisplay = totalLots > 0 && totalOddShares > 0 ? `${totalLots} å¼µ ${totalOddShares} è‚¡` :
                           totalLots > 0 ? `${totalLots} å¼µ` : `${totalOddShares} è‚¡`;
      
      document.getElementById('content').innerHTML = `
        <div class="score-card ${cardClass}">
          <div class="title">æŠ•è³‡çµ„åˆå¥åº·åˆ†æ•¸</div>
          <div class="score">${score}</div>
          <div class="grade">${gradeText} ${grade}</div>
        </div>
        
        <div class="summary-bar">
          <div class="summary-item">
            <div class="label">æŒè‚¡æª”æ•¸</div>
            <div class="value" style="color:#58a6ff;">${analysis.length} æª”</div>
          </div>
          <div class="summary-item">
            <div class="label">ç¸½è‚¡æ•¸</div>
            <div class="value" style="color:#c9d1d9;">${sharesDisplay}</div>
          </div>
          <div class="summary-item">
            <div class="label">å¸‚å€¼</div>
            <div class="value" style="color:#d29922;">$${Math.round(totalValue).toLocaleString()}</div>
          </div>
          <div class="summary-item">
            <div class="label">ç¸½å ±é…¬</div>
            <div class="value" style="color:${totalProfit >= 0 ? '#f85149' : '#3fb950'};">${totalProfit >= 0 ? '+' : ''}${totalProfit.toFixed(1)}%</div>
          </div>
        </div>
        
        <div class="check-grid">
          ${checks.map(c => `
            <div class="check-item">
              <div class="item-header">
                <span class="name">${c.name}</span>
                <span class="status ${c.status}">${c.status === 'good' ? 'è‰¯å¥½' : c.status === 'warn' ? 'æ³¨æ„' : 'è­¦å‘Š'}</span>
              </div>
              <div class="desc">${c.desc}</div>
            </div>
          `).join('')}
        </div>
        
        <div class="holdings-table">
          <h3>ğŸ“‹ æŒè‚¡æ˜ç´°</h3>
          <table>
            <thead>
              <tr><th>è‚¡ç¥¨</th><th>è‚¡æ•¸</th><th>æˆæœ¬</th><th>ç¾åƒ¹</th><th>ä»Šæ—¥</th><th>æ³¢æµª</th><th>å ±é…¬</th></tr>
            </thead>
            <tbody>
              ${analysis.map(a => {
                const sharesText = a.lots > 0 && a.oddShares > 0 ? `${a.lots}å¼µ${a.oddShares}è‚¡` :
                                  a.lots > 0 ? `${a.lots}å¼µ` : `${a.oddShares}è‚¡`;
                return `
                  <tr>
                    <td><a href="wave.html?stock=${a.stockId}">${a.stockId} ${a.stockName}</a></td>
                    <td>${sharesText}</td>
                    <td>$${a.costPrice > 0 ? a.costPrice.toFixed(2) : '-'}</td>
                    <td>$${a.currentPrice.toFixed(2)}</td>
                    <td style="color:${a.changePercent >= 0 ? '#f85149' : '#3fb950'};">${a.changePercent >= 0 ? '+' : ''}${a.changePercent.toFixed(2)}%</td>
                    <td>${a.currentWave}</td>
                    <td style="color:${a.profit >= 0 ? '#f85149' : '#3fb950'};">${a.costPrice > 0 ? (a.profit >= 0 ? '+' : '') + a.profit.toFixed(1) + '%' : '-'}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
        
        ${suggestions.length > 0 ? `
          <div class="suggestion">
            <h4>ğŸ’¡ æ”¹å–„å»ºè­°</h4>
            <ul>${suggestions.map(s => `<li>${s}</li>`).join('')}</ul>
          </div>
        ` : ''}
      `;
    }
    
    runHealthCheck();
  </script>
</body>
</html>
