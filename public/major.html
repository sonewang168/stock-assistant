<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ  ä¸»åŠ›è¿½è¹¤ - è‚¡æµ·ç§˜æ›¸</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Noto Sans TC', sans-serif; }
    body { background: #0d1117; min-height: 100vh; color: #e6edf3; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .header { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; background: #161b22; border-radius: 12px; margin-bottom: 20px; border: 1px solid #30363d; }
    .header h1 { font-size: 1.4rem; color: #d29922; }
    .search-box { display: flex; gap: 10px; }
    .search-box input { padding: 10px 16px; border-radius: 8px; border: 1px solid #30363d; background: #0d1117; color: #e6edf3; width: 120px; }
    .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; background: #d29922; color: white; }
    .back-link { color: #58a6ff; text-decoration: none; font-size: 0.9rem; }
    
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px; }
    .summary-card { background: #161b22; border: 1px solid #30363d; border-radius: 12px; padding: 20px; text-align: center; }
    .summary-card .label { color: #8b949e; font-size: 0.85rem; }
    .summary-card .value { font-size: 1.8rem; font-weight: 700; margin-top: 8px; }
    .summary-card .sub { font-size: 0.85rem; color: #8b949e; margin-top: 4px; }
    
    .main-card { background: #161b22; border-radius: 12px; border: 1px solid #30363d; padding: 20px; margin-bottom: 20px; }
    .card-title { color: #c9d1d9; margin-bottom: 16px; }
    .chart-container { height: 250px; }
    
    .broker-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    .broker-table th, .broker-table td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #21262d; }
    .broker-table th { color: #8b949e; font-weight: 600; background: #21262d; }
    .broker-table .buy { color: #f85149; }
    .broker-table .sell { color: #3fb950; }
    
    .analysis-box { background: #21262d; border-radius: 8px; padding: 16px; margin-top: 20px; }
    .analysis-box h4 { color: #d29922; margin-bottom: 8px; }
    .analysis-box p { color: #c9d1d9; line-height: 1.6; }
    
    .loading { text-align: center; padding: 40px; color: #8b949e; }
    .spinner { width: 40px; height: 40px; border: 3px solid #30363d; border-top-color: #d29922; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div><a href="analysis.html" class="back-link">â† è¿”å›åˆ†æä¸­å¿ƒ</a><h1>ğŸ  ä¸»åŠ›è¿½è¹¤</h1></div>
      <div class="search-box">
        <input type="text" id="stockInput" placeholder="è‚¡ç¥¨ä»£ç¢¼" value="2330">
        <button class="btn" onclick="analyze()">ğŸ” è¿½è¹¤</button>
      </div>
    </header>
    <div id="content"><div class="loading"><div class="spinner"></div><p>è¼‰å…¥ä¸»åŠ›è³‡æ–™...</p></div></div>
  </div>
  <script>
    async function analyze() {
      const stockId = document.getElementById('stockInput').value.trim();
      if (!stockId) return alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼');
      document.getElementById('content').innerHTML = '<div class="loading"><div class="spinner"></div><p>åˆ†æä¸»åŠ›å‹•å‘...</p></div>';
      
      try {
        const res = await fetch(`/api/line/wave/analyze/${stockId}`);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        renderAnalysis(stockId, data);
      } catch (e) {
        document.getElementById('content').innerHTML = `<div class="main-card"><p style="color:#f85149;">åˆ†æå¤±æ•—: ${e.message}</p></div>`;
      }
    }
    
    function renderAnalysis(stockId, data) {
      const { stockName, currentPrice, changePercent } = data;
      
      // æ¨¡æ“¬ä¸»åŠ›è³‡æ–™
      const majorBuy = Math.floor(Math.random() * 5000) + 1000;
      const majorSell = Math.floor(Math.random() * 4000) + 500;
      const netBuy = majorBuy - majorSell;
      const concentration = (Math.random() * 20 + 30).toFixed(1);
      
      const brokers = [
        { name: 'å…ƒå¤§-å°åŒ—', buy: Math.floor(Math.random() * 2000), sell: Math.floor(Math.random() * 1000) },
        { name: 'å‡±åŸº-å°åŒ—', buy: Math.floor(Math.random() * 1500), sell: Math.floor(Math.random() * 800) },
        { name: 'å¯Œé‚¦-å°åŒ—', buy: Math.floor(Math.random() * 1200), sell: Math.floor(Math.random() * 1500) },
        { name: 'æ°¸è±é‡‘-å°åŒ—', buy: Math.floor(Math.random() * 1000), sell: Math.floor(Math.random() * 600) },
        { name: 'åœ‹æ³°-å°åŒ—', buy: Math.floor(Math.random() * 800), sell: Math.floor(Math.random() * 1200) }
      ].map(b => ({ ...b, net: b.buy - b.sell })).sort((a, b) => b.net - a.net);
      
      const dayData = Array.from({length: 20}, () => (Math.random() - 0.4) * 2000);
      
      document.getElementById('content').innerHTML = `
        <div class="summary-grid">
          <div class="summary-card">
            <div class="label">${stockName} (${stockId})</div>
            <div class="value" style="color:#58a6ff;">$${currentPrice.toFixed(2)}</div>
            <div class="sub" style="color:${changePercent >= 0 ? '#f85149' : '#3fb950'};">${changePercent >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(changePercent).toFixed(2)}%</div>
          </div>
          <div class="summary-card">
            <div class="label">ä¸»åŠ›è²·è¶…</div>
            <div class="value" style="color:#f85149;">+${majorBuy.toLocaleString()}</div>
            <div class="sub">å¼µ</div>
          </div>
          <div class="summary-card">
            <div class="label">ä¸»åŠ›è³£è¶…</div>
            <div class="value" style="color:#3fb950;">-${majorSell.toLocaleString()}</div>
            <div class="sub">å¼µ</div>
          </div>
          <div class="summary-card">
            <div class="label">æ·¨è²·è¶…</div>
            <div class="value" style="color:${netBuy >= 0 ? '#f85149' : '#3fb950'};">${netBuy >= 0 ? '+' : ''}${netBuy.toLocaleString()}</div>
            <div class="sub">å¼µ</div>
          </div>
          <div class="summary-card">
            <div class="label">ç±Œç¢¼é›†ä¸­åº¦</div>
            <div class="value" style="color:#d29922;">${concentration}%</div>
            <div class="sub">å‰15å¤§åˆ¸å•†</div>
          </div>
        </div>
        
        <div class="main-card">
          <div class="card-title">ğŸ“Š è¿‘20æ—¥ä¸»åŠ›è²·è³£è¶…</div>
          <div class="chart-container"><canvas id="majorChart"></canvas></div>
        </div>
        
        <div class="main-card">
          <div class="card-title">ğŸ¦ åˆ¸å•†è²·è³£æ˜ç´°ï¼ˆä»Šæ—¥ï¼‰</div>
          <table class="broker-table">
            <thead><tr><th>åˆ¸å•†</th><th>è²·é€²</th><th>è³£å‡º</th><th>æ·¨è²·è³£</th></tr></thead>
            <tbody>
              ${brokers.map(b => `
                <tr>
                  <td>${b.name}</td>
                  <td class="buy">${b.buy.toLocaleString()}</td>
                  <td class="sell">${b.sell.toLocaleString()}</td>
                  <td class="${b.net >= 0 ? 'buy' : 'sell'}">${b.net >= 0 ? '+' : ''}${b.net.toLocaleString()}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        
        <div class="analysis-box">
          <h4>ğŸ’¡ ä¸»åŠ›å‹•å‘åˆ†æ</h4>
          <p>${netBuy > 1000 ? 'ğŸ”¥ ä¸»åŠ›é€£çºŒè²·è¶…ï¼Œç±Œç¢¼é›†ä¸­ï¼Œå¾Œå¸‚çœ‹å¥½ã€‚å»ºè­°é—œæ³¨æ˜¯å¦çªç ´å£“åŠ›ã€‚' : 
              netBuy < -1000 ? 'âš ï¸ ä¸»åŠ›é€£çºŒè³£è¶…ï¼Œç±Œç¢¼é¬†å‹•ï¼Œéœ€æ³¨æ„å›æª”é¢¨éšªã€‚' : 
              'ğŸ“Š ä¸»åŠ›è²·è³£äº’è¦‹ï¼Œç±Œç¢¼é¢ä¸­æ€§ï¼Œå»ºè­°è§€å¯Ÿå¾ŒçºŒå‹•å‘ã€‚'}</p>
        </div>
      `;
      
      // ç¹ªè£½åœ–è¡¨
      new Chart(document.getElementById('majorChart'), {
        type: 'bar',
        data: {
          labels: dayData.map((_, i) => `${20-i}æ—¥å‰`).reverse(),
          datasets: [{ data: dayData, backgroundColor: dayData.map(d => d >= 0 ? '#f8514988' : '#3fb95088') }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { color: '#21262d' }, ticks: { color: '#8b949e', maxTicksLimit: 10 } },
            y: { grid: { color: '#21262d' }, ticks: { color: '#8b949e' } }
          }
        }
      });
    }
    
    const urlParams = new URLSearchParams(window.location.search);
    document.getElementById('stockInput').value = urlParams.get('stock') || '2330';
    analyze();
  </script>
</body>
</html>
