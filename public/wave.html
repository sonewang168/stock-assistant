<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸŒŠ è‰¾ç•¥ç‰¹æ³¢æµªç†è«–åˆ†æ - è‚¡æµ·ç§˜æ›¸</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Noto Sans TC', sans-serif; }
    body { background: #0d1117; min-height: 100vh; color: #E2E8F0; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    
    /* Header */
    .header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px 24px; background: #161b22; border-radius: 12px;
      margin-bottom: 20px; border: 1px solid #30363d;
    }
    .header h1 { font-size: 1.4rem; display: flex; align-items: center; gap: 10px; }
    .header h1 span { color: #58a6ff; }
    .search-box { display: flex; gap: 10px; }
    .search-box input {
      padding: 10px 16px; border-radius: 8px; border: 1px solid #30363d;
      background: #0d1117; color: #E2E8F0; width: 120px; font-size: 1rem;
    }
    .search-box input:focus { outline: none; border-color: #58a6ff; }
    .btn {
      padding: 10px 20px; border-radius: 8px; border: none;
      font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 0.9rem;
    }
    .btn-primary { background: #238636; color: white; }
    .btn-primary:hover { background: #2ea043; }
    
    /* Tabs */
    .tabs { display: flex; gap: 4px; margin-bottom: 20px; background: #161b22; padding: 4px; border-radius: 8px; width: fit-content; }
    .tab {
      padding: 10px 20px; border-radius: 6px; background: transparent;
      color: #8b949e; cursor: pointer; font-weight: 500; transition: all 0.2s; border: none;
    }
    .tab.active { background: #238636; color: white; }
    .tab:hover:not(.active) { color: #c9d1d9; }
    
    /* Main Card */
    .main-card {
      background: #161b22; border-radius: 12px; border: 1px solid #30363d;
      overflow: hidden;
    }
    .card-header {
      padding: 16px 20px; background: #21262d; border-bottom: 1px solid #30363d;
      display: flex; justify-content: space-between; align-items: center;
    }
    .card-header h2 { font-size: 1.1rem; color: #c9d1d9; }
    .card-body { padding: 24px; }
    
    /* Wave Analysis Box */
    .wave-analysis-box {
      background: #0d1117; border: 1px solid #30363d; border-radius: 12px;
      padding: 24px; margin-bottom: 24px;
    }
    .wave-analysis-title {
      display: flex; align-items: center; gap: 8px; margin-bottom: 20px;
      font-size: 1rem; color: #c9d1d9;
    }
    
    /* Wave Circles */
    .wave-circles {
      display: flex; justify-content: center; gap: 8px; margin-bottom: 24px;
    }
    .wave-circle {
      width: 44px; height: 44px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 1rem; cursor: pointer;
      transition: all 0.2s; position: relative;
    }
    /* æ¨å‹•æµª 1,3,5 = ç¶ è‰² */
    .wave-circle.w1, .wave-circle.w3, .wave-circle.w5 { background: #238636; color: white; }
    /* ä¿®æ­£æµª 2,4 = è—è‰² */
    .wave-circle.w2, .wave-circle.w4 { background: #1f6feb; color: white; }
    /* A,C æµª = ç´…è‰² */
    .wave-circle.wA, .wave-circle.wC { background: #da3633; color: white; }
    /* B æµª = æ©˜è‰² */
    .wave-circle.wB { background: #d29922; color: white; }
    /* ç•¶å‰æ³¢æµª */
    .wave-circle.active {
      box-shadow: 0 0 0 3px #58a6ff;
      transform: scale(1.15);
    }
    
    /* Current Wave Display */
    .current-wave-display { text-align: center; margin-bottom: 16px; }
    .current-wave-display .label { color: #8b949e; font-size: 1rem; }
    .current-wave-display .wave-number {
      font-size: 2.5rem; font-weight: 700; color: #58a6ff; margin: 0 8px;
    }
    .current-wave-display .wave-label { font-size: 1.2rem; color: #c9d1d9; }
    
    /* Trend Info */
    .trend-info {
      display: flex; justify-content: center; align-items: center; gap: 16px;
      font-size: 0.95rem; color: #8b949e; flex-wrap: wrap;
    }
    .trend-info .up { color: #f85149; }
    .trend-info .down { color: #3fb950; }
    .trend-info .separator { color: #30363d; }
    .from-wave-badge {
      padding: 4px 10px; border-radius: 4px; font-size: 0.85rem; font-weight: 500;
    }
    .from-wave-badge.up { background: rgba(248, 81, 73, 0.15); color: #f85149; }
    .from-wave-badge.down { background: rgba(63, 185, 80, 0.15); color: #3fb950; }
    
    /* Three Columns */
    .three-columns {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 24px;
    }
    .column-card {
      background: #0d1117; border: 1px solid #30363d; border-radius: 10px; overflow: hidden;
    }
    .column-header {
      padding: 12px 16px; background: #21262d; border-bottom: 1px solid #30363d;
      font-size: 0.9rem; font-weight: 600; color: #c9d1d9;
    }
    .column-body { padding: 16px; }
    
    /* Rule Check */
    .rule-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px; margin-bottom: 8px;
      background: #161b22; border-radius: 6px;
      border-left: 3px solid;
    }
    .rule-item.pass { border-color: #3fb950; }
    .rule-item.fail { border-color: #f85149; }
    .rule-icon { font-size: 1.1rem; }
    .rule-text { font-size: 0.85rem; color: #c9d1d9; }
    
    /* Wave History */
    .wave-history-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 12px; margin-bottom: 6px;
      background: #161b22; border-radius: 6px; font-size: 0.85rem;
    }
    .wave-history-item .wave-name { color: #c9d1d9; font-weight: 500; }
    .wave-history-item .wave-type { color: #8b949e; font-size: 0.75rem; }
    .wave-history-item .wave-price { font-weight: 600; }
    .wave-history-item .wave-price.up { color: #f85149; }
    .wave-history-item .wave-price.down { color: #3fb950; }
    .wave-history-item.current { background: rgba(88, 166, 255, 0.15); border: 1px solid rgba(88, 166, 255, 0.3); }
    
    /* Suggestion Box */
    .suggestion-box {
      background: rgba(35, 134, 54, 0.1); border: 1px solid rgba(35, 134, 54, 0.3);
      border-radius: 8px; padding: 14px; margin-bottom: 16px;
    }
    .suggestion-box p { color: #c9d1d9; font-size: 0.9rem; line-height: 1.5; }
    
    /* Targets */
    .targets-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .target-box { padding: 12px; border-radius: 8px; text-align: center; }
    .target-box.up { background: rgba(248, 81, 73, 0.1); border: 1px solid rgba(248, 81, 73, 0.3); }
    .target-box.down { background: rgba(63, 185, 80, 0.1); border: 1px solid rgba(63, 185, 80, 0.3); }
    .target-box .label { font-size: 0.75rem; color: #8b949e; margin-bottom: 4px; }
    .target-box .value { font-size: 1.2rem; font-weight: 700; }
    .target-box.up .value { color: #f85149; }
    .target-box.down .value { color: #3fb950; }
    
    /* Chart */
    .chart-section { margin-bottom: 24px; }
    .chart-container { height: 320px; position: relative; }
    .chart-legend {
      display: flex; gap: 16px; justify-content: center; margin-top: 10px; flex-wrap: wrap;
    }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; color: #8b949e; }
    .legend-dot { width: 12px; height: 12px; border-radius: 50%; }
    
    /* Recent Data Table */
    .data-table { width: 100%; font-size: 0.8rem; border-collapse: collapse; }
    .data-table th { text-align: left; padding: 8px; color: #8b949e; border-bottom: 1px solid #30363d; }
    .data-table td { padding: 8px; border-bottom: 1px solid #21262d; }
    .data-table tr.up td { color: #f85149; }
    .data-table tr.down td { color: #3fb950; }
    
    /* Fibonacci */
    .fib-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 12px; margin-bottom: 4px; border-radius: 6px;
      background: #161b22; border-left: 3px solid;
    }
    .fib-ratio { font-weight: 600; }
    .fib-price { color: #c9d1d9; }
    
    /* Portfolio Tab */
    .portfolio-controls {
      display: flex; gap: 12px; align-items: center; flex-wrap: wrap;
      padding: 16px; background: #0d1117; border-radius: 8px; margin-bottom: 20px;
    }
    .portfolio-controls input {
      padding: 8px 12px; border-radius: 6px; border: 1px solid #30363d;
      background: #161b22; color: #c9d1d9; font-size: 0.9rem;
    }
    .budget-btns { display: flex; gap: 6px; }
    .budget-btn {
      padding: 6px 12px; border-radius: 6px; border: 1px solid #30363d;
      background: transparent; color: #8b949e; cursor: pointer; font-size: 0.8rem;
    }
    .budget-btn:hover, .budget-btn.active { background: #238636; color: white; border-color: #238636; }
    
    /* Summary Grid */
    .summary-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 20px; }
    .summary-card {
      background: #0d1117; border: 1px solid #30363d; border-radius: 8px;
      padding: 14px; text-align: center;
    }
    .summary-card .label { color: #8b949e; font-size: 0.75rem; margin-bottom: 4px; }
    .summary-card .value { font-size: 1.1rem; font-weight: 700; }
    
    /* Stock List */
    .stock-header {
      display: grid; grid-template-columns: 130px 1fr 100px 70px 70px 50px;
      gap: 12px; padding: 10px 14px; color: #8b949e; font-size: 0.8rem; font-weight: 600;
    }
    .stock-item {
      display: grid; grid-template-columns: 130px 1fr 100px 70px 70px 50px;
      gap: 12px; align-items: center; padding: 12px 14px;
      background: #0d1117; border: 1px solid #30363d; border-radius: 8px; margin-bottom: 8px;
    }
    .stock-item:hover { border-color: #58a6ff; }
    .stock-item .name { font-weight: 600; color: #c9d1d9; }
    .stock-item .sector { font-size: 0.8rem; color: #8b949e; }
    .stock-item .amount { color: #3fb950; font-weight: 600; }
    .stock-item input {
      width: 55px; padding: 6px; border-radius: 4px; border: 1px solid #30363d;
      background: #161b22; color: #c9d1d9; text-align: center; font-size: 0.85rem;
    }
    .wave-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
    .delete-btn {
      background: rgba(248, 81, 73, 0.15); color: #f85149; border: none;
      padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;
    }
    
    /* Add Form */
    .add-form {
      display: flex; gap: 8px; align-items: center; padding: 14px;
      background: rgba(35, 134, 54, 0.1); border: 1px solid rgba(35, 134, 54, 0.3);
      border-radius: 8px; margin-top: 12px;
    }
    .add-form input { flex: 1; min-width: 60px; }
    
    /* Risk Section */
    .risk-section { margin-top: 24px; padding: 20px; background: #0d1117; border: 1px solid #30363d; border-radius: 8px; }
    .risk-bar-bg {
      height: 12px; background: linear-gradient(90deg, #3fb950 0%, #d29922 50%, #f85149 100%);
      border-radius: 6px; position: relative; margin: 16px 0;
    }
    .risk-indicator {
      position: absolute; top: -6px; width: 24px; height: 24px;
      background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 0.65rem; font-weight: 700; color: #0d1117; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      transform: translateX(-50%); transition: left 0.5s;
    }
    .risk-labels { display: flex; justify-content: space-between; font-size: 0.75rem; color: #8b949e; }
    .risk-comment { margin-top: 14px; padding: 12px; background: #161b22; border-radius: 6px; font-size: 0.85rem; color: #c9d1d9; line-height: 1.5; }
    
    /* Sector Bars */
    .sector-section { margin-top: 24px; }
    .sector-row { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
    .sector-row .name { width: 70px; font-size: 0.85rem; color: #8b949e; }
    .sector-row .bar-bg { flex: 1; height: 18px; background: #21262d; border-radius: 4px; overflow: hidden; }
    .sector-row .bar-fill {
      height: 100%; display: flex; align-items: center; justify-content: flex-end;
      padding-right: 8px; transition: width 0.5s;
    }
    .sector-row .bar-fill span { color: white; font-size: 0.7rem; font-weight: 600; }
    
    /* Responsive */
    @media (max-width: 1024px) {
      .three-columns { grid-template-columns: 1fr; }
      .summary-grid { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 768px) {
      .header { flex-direction: column; gap: 12px; }
      .stock-header, .stock-item { grid-template-columns: 1fr 1fr; }
      .summary-grid { grid-template-columns: repeat(2, 1fr); }
    }
    
    .hidden { display: none !important; }
    .loading { text-align: center; padding: 30px; color: #8b949e; }
    .spinner {
      width: 32px; height: 32px; border: 3px solid #30363d; border-top-color: #58a6ff;
      border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <h1>ğŸŒŠ <span>è‰¾ç•¥ç‰¹æ³¢æµªç†è«–åˆ†æ</span></h1>
      <div class="search-box">
        <input type="text" id="stockInput" placeholder="è‚¡ç¥¨ä»£ç¢¼" value="2330" />
        <button class="btn btn-primary" onclick="analyzeStock()">ğŸ” åˆ†ææ³¢æµª</button>
      </div>
    </header>
    
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="showTab('wave')">ğŸŒŠ æ³¢æµªåˆ†æ</button>
      <button class="tab" onclick="showTab('portfolio')">ğŸ’¼ æŠ•è³‡çµ„åˆ</button>
    </div>

    <!-- Wave Tab -->
    <div id="waveTab">
      <div class="main-card">
        <div class="card-header">
          <h2>ğŸ“ˆ <span id="stockName">è¼‰å…¥ä¸­...</span> (<span id="stockId">----</span>)</h2>
          <span id="confidenceBadge" style="padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; background: rgba(210, 153, 34, 0.2); color: #d29922;">ä¿¡å¿ƒ: --</span>
        </div>
        <div class="card-body">
          <!-- Chart with Wave Labels -->
          <div class="chart-section">
            <div class="chart-container"><canvas id="priceChart"></canvas></div>
            <div class="chart-legend">
              <div class="legend-item"><div class="legend-dot" style="background:#238636;"></div>æ¨å‹•æµª (1,3,5)</div>
              <div class="legend-item"><div class="legend-dot" style="background:#1f6feb;"></div>ä¿®æ­£æµª (2,4)</div>
              <div class="legend-item"><div class="legend-dot" style="background:#da3633;"></div>ä¸‹è·Œæµª (A,C)</div>
              <div class="legend-item"><div class="legend-dot" style="background:#d29922;"></div>åå½ˆæµª (B)</div>
            </div>
          </div>
          
          <!-- Wave Analysis Box -->
          <div class="wave-analysis-box">
            <div class="wave-analysis-title">ğŸŒŠ è‰¾ç•¥ç‰¹æ³¢æµªåˆ†æ</div>
            
            <!-- Wave Circles (1-5, A-B-C) -->
            <div class="wave-circles" id="waveCircles">
              <div class="wave-circle w1">1</div>
              <div class="wave-circle w2">2</div>
              <div class="wave-circle w3">3</div>
              <div class="wave-circle w4">4</div>
              <div class="wave-circle w5">5</div>
              <div class="wave-circle wA">A</div>
              <div class="wave-circle wB">B</div>
              <div class="wave-circle wC">C</div>
            </div>
            
            <!-- Current Wave -->
            <div class="current-wave-display">
              <span class="label">ç›®å‰æ¨æ¸¬ä½æ–¼</span>
              <span class="wave-label">ç¬¬</span>
              <span class="wave-number" id="currentWave">--</span>
              <span class="wave-label">æµª</span>
            </div>
            
            <!-- Trend Info -->
            <div class="trend-info">
              <span id="trendText">--</span>
              <span class="separator">|</span>
              <span>ç¾åƒ¹: <strong id="currentPrice">--</strong></span>
              <span id="changePercent">--</span>
              <span id="fromWaveText" class="from-wave-badge up">è‡ªä¸Šæµª --</span>
            </div>
          </div>
          
          <!-- Three Columns -->
          <div class="three-columns">
            <!-- Rules Check -->
            <div class="column-card">
              <div class="column-header">ğŸ“‹ æ³¢æµªè¦å‰‡æª¢æŸ¥</div>
              <div class="column-body" id="rulesContainer">
                <div class="loading"><div class="spinner"></div></div>
              </div>
            </div>
            
            <!-- Wave History -->
            <div class="column-card">
              <div class="column-header">ğŸ“Š è¿‘æœŸæ³¢æµª</div>
              <div class="column-body" id="waveHistoryContainer">
                <div class="loading"><div class="spinner"></div></div>
              </div>
            </div>
            
            <!-- Suggestion -->
            <div class="column-card">
              <div class="column-header">ğŸ’¡ æ“ä½œå»ºè­°</div>
              <div class="column-body">
                <div class="suggestion-box">
                  <p id="suggestionText">è¼‰å…¥ä¸­...</p>
                </div>
                <div class="targets-row">
                  <div class="target-box up">
                    <div class="label">ğŸ¯ ç›®æ¨™ä¸Šæª”</div>
                    <div class="value" id="targetUp">--</div>
                  </div>
                  <div class="target-box down">
                    <div class="label">ğŸ›¡ï¸ æ”¯æ’ä¸‹æª”</div>
                    <div class="value" id="targetDown">--</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Bottom Row -->
          <div class="three-columns" style="grid-template-columns: 1fr 1fr; margin-top: 16px;">
            <div class="column-card">
              <div class="column-header">ğŸ“… æœ€è¿‘äº¤æ˜“æ—¥æ•¸æ“š</div>
              <div class="column-body" id="recentDataContainer">
                <div class="loading"><div class="spinner"></div></div>
              </div>
            </div>
            <div class="column-card">
              <div class="column-header">ğŸ“ æ–æ³¢é‚£å¥‘æ¯”ä¾‹</div>
              <div class="column-body" id="fibContainer">
                <div class="loading"><div class="spinner"></div></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Portfolio Tab -->
    <div id="portfolioTab" class="hidden">
      <div class="main-card">
        <div class="card-header"><h2>ğŸ’¼ è‡ªè¨‚æŠ•è³‡çµ„åˆ</h2></div>
        <div class="card-body">
          <!-- Controls -->
          <div class="portfolio-controls">
            <span style="color: #8b949e;">é ç®—ï¼š</span>
            <input type="number" id="budgetInput" value="60" style="width: 80px;" />
            <span style="color: #8b949e;">è¬å…ƒ</span>
            <div class="budget-btns">
              <button class="budget-btn" onclick="setBudget(30)">30è¬</button>
              <button class="budget-btn" onclick="setBudget(50)">50è¬</button>
              <button class="budget-btn active" onclick="setBudget(60)">60è¬</button>
              <button class="budget-btn" onclick="setBudget(100)">100è¬</button>
              <button class="budget-btn" onclick="setBudget(200)">200è¬</button>
            </div>
            <button class="btn btn-primary" onclick="renderPortfolio()" style="margin-left: auto;">ğŸ”„ é‡æ–°è¨ˆç®—</button>
          </div>
          
          <!-- Summary -->
          <div class="summary-grid">
            <div class="summary-card">
              <div class="label">ç¸½é ç®—</div>
              <div class="value" style="color: #c9d1d9;" id="sumBudget">$600,000</div>
            </div>
            <div class="summary-card">
              <div class="label">è‚¡ç¥¨é…ç½®</div>
              <div class="value" style="color: #3fb950;" id="sumStock">$552,000</div>
            </div>
            <div class="summary-card">
              <div class="label">ç¾é‡‘ä¿ç•™</div>
              <div class="value" style="color: #d29922;" id="sumCash">$48,000</div>
            </div>
            <div class="summary-card">
              <div class="label">é¢¨éšªåˆ†æ•¸</div>
              <div class="value" style="color: #58a6ff;" id="sumRiskScore">45</div>
            </div>
            <div class="summary-card">
              <div class="label">é¢¨éšªç­‰ç´š</div>
              <div class="value" id="sumRiskLevel" style="color: #3fb950;">ä½</div>
            </div>
          </div>
          
          <!-- Stock List -->
          <div class="stock-header">
            <span>è‚¡ç¥¨</span><span>é¡è‚¡/åŸå› </span><span>é…ç½®é‡‘é¡</span><span>æ¯”ä¾‹</span><span>æ³¢æµª</span><span>æ“ä½œ</span>
          </div>
          <div id="stockList"></div>
          
          <!-- Add Form -->
          <div class="add-form">
            <input type="text" id="newId" placeholder="ä»£ç¢¼" style="width: 70px;" />
            <input type="text" id="newName" placeholder="åç¨±" style="width: 90px;" />
            <input type="text" id="newSector" placeholder="é¡è‚¡" style="width: 80px;" />
            <input type="number" id="newPercent" placeholder="%" style="width: 50px;" value="5" />
            <input type="text" id="newReason" placeholder="æŠ•è³‡åŸå› " />
            <button class="btn btn-primary" onclick="addStock()">â• æ–°å¢</button>
          </div>
          
          <!-- Risk Section -->
          <div class="risk-section">
            <h3 style="font-size: 0.95rem; color: #c9d1d9; margin-bottom: 8px;">ğŸ“Š é¢¨éšªè©•ä¼°</h3>
            <div class="risk-bar-bg">
              <div class="risk-indicator" id="riskIndicator" style="left: 35%;">35</div>
            </div>
            <div class="risk-labels">
              <span>ğŸŸ¢ ä½é¢¨éšª</span><span>ğŸŸ¡ ä¸­é¢¨éšª</span><span>ğŸ”´ é«˜é¢¨éšª</span>
            </div>
            <div class="risk-comment" id="riskComment">çµ„åˆé¢¨éšªè©•ä¼°ä¸­...</div>
          </div>
          
          <!-- Sector Distribution -->
          <div class="sector-section">
            <h3 style="font-size: 0.95rem; color: #c9d1d9; margin-bottom: 12px;">ğŸ“Š é¡è‚¡åˆ†æ•£</h3>
            <div id="sectorBars"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let priceChart = null;
    let currentPivots = [];
    let currentHistory = [];
    
    // æŠ•è³‡çµ„åˆ
    let portfolio = [
      { id: '2330', name: 'å°ç©é›»', sector: 'åŠå°é«”', percent: 25, wave: 3, reason: 'ä¸»å‡æ®µï¼ŒæŠ€è¡“é ˜å…ˆ' },
      { id: '2454', name: 'è¯ç™¼ç§‘', sector: 'ICè¨­è¨ˆ', percent: 12, wave: 2, reason: 'å›èª¿é€²å ´é»' },
      { id: '2881', name: 'å¯Œé‚¦é‡‘', sector: 'é‡‘è', percent: 10, wave: 1, reason: 'åˆå‡æ®µ' },
      { id: '0050', name: 'å…ƒå¤§å°ç£50', sector: 'ETF', percent: 20, wave: 3, reason: 'åˆ†æ•£é¢¨éšª' },
      { id: '00878', name: 'åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯', sector: 'ETF', percent: 15, wave: 4, reason: 'ç©©å®šé…æ¯' },
      { id: '2344', name: 'è¯é‚¦é›»', sector: 'è¨˜æ†¶é«”', percent: 10, wave: 2, reason: 'æ™¯æ°£å¾ªç’°' },
      { id: 'CASH', name: 'ç¾é‡‘ä¿ç•™', sector: 'ç¾é‡‘', percent: 8, wave: '-', reason: 'ç­‰å¾…æ™‚æ©Ÿ' }
    ];
    
    // æ³¢æµªèªªæ˜
    const waveDesc = {
      1: 'ã€ç¬¬1æµª åˆå‡æ®µã€‘è‚¡ç¥¨é¦–æ¬¡ä¸Šæ¼²ï¼Œå°‘æ•¸äººèªå‡ºã€‚ç­–ç•¥ï¼šå°é‡è©¦å–®ï¼Œè§€å¯Ÿç¢ºèªã€‚',
      2: 'ã€ç¬¬2æµª å›èª¿ã€‘ç²åˆ©äº†çµé€ æˆä¸‹è·Œï¼Œä½†ä¸è·Œç ´ç¬¬1æµªä½é»ã€‚ç­–ç•¥ï¼šç­‰å¾…å›èª¿å¾Œé€²å ´ã€‚',
      3: 'ã€ç¬¬3æµª ä¸»å‡æ®µã€‘æœ€å¼·æœ€é•·çš„ä¸€æ³¢ï¼å¸å¼•å…¬çœ¾ç›®å…‰ã€‚ç­–ç•¥ï¼šæŒè‚¡çºŒæŠ±ï¼Œå¯åŠ ç¢¼ï¼',
      4: 'ã€ç¬¬4æµª æ•´ç†ã€‘éƒ¨åˆ†ç²åˆ©äº†çµï¼Œä¸è·Œç ´ç¬¬1æµªé«˜é»ã€‚ç­–ç•¥ï¼šæŒè‚¡è§€æœ›ã€‚',
      5: 'ã€ç¬¬5æµª æœ«å‡æ®µã€‘å¸‚å ´æ¥µåº¦æ¨‚è§€ï¼ŒCEOä¸Šé›œèªŒå°é¢ã€‚ç­–ç•¥ï¼šåˆ†æ‰¹ç²åˆ©äº†çµï¼',
      A: 'ã€Aæµª ä¸‹è·Œé–‹å§‹ã€‘ä¸‹è·Œé–‹å§‹ï¼Œå¤šæ•¸äººèªç‚ºæš«æ™‚å›æª”ã€‚ç­–ç•¥ï¼šæ¸›ç¢¼æˆ–åœæï¼',
      B: 'ã€Bæµª åå½ˆé™·é˜±ã€‘å°Aæµªçš„åå½ˆï¼Œæ˜¯ã€Œå¤šé ­é™·é˜±ã€ã€‚ç­–ç•¥ï¼šä¸å®œè¿½é«˜ï¼',
      C: 'ã€Cæµª ä¸»è·Œæ®µã€‘ç ´å£åŠ›æœ€å¼·çš„ä¸‹è·Œæµªï¼Œå…¨é¢æ€§ä¸‹è·Œã€‚ç­–ç•¥ï¼šç©ºæ‰‹è§€æœ›ï¼'
    };
    
    // æ³¢æµªé¡è‰²å°æ‡‰
    const waveColors = {
      '1': '#238636', '3': '#238636', '5': '#238636',  // æ¨å‹•æµª=ç¶ 
      '2': '#1f6feb', '4': '#1f6feb',                   // ä¿®æ­£æµª=è—
      'A': '#da3633', 'C': '#da3633',                   // ä¸‹è·Œæµª=ç´…
      'B': '#d29922'                                     // åå½ˆæµª=æ©˜
    };
    
    window.onload = function() {
      const urlParams = new URLSearchParams(window.location.search);
      document.getElementById('stockInput').value = urlParams.get('stock') || '2330';
      analyzeStock();
      renderPortfolio();
    };
    
    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab')[tab === 'wave' ? 0 : 1].classList.add('active');
      document.getElementById('waveTab').classList.toggle('hidden', tab !== 'wave');
      document.getElementById('portfolioTab').classList.toggle('hidden', tab !== 'portfolio');
    }
    
    async function analyzeStock() {
      const stockId = document.getElementById('stockInput').value.trim();
      if (!stockId) return alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼');
      showLoading();
      
      try {
        const res = await fetch(`/api/line/wave/analyze/${stockId}`);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        
        // å„²å­˜æ•¸æ“šä¾›åœ–è¡¨ä½¿ç”¨
        currentPivots = data.pivots || [];
        currentHistory = data.history || [];
        
        renderAnalysis(data);
      } catch (e) {
        alert('åˆ†æå¤±æ•—: ' + e.message);
      }
    }
    
    function renderAnalysis(data) {
      document.getElementById('stockName').textContent = data.stockName || data.stockId;
      document.getElementById('stockId').textContent = data.stockId;
      document.getElementById('currentPrice').textContent = '$' + (data.currentPrice || 0).toFixed(2);
      document.getElementById('currentWave').textContent = data.currentWave || '--';
      
      // æ¼²è·Œï¼ˆå°è‚¡ï¼šæ¼²=ç´…ï¼Œè·Œ=ç¶ ï¼‰
      const change = data.changePercent || 0;
      const changeEl = document.getElementById('changePercent');
      changeEl.textContent = (change >= 0 ? 'â–²' : 'â–¼') + Math.abs(change).toFixed(2) + '%';
      changeEl.className = change >= 0 ? 'up' : 'down';
      
      // è¶¨å‹¢
      const wave = data.currentWave;
      const isUp = [1,2,3,4,5,'1','2','3','4','5'].includes(wave);
      document.getElementById('trendText').textContent = isUp ? 'ä¸Šå‡è¶¨å‹¢' : 'ä¸‹é™è¶¨å‹¢';
      document.getElementById('trendText').className = isUp ? 'up' : 'down';
      
      // è‡ªä¸Šæµªè®ŠåŒ–
      const fromWaveEl = document.getElementById('fromWaveText');
      const fromChange = data.fromWaveChange || change;
      fromWaveEl.textContent = `è‡ªä¸Šæµª ${fromChange >= 0 ? '+' : ''}${fromChange.toFixed(1)}%`;
      fromWaveEl.className = 'from-wave-badge ' + (fromChange >= 0 ? 'up' : 'down');
      
      // ä¿¡å¿ƒåˆ†æ•¸
      const conf = data.confidence || 50;
      const confEl = document.getElementById('confidenceBadge');
      confEl.textContent = `ä¿¡å¿ƒ: ${conf}%`;
      confEl.style.background = conf >= 70 ? 'rgba(63,185,80,0.2)' : conf >= 40 ? 'rgba(210,153,34,0.2)' : 'rgba(248,81,73,0.2)';
      confEl.style.color = conf >= 70 ? '#3fb950' : conf >= 40 ? '#d29922' : '#f85149';
      
      // æ³¢æµªåœ“åœˆ
      renderWaveCircles(wave);
      
      // å…¶ä»–
      document.getElementById('suggestionText').textContent = data.suggestion || 'è«‹çµåˆå…¶ä»–æŠ€è¡“æŒ‡æ¨™ç¶œåˆåˆ¤æ–·ã€‚';
      document.getElementById('targetUp').textContent = '$' + (data.targetUp || 0).toFixed(1);
      document.getElementById('targetDown').textContent = '$' + (data.targetDown || 0).toFixed(1);
      
      renderRules(data.rules);
      renderWaveHistory(data.waves, data.currentPrice, wave);
      renderFibonacci(data);
      renderRecentData(data.history);
      renderChart(data);
    }
    
    function renderWaveCircles(currentWave) {
      const waves = ['1', '2', '3', '4', '5', 'A', 'B', 'C'];
      const container = document.getElementById('waveCircles');
      
      container.innerHTML = waves.map(w => {
        const isActive = String(currentWave) === w;
        let cls = 'w' + w;
        if (w === 'A' || w === 'C') cls = 'wA';
        else if (w === 'B') cls = 'wB';
        return `<div class="wave-circle ${cls} ${isActive ? 'active' : ''}" onclick="alert('${waveDesc[w]}')">${w}</div>`;
      }).join('');
    }
    
    function renderRules(rules) {
      const r = rules || [
        { rule: 'ç¬¬2æµªä¸è·Œç ´ç¬¬1æµªèµ·é»', pass: true },
        { rule: 'ç¬¬3æµªä¸æ˜¯æœ€çŸ­æ¨å‹•æµª', pass: true },
        { rule: 'ç¬¬4æµªä¸é‡ç–Šç¬¬1æµªå€é–“', pass: true }
      ];
      document.getElementById('rulesContainer').innerHTML = r.map(x => `
        <div class="rule-item ${x.pass ? 'pass' : 'fail'}">
          <span class="rule-icon">${x.pass ? 'âœ…' : 'âŒ'}</span>
          <span class="rule-text">${x.rule}</span>
        </div>
      `).join('');
    }
    
    function renderWaveHistory(waves, currentPrice, currentWave) {
      const container = document.getElementById('waveHistoryContainer');
      if (!waves || !waves.length) {
        container.innerHTML = '<div style="color: #8b949e; text-align: center; padding: 20px;">æš«ç„¡æ³¢æµªæ•¸æ“š</div>';
        return;
      }
      
      // æ³¢æµªæ­·å²ï¼šç”±èˆŠåˆ°æ–°æ’åº
      const order = { '1':1, '2':2, '3':3, '4':4, '5':5, 'A':6, 'B':7, 'C':8, 1:1, 2:2, 3:3, 4:4, 5:5 };
      const sortedWaves = [...waves].sort((a, b) => (order[a.wave] || 99) - (order[b.wave] || 99));
      
      container.innerHTML = sortedWaves.slice(0, 6).map(w => {
        const up = w.end > w.start;
        const pct = ((w.end - w.start) / w.start * 100).toFixed(1);
        const type = [1,3,5,'1','3','5'].includes(w.wave) ? 'æ¨å‹•' : 'ä¿®æ­£';
        const isCurrent = String(w.wave) === String(currentWave);
        
        return `
          <div class="wave-history-item ${isCurrent ? 'current' : ''}">
            <div>
              <div class="wave-name">ç¬¬ ${w.wave} æµª (${type})</div>
              ${isCurrent ? '<div class="wave-type">â† ç›®å‰</div>' : ''}
            </div>
            <div class="wave-price ${up ? 'up' : 'down'}">
              ${w.start.toFixed(1)} â†’ ${w.end.toFixed(1)}
            </div>
          </div>
        `;
      }).join('');
      
      // ç¾åƒ¹
      if (currentPrice) {
        container.innerHTML += `
          <div class="wave-history-item" style="background: rgba(88,166,255,0.1); border: 1px solid rgba(88,166,255,0.3);">
            <span style="color: #58a6ff;">ğŸ“ ç¾åƒ¹</span>
            <span style="color: #c9d1d9; font-weight: 700;">$${currentPrice.toFixed(2)}</span>
          </div>
        `;
      }
    }
    
    function renderFibonacci(data) {
      const price = data.currentPrice || 100;
      const high = data.targetUp || price * 1.1;
      const low = data.targetDown || price * 0.9;
      const range = high - low;
      
      const levels = [
        { r: '0%', p: low, c: '#3fb950' },
        { r: '23.6%', p: low + range * 0.236, c: '#58a6ff' },
        { r: '38.2%', p: low + range * 0.382, c: '#58a6ff' },
        { r: '50%', p: low + range * 0.5, c: '#d29922' },
        { r: '61.8%', p: low + range * 0.618, c: '#d29922' },
        { r: '100%', p: high, c: '#f85149' }
      ];
      
      document.getElementById('fibContainer').innerHTML = levels.map(l => {
        const near = Math.abs(l.p - price) < range * 0.08;
        return `
          <div class="fib-row" style="background: ${near ? 'rgba(88,166,255,0.15)' : '#161b22'}; border-color: ${l.c};">
            <span class="fib-ratio" style="color: ${l.c};">${l.r}</span>
            <span class="fib-price">$${l.p.toFixed(2)}</span>
          </div>
        `;
      }).join('');
    }
    
    function renderRecentData(history) {
      const container = document.getElementById('recentDataContainer');
      if (!history || !history.length) {
        container.innerHTML = '<div style="color: #8b949e; text-align: center;">æš«ç„¡æ•¸æ“š</div>';
        return;
      }
      
      // history å·²ç¶“æ˜¯æ­£åºï¼ˆèˆŠâ†’æ–°ï¼‰ï¼Œå–æœ€å¾Œ10ç­†é¡¯ç¤º
      const recent = history.slice(-10);
      
      container.innerHTML = `
        <table class="data-table">
          <thead><tr>
            <th>æ—¥æœŸ</th><th style="text-align:right;">é–‹</th><th style="text-align:right;">é«˜</th>
            <th style="text-align:right;">ä½</th><th style="text-align:right;">æ”¶</th>
          </tr></thead>
          <tbody>
            ${recent.map(d => {
              const up = d.close >= d.open;
              return `<tr class="${up ? 'up' : 'down'}">
                <td style="color: #8b949e;">${d.date ? new Date(d.date).toLocaleDateString('zh-TW') : '-'}</td>
                <td style="text-align:right;">${d.open?.toFixed(1) || '-'}</td>
                <td style="text-align:right;">${d.high?.toFixed(1) || '-'}</td>
                <td style="text-align:right;">${d.low?.toFixed(1) || '-'}</td>
                <td style="text-align:right; font-weight:600;">${d.close?.toFixed(1) || '-'}</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
        <div style="font-size: 0.7rem; color: #6b7280; text-align: center; margin-top: 8px;">
          å…± ${history.length} å¤©æ­·å²è³‡æ–™
        </div>
      `;
    }
    
    function renderChart(data) {
      const ctx = document.getElementById('priceChart').getContext('2d');
      if (priceChart) priceChart.destroy();
      
      const history = data.history || [];
      if (history.length === 0) return;
      
      // âš ï¸ API è¿”å›çš„ history å·²ç¶“æ˜¯æ­£åºï¼ˆèˆŠâ†’æ–°ï¼‰ï¼Œç›´æ¥ä½¿ç”¨ï¼
      // å·¦é‚Š = æœ€èˆŠï¼Œå³é‚Š = æœ€æ–°
      const labels = history.map(h => h.date ? new Date(h.date).toLocaleDateString('zh-TW', {month:'numeric', day:'numeric'}) : '');
      const prices = history.map(h => h.close);
      
      // å»ºç«‹æ³¢æµªæ¨™è¨˜ annotations - å¾ waves é™£åˆ—å–å¾—
      const annotations = {};
      const waves = data.waves || [];
      
      // ç‚ºæ¯å€‹æ³¢æµªæ‰¾åˆ°å°æ‡‰çš„åƒ¹æ ¼ä½ç½®ä¸¦æ¨™è¨˜
      waves.forEach((w, i) => {
        const waveLabel = String(w.wave);
        const color = waveColors[waveLabel] || '#58a6ff';
        
        // æ‰¾åˆ°æœ€æ¥è¿‘ end åƒ¹æ ¼çš„ç´¢å¼•ä½ç½®
        let bestIdx = -1;
        let bestDiff = Infinity;
        
        for (let j = 0; j < prices.length; j++) {
          const diff = Math.abs(prices[j] - w.end);
          if (diff < bestDiff) {
            bestDiff = diff;
            bestIdx = j;
          }
        }
        
        // ç¢ºä¿æ¨™è¨˜ä¸é‡ç–Š - å¾€å¾Œæ‰¾æ›´æ¥è¿‘çš„é»
        if (bestIdx >= 0 && bestIdx < prices.length) {
          // å¾®èª¿ä½ç½®é¿å…é‡ç–Š
          const isHigh = [1, 3, 5, 'A', 'C'].includes(w.wave) ? (w.end > w.start) : (w.end < w.start);
          
          annotations['wave_' + i] = {
            type: 'label',
            xValue: bestIdx,
            yValue: w.end,
            content: waveLabel,
            backgroundColor: color,
            color: 'white',
            font: { size: 12, weight: 'bold' },
            padding: { top: 4, bottom: 4, left: 7, right: 7 },
            borderRadius: 12,
            yAdjust: isHigh ? -15 : 15  // é«˜é»å¾€ä¸Šç§»ï¼Œä½é»å¾€ä¸‹ç§»
          };
        }
      });
      
      // åŠ ä¸Šç¾åƒ¹æ¨™è¨˜
      if (data.currentPrice && prices.length > 0) {
        annotations['current'] = {
          type: 'line',
          yMin: data.currentPrice,
          yMax: data.currentPrice,
          borderColor: '#58a6ff',
          borderWidth: 1,
          borderDash: [5, 5],
          label: {
            display: true,
            content: `ç¾åƒ¹ $${data.currentPrice.toFixed(1)}`,
            position: 'end',
            backgroundColor: '#58a6ff',
            color: 'white',
            font: { size: 10 }
          }
        };
      }
      
      priceChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            data: prices,
            borderColor: '#58a6ff',
            backgroundColor: 'rgba(88, 166, 255, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 1,
            pointHoverRadius: 5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { display: false },
            annotation: { annotations }
          },
          scales: {
            x: { grid: { color: '#21262d' }, ticks: { color: '#8b949e', maxTicksLimit: 15, maxRotation: 45 } },
            y: { grid: { color: '#21262d' }, ticks: { color: '#8b949e' } }
          }
        }
      });
    }
    
    function showLoading() {
      ['rulesContainer', 'waveHistoryContainer', 'fibContainer', 'recentDataContainer'].forEach(id => {
        document.getElementById(id).innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      });
    }
    
    // ========== æŠ•è³‡çµ„åˆ ==========
    
    function setBudget(val) {
      document.getElementById('budgetInput').value = val;
      document.querySelectorAll('.budget-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      renderPortfolio();
    }
    
    function renderPortfolio() {
      const budget = (parseInt(document.getElementById('budgetInput').value) || 60) * 10000;
      const container = document.getElementById('stockList');
      
      const data = portfolio.map(s => ({ ...s, amount: Math.round(budget * s.percent / 100) }));
      
      container.innerHTML = data.map((s, i) => {
        const waveColor = s.wave === '-' ? '#8b949e' : 
                          [1,2,'1','2'].includes(s.wave) ? '#3fb950' : 
                          [3,4,'3','4'].includes(s.wave) ? '#d29922' : '#f85149';
        return `
          <div class="stock-item">
            <div class="name">${s.id} ${s.name}</div>
            <div>
              <div class="sector">${s.sector}</div>
              <div style="color: #8b949e; font-size: 0.75rem;">${s.reason}</div>
            </div>
            <div class="amount">$${s.amount.toLocaleString()}</div>
            <input type="number" value="${s.percent}" min="0" max="100" onchange="updatePercent(${i}, this.value)" />
            <span class="wave-badge" style="background: ${waveColor}22; color: ${waveColor}; border: 1px solid ${waveColor}44;">
              ${s.wave === '-' ? 'ç¾é‡‘' : 'ç¬¬'+s.wave+'æµª'}
            </span>
            ${s.id !== 'CASH' ? `<button class="delete-btn" onclick="deleteStock(${i})">ğŸ—‘ï¸</button>` : '<span></span>'}
          </div>
        `;
      }).join('');
      
      const stockTotal = data.filter(p => p.id !== 'CASH').reduce((sum, p) => sum + p.amount, 0);
      const cashTotal = data.find(p => p.id === 'CASH')?.amount || 0;
      document.getElementById('sumBudget').textContent = '$' + budget.toLocaleString();
      document.getElementById('sumStock').textContent = '$' + stockTotal.toLocaleString();
      document.getElementById('sumCash').textContent = '$' + cashTotal.toLocaleString();
      
      calculateRisk(data);
      renderSectorBars(data);
    }
    
    function updatePercent(i, val) {
      portfolio[i].percent = parseInt(val) || 0;
      renderPortfolio();
    }
    
    function deleteStock(i) {
      if (confirm(`ç¢ºå®šåˆªé™¤ ${portfolio[i].name}ï¼Ÿ`)) {
        portfolio.splice(i, 1);
        renderPortfolio();
      }
    }
    
    function addStock() {
      const id = document.getElementById('newId').value.trim();
      const name = document.getElementById('newName').value.trim();
      const sector = document.getElementById('newSector').value.trim() || 'å…¶ä»–';
      const percent = parseInt(document.getElementById('newPercent').value) || 5;
      const reason = document.getElementById('newReason').value.trim() || 'è‡ªè¨‚é…ç½®';
      
      if (!id || !name) return alert('è«‹è¼¸å…¥ä»£ç¢¼å’Œåç¨±');
      if (portfolio.find(s => s.id === id)) return alert('æ­¤è‚¡ç¥¨å·²å­˜åœ¨');
      
      portfolio.push({ id, name, sector, percent, wave: '?', reason });
      ['newId', 'newName', 'newSector', 'newReason'].forEach(x => document.getElementById(x).value = '');
      document.getElementById('newPercent').value = '5';
      renderPortfolio();
    }
    
    function calculateRisk(data) {
      let score = 0, weight = 0;
      data.forEach(s => {
        if (s.id === 'CASH') return;
        let risk = 50;
        const w = s.wave;
        if ([1,2,'1','2'].includes(w)) risk = 25;
        else if ([3,'3'].includes(w)) risk = 40;
        else if ([4,'4'].includes(w)) risk = 55;
        else if ([5,'5'].includes(w)) risk = 70;
        else if (['A','B','C'].includes(w)) risk = 80;
        
        if (s.sector.includes('ETF')) risk -= 15;
        if (s.sector.includes('é‡‘è')) risk -= 10;
        if (s.sector.includes('è¨˜æ†¶é«”')) risk += 10;
        
        score += risk * s.percent;
        weight += s.percent;
      });
      
      const avg = weight > 0 ? Math.round(score / weight) : 50;
      document.getElementById('sumRiskScore').textContent = avg;
      document.getElementById('riskIndicator').style.left = avg + '%';
      document.getElementById('riskIndicator').textContent = avg;
      
      let level = 'ä½', color = '#3fb950', comment = 'çµ„åˆé¢¨éšªåä½ï¼Œé…ç½®ä¿å®ˆã€‚å¯é©åº¦å¢åŠ æˆé•·è‚¡æé«˜å ±é…¬ã€‚';
      if (avg >= 60) {
        level = 'é«˜'; color = '#f85149';
        comment = 'çµ„åˆé¢¨éšªè¼ƒé«˜ï¼Œå»ºè­°å¢åŠ é˜²ç¦¦æ€§æ¨™çš„ï¼ˆé«˜è‚¡æ¯ETFã€é‡‘èè‚¡ï¼‰é™ä½æ³¢å‹•ã€‚';
      } else if (avg >= 40) {
        level = 'ä¸­'; color = '#d29922';
        comment = 'çµ„åˆé¢¨éšªé©ä¸­ï¼Œæ”»å®ˆå…¼å‚™ã€‚å¯æ ¹æ“šå¸‚å ´ç‹€æ³é©åº¦èª¿æ•´ã€‚';
      }
      
      document.getElementById('sumRiskLevel').textContent = level;
      document.getElementById('sumRiskLevel').style.color = color;
      document.getElementById('riskComment').textContent = comment;
    }
    
    function renderSectorBars(data) {
      const sectors = {};
      const colors = { 'åŠå°é«”': '#58a6ff', 'ETF': '#3fb950', 'é‡‘è': '#d29922', 'è¨˜æ†¶é«”': '#f85149', 'ç¾é‡‘': '#8b949e', 'å…¶ä»–': '#a371f7' };
      
      data.forEach(p => {
        let cat = 'å…¶ä»–';
        if (p.id === 'CASH') cat = 'ç¾é‡‘';
        else if (p.sector.includes('åŠå°é«”') || p.sector.includes('IC')) cat = 'åŠå°é«”';
        else if (p.sector.includes('ETF')) cat = 'ETF';
        else if (p.sector.includes('é‡‘è')) cat = 'é‡‘è';
        else if (p.sector.includes('è¨˜æ†¶é«”')) cat = 'è¨˜æ†¶é«”';
        sectors[cat] = (sectors[cat] || 0) + p.percent;
      });
      
      document.getElementById('sectorBars').innerHTML = Object.entries(sectors)
        .sort((a, b) => b[1] - a[1])
        .map(([name, pct]) => `
          <div class="sector-row">
            <div class="name">${name}</div>
            <div class="bar-bg">
              <div class="bar-fill" style="width: ${pct}%; background: ${colors[name] || '#58a6ff'};">
                <span>${pct}%</span>
              </div>
            </div>
          </div>
        `).join('');
    }
  </script>
</body>
</html>
