<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a1a2e">
    <title>æŒè‚¡ç®¡ç† - è‚¡æµ·ç§˜æ›¸</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460); 
            color: white; 
            min-height: 100vh; 
            padding: 20px 20px 100px;
        }
        .container { max-width: 600px; margin: 0 auto; }
        
        /* Header */
        .header { display: flex; align-items: center; margin-bottom: 20px; }
        .back-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; margin-right: 10px; text-decoration: none; }
        h1 { font-size: 20px; flex: 1; }
        
        /* çµ±è¨ˆå¡ç‰‡ */
        .stats-card {
            background: linear-gradient(135deg, rgba(255,200,100,0.2), rgba(255,150,50,0.1));
            border: 1px solid rgba(255,200,100,0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .stats-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .stats-label { color: rgba(255,255,255,0.7); font-size: 13px; }
        .stats-value { font-size: 18px; font-weight: bold; }
        .stats-value.profit { color: #ff4444; }
        .stats-value.loss { color: #00C851; }
        
        /* æ–°å¢å€å¡Š */
        .add-section {
            background: rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .add-section h2 { font-size: 16px; margin-bottom: 15px; color: #ffd700; }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
        .form-row.full { grid-template-columns: 1fr; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-size: 11px; color: rgba(255,255,255,0.6); margin-bottom: 4px; }
        .form-group input, .form-group select {
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 14px;
        }
        .form-group input::placeholder { color: rgba(255,255,255,0.4); }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #ffd700;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 0;
        }
        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #ffd700;
        }
        .checkbox-group label { font-size: 14px; }
        
        .add-btn {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #1a1a2e;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        .add-btn:disabled { background: #666; color: #999; }
        
        /* æŒè‚¡æ¸…å–® */
        .holdings-list { margin-top: 20px; }
        .holdings-list h2 { font-size: 14px; color: rgba(255,255,255,0.6); margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        
        .holding-card {
            background: rgba(255,255,255,0.08);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.2s;
        }
        .holding-card:hover { transform: translateY(-2px); }
        .holding-card.won { border-left: 4px solid #ffd700; }
        .holding-card.pending { border-left: 4px solid #888; }
        
        .holding-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .holding-name { font-size: 17px; font-weight: bold; }
        .holding-id { font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 2px; }
        .holding-status { 
            padding: 4px 10px; 
            border-radius: 12px; 
            font-size: 11px; 
            font-weight: bold;
        }
        .holding-status.won { background: rgba(255,215,0,0.2); color: #ffd700; }
        .holding-status.pending { background: rgba(136,136,136,0.2); color: #888; }
        
        .holding-prices {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .price-item { text-align: center; }
        .price-label { font-size: 10px; color: rgba(255,255,255,0.5); margin-bottom: 2px; }
        .price-value { font-size: 15px; font-weight: 600; }
        .price-value.current { color: #ffd700; }
        
        .holding-profit {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .profit-label { font-size: 12px; color: rgba(255,255,255,0.6); }
        .profit-value { font-size: 18px; font-weight: bold; }
        .profit-value.up { color: #ff4444; }
        .profit-value.down { color: #00C851; }
        
        .holding-targets {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }
        .target-item {
            display: flex;
            flex-direction: column;
        }
        .target-item label { font-size: 10px; color: rgba(255,255,255,0.5); margin-bottom: 4px; }
        .target-item input {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 13px;
        }
        
        .holding-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .holding-actions button {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
        }
        .save-btn { background: #ffd700; color: #1a1a2e; }
        .delete-btn { background: rgba(255,68,68,0.2); color: #ff6b6b; }
        .notify-btn { background: rgba(6,199,85,0.2); color: #06C755; }
        .notify-btn.off { background: rgba(136,136,136,0.2); color: #888; }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            z-index: 1000;
            display: none;
        }
        .toast.show { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* ç©ºç‹€æ…‹ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255,255,255,0.5);
        }
        .empty-state .icon { font-size: 60px; margin-bottom: 20px; }
        
        /* è¼‰å…¥ä¸­ */
        .loading { text-align: center; padding: 40px; color: rgba(255,255,255,0.6); }
        
        /* åº•éƒ¨å°èˆª */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(26,26,46,0.95);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            padding: 12px 0 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: rgba(255,255,255,0.5);
            font-size: 10px;
            cursor: pointer;
            padding: 5px 15px;
            text-decoration: none;
        }
        .nav-item.active { color: #ffd700; }
        .nav-item span:first-child { font-size: 22px; margin-bottom: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/" class="back-btn">â†</a>
            <h1>ğŸ’¼ æŒè‚¡ç®¡ç†</h1>
        </div>
        
        <!-- Tab åˆ‡æ› -->
        <div class="tab-container" style="display:flex; gap:10px; margin-bottom:20px;">
            <button class="tab-btn active" id="tabHolding" onclick="switchTab('holding')">ğŸ’¼ æŒè‚¡ä¸­</button>
            <button class="tab-btn" id="tabSold" onclick="switchTab('sold')">ğŸ“œ å·²è³£å‡º</button>
        </div>
        <style>
            .tab-btn { flex:1; padding:12px; border-radius:10px; font-weight:bold; cursor:pointer; transition:all 0.3s; }
            .tab-btn.active { background:linear-gradient(135deg,#ffd700,#ffaa00); color:#1a1a2e; border:none; }
            .tab-btn:not(.active) { background:transparent; color:#888; border:1px solid #666; }
        </style>
        
        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="stats-card" id="statsCard">
            <div class="stats-row">
                <span class="stats-label">ç¸½æŒè‚¡</span>
                <span class="stats-value" id="totalCount">- æª” / - å¼µ</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">ä»˜å‡ºç¸½åƒ¹ï¼ˆæˆæœ¬ï¼‰</span>
                <span class="stats-value" id="totalCost">-</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">ç›®å‰å¸‚å€¼</span>
                <span class="stats-value" id="totalValue">-</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">ç¸½æç›Š</span>
                <span class="stats-value" id="totalProfit">-</span>
            </div>
        </div>
        
        <!-- æ–°å¢æŒè‚¡ -->
        <div class="add-section">
            <h2>â• æ–°å¢æŒè‚¡</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>è‚¡ç¥¨ä»£ç¢¼ *</label>
                    <input type="text" id="stockId" placeholder="å¦‚ï¼š2330" maxlength="10">
                </div>
                <div class="form-group">
                    <label>å¼µæ•¸ï¼ˆ1å¼µ=1000è‚¡ï¼‰</label>
                    <input type="number" id="lots" placeholder="å¼µæ•¸" min="0" step="1">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>é›¶è‚¡ï¼ˆ1~999è‚¡ï¼‰</label>
                    <input type="number" id="oddShares" placeholder="é›¶è‚¡æ•¸" min="0" max="999" step="1">
                </div>
                <div class="form-group">
                    <label>ç¸½è‚¡æ•¸ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</label>
                    <input type="text" id="totalShares" placeholder="è‡ªå‹•è¨ˆç®—" readonly style="background:#222;">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>å‡ºæ¨™åƒ¹æ ¼ï¼ˆæ¯è‚¡ï¼‰</label>
                    <input type="number" id="bidPrice" placeholder="ç«¶æ¨™å‡ºåƒ¹" step="0.01">
                </div>
                <div class="form-group">
                    <label>æ¨™å¾—åƒ¹ä½ï¼ˆæ¯è‚¡ï¼‰</label>
                    <input type="number" id="wonPrice" placeholder="å¯¦éš›å¾—æ¨™åƒ¹" step="0.01">
                </div>
            </div>
            <div class="form-row full">
                <div class="form-group">
                    <label>ğŸ’° ä»˜å‡ºç¸½åƒ¹ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</label>
                    <input type="text" id="totalCostPreview" placeholder="è‡ªå‹•è¨ˆç®—ï¼šå¼µæ•¸Ã—1000Ã—æ¨™å¾—åƒ¹ + é›¶è‚¡Ã—æ¨™å¾—åƒ¹" readonly style="background:#222; color:#ffd700;">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>ä¸Šæ¼²ç›®æ¨™åƒ¹</label>
                    <input type="number" id="targetHigh" placeholder="é”åˆ°æ™‚é€šçŸ¥" step="0.01">
                </div>
                <div class="form-group">
                    <label>ä¸‹è·Œç›®æ¨™åƒ¹</label>
                    <input type="number" id="targetLow" placeholder="è·Œç ´æ™‚é€šçŸ¥" step="0.01">
                </div>
            </div>
            <div class="info-note" style="background:#333; padding:10px; border-radius:8px; margin-bottom:15px; font-size:12px; color:#aaa;">
                ğŸ’¡ <strong>æç¤ºï¼š</strong>æ–°å¢å¾Œé è¨­ç‚ºã€Œç«¶æ¨™ä¸­ã€ç‹€æ…‹<br>
                ã€€ å¾—æ¨™å¾Œï¼Œåœ¨ä¸‹æ–¹æŒè‚¡æ¸…å–®è¼¸å…¥ã€Œæ¨™å¾—åƒ¹ã€ä¸¦å„²å­˜ï¼Œå³è‡ªå‹•è®Šæˆã€Œå·²å¾—æ¨™ã€
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="notifyEnabled" checked>
                <label for="notifyEnabled">ğŸ”” é–‹å•Ÿ LINE é€šçŸ¥</label>
            </div>
            <button class="add-btn" onclick="addHolding()">æ–°å¢æŒè‚¡ï¼ˆç«¶æ¨™ä¸­ï¼‰</button>
        </div>
        
        <!-- æŒè‚¡æ¸…å–® -->
        <div class="holdings-list">
            <h2>ğŸ“Š æˆ‘çš„æŒè‚¡ <span id="holdingCount">(è¼‰å…¥ä¸­...)</span></h2>
            <div id="holdingsList">
                <div class="loading">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <!-- åº•éƒ¨å°èˆª -->
    <nav class="bottom-nav">
        <a href="/" class="nav-item"><span>ğŸ </span><span>é¦–é </span></a>
        <a href="/watchlist.html" class="nav-item"><span>ğŸ“‹</span><span>ç›£æ§</span></a>
        <a href="/holdings.html" class="nav-item active"><span>ğŸ’¼</span><span>æŒè‚¡</span></a>
        <a href="/settings.html" class="nav-item"><span>âš™ï¸</span><span>è¨­å®š</span></a>
    </nav>
    
    <script>
        const API = '/api/holdings';
        let currentTab = 'holding';
        
        // Tab åˆ‡æ›
        function switchTab(tab) {
            currentTab = tab;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.getElementById('tabHolding').className = tab === 'holding' ? 'tab-btn active' : 'tab-btn';
            document.getElementById('tabSold').className = tab === 'sold' ? 'tab-btn active' : 'tab-btn';
            
            // éš±è—/é¡¯ç¤ºæ–°å¢å€å¡Š
            document.querySelector('.add-section').style.display = tab === 'holding' ? 'block' : 'none';
            
            loadHoldings();
        }
        
        // è‡ªå‹•è¨ˆç®—ç¸½è‚¡æ•¸å’Œä»˜å‡ºç¸½åƒ¹
        function calcPreview() {
            const lots = parseInt(document.getElementById('lots').value) || 0;
            const oddShares = parseInt(document.getElementById('oddShares').value) || 0;
            const wonPrice = parseFloat(document.getElementById('wonPrice').value) || 0;
            const bidPrice = parseFloat(document.getElementById('bidPrice').value) || 0;
            
            const totalShares = lots * 1000 + oddShares;
            document.getElementById('totalShares').value = totalShares.toLocaleString() + ' è‚¡';
            
            const price = wonPrice || bidPrice;
            if (price > 0 && totalShares > 0) {
                const totalCost = totalShares * price;
                document.getElementById('totalCostPreview').value = '$' + Math.round(totalCost).toLocaleString();
            } else {
                document.getElementById('totalCostPreview').value = '';
            }
        }
        
        // ç›£è½è¼¸å…¥è®ŠåŒ–
        ['lots', 'oddShares', 'wonPrice', 'bidPrice'].forEach(id => {
            document.getElementById(id).addEventListener('input', calcPreview);
        });
        
        // è¼‰å…¥æŒè‚¡æ¸…å–®
        async function loadHoldings() {
            try {
                const url = currentTab === 'sold' ? (API + '?sold=true') : API;
                console.log('ğŸ“¡ è¼‰å…¥è³‡æ–™:', url);
                const res = await fetch(url);
                const data = await res.json();
                console.log('ğŸ“¦ API è¿”å›:', data);
                
                if (currentTab === 'sold') {
                    console.log('ğŸ“œ å·²è³£å‡ºç´€éŒ„:', data.holdings?.length || 0, 'ç­†');
                    renderSoldHoldings(data.holdings || []);
                    renderSoldStats(data.stats || {});
                } else {
                    renderHoldings(data.holdings || []);
                    renderStats(data.stats || {});
                }
            } catch (e) {
                console.error('âŒ è¼‰å…¥å¤±æ•—:', e);
                document.getElementById('holdingsList').innerHTML = '<div class="empty-state"><div class="icon">âŒ</div><p>è¼‰å…¥å¤±æ•—</p><p style="font-size:12px;color:#888;">' + e.message + '</p></div>';
            }
        }
        
        // æ¸²æŸ“çµ±è¨ˆï¼ˆæŒè‚¡ä¸­ï¼‰
        function renderStats(stats) {
            document.getElementById('totalCount').textContent = (stats.count || 0) + ' æª” / ' + (stats.totalLots || 0) + ' å¼µ ' + (stats.totalOddShares || 0) + ' è‚¡';
            document.getElementById('totalCost').textContent = stats.totalCost ? ('$' + Math.round(stats.totalCost).toLocaleString()) : '$0';
            document.getElementById('totalValue').textContent = stats.totalValue ? ('$' + Math.round(stats.totalValue).toLocaleString()) : '$0';
            
            var profit = stats.totalProfit || 0;
            var profitEl = document.getElementById('totalProfit');
            profitEl.textContent = (profit >= 0 ? '+' : '') + '$' + Math.round(profit).toLocaleString() + ' (' + (stats.totalProfitPercent || 0) + '%)';
            profitEl.className = 'stats-value ' + (profit >= 0 ? 'profit' : 'loss');
        }
        
        // æ¸²æŸ“çµ±è¨ˆï¼ˆå·²è³£å‡ºï¼‰
        function renderSoldStats(stats) {
            document.getElementById('totalCount').textContent = (stats.count || 0) + ' ç­†äº¤æ˜“';
            document.getElementById('totalCost').textContent = stats.totalCost ? ('$' + Math.round(stats.totalCost).toLocaleString()) : '$0';
            document.getElementById('totalValue').textContent = '-';
            
            var profit = stats.totalNetProfit || 0;
            var profitEl = document.getElementById('totalProfit');
            profitEl.textContent = (profit >= 0 ? '+' : '') + '$' + Math.round(profit).toLocaleString() + ' (' + (stats.totalProfitPercent || 0) + '%)';
            profitEl.className = 'stats-value ' + (profit >= 0 ? 'profit' : 'loss');
        }
        
        // æ ¼å¼åŒ–å¼µæ•¸é›¶è‚¡é¡¯ç¤º
        function formatLotsShares(totalShares) {
            const lots = Math.floor(totalShares / 1000);
            const odd = totalShares % 1000;
            if (lots > 0 && odd > 0) {
                return `${lots}å¼µ${odd}è‚¡`;
            } else if (lots > 0) {
                return `${lots}å¼µ`;
            } else {
                return `${odd}è‚¡`;
            }
        }
        
        // æ¸²æŸ“æŒè‚¡æ¸…å–®
        function renderHoldings(holdings) {
            const container = document.getElementById('holdingsList');
            document.getElementById('holdingCount').textContent = `(${holdings.length}ç­†)`;
            
            if (!holdings.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ“­</div>
                        <p>å°šç„¡æŒè‚¡ç´€éŒ„</p>
                        <p style="font-size:12px;margin-top:10px;">åœ¨ä¸Šæ–¹æ–°å¢ä½ çš„ç¬¬ä¸€ç­†æŒè‚¡å§ï¼</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = holdings.map(h => {
                const isUp = h.profitPercent >= 0;
                const profitClass = isUp ? 'up' : 'down';
                const statusClass = h.is_won ? 'won' : 'pending';
                const statusText = h.is_won ? 'âœ… å·²å¾—æ¨™' : 'â³ ç«¶æ¨™ä¸­';
                
                const lots = h.lots || Math.floor((h.shares || 0) / 1000);
                const oddShares = h.odd_shares !== undefined ? h.odd_shares : ((h.shares || 0) % 1000);
                const totalShares = lots * 1000 + oddShares;
                const lotsDisplay = formatLotsShares(totalShares);
                
                const costPrice = parseFloat(h.won_price) || parseFloat(h.bid_price) || 0;
                const paidTotal = costPrice * totalShares;
                
                return `
                    <div class="holding-card ${statusClass}" data-id="${h.id}">
                        <div class="holding-header">
                            <div>
                                <div class="holding-name">${h.stock_name || h.stock_id}</div>
                                <div class="holding-id">${h.stock_id} | ${lotsDisplay}</div>
                            </div>
                            <span class="holding-status ${statusClass}">${statusText}</span>
                        </div>
                        
                        <!-- å¯ç·¨è¼¯çš„å¼µæ•¸/é›¶è‚¡ -->
                        <div class="holding-edit-row" style="display:flex; gap:10px; margin-bottom:10px;">
                            <div style="flex:1;">
                                <label style="font-size:10px; color:rgba(255,255,255,0.5);">ğŸ“¦ å¼µæ•¸</label>
                                <input type="number" class="edit-lots" value="${lots}" min="0" style="width:100%; padding:6px; border-radius:4px; border:1px solid #444; background:#222; color:#fff;">
                            </div>
                            <div style="flex:1;">
                                <label style="font-size:10px; color:rgba(255,255,255,0.5);">é›¶è‚¡</label>
                                <input type="number" class="edit-odd-shares" value="${oddShares}" min="0" max="999" style="width:100%; padding:6px; border-radius:4px; border:1px solid #444; background:#222; color:#fff;">
                            </div>
                        </div>
                        
                        <!-- å¯ç·¨è¼¯çš„åƒ¹æ ¼ -->
                        <div class="holding-prices" style="display:flex; gap:10px; margin-bottom:10px;">
                            <div style="flex:1;">
                                <label style="font-size:10px; color:rgba(255,255,255,0.5);">ğŸ’µ å‡ºæ¨™åƒ¹</label>
                                <input type="number" class="edit-bid-price" value="${h.bid_price || ''}" placeholder="å‡ºæ¨™åƒ¹" step="0.01" style="width:100%; padding:6px; border-radius:4px; border:1px solid #444; background:#222; color:#fff;">
                            </div>
                            <div style="flex:1;">
                                <label style="font-size:10px; color:rgba(255,255,255,0.5);">ğŸ¯ æ¨™å¾—åƒ¹ï¼ˆè¼¸å…¥å³å¾—æ¨™ï¼‰</label>
                                <input type="number" class="edit-won-price" value="${h.won_price || ''}" placeholder="è¼¸å…¥å¾—æ¨™åƒ¹" step="0.01" style="width:100%; padding:6px; border-radius:4px; border:1px solid ${h.is_won ? '#4CAF50' : '#ff9800'}; background:#222; color:${h.is_won ? '#4CAF50' : '#ff9800'}; font-weight:bold;">
                            </div>
                            <div style="flex:1;">
                                <label style="font-size:10px; color:rgba(255,255,255,0.5);">ğŸ“Š ç›®å‰è‚¡åƒ¹</label>
                                <div style="padding:6px; font-weight:bold; color:#00bcd4;">${h.currentPrice || '-'}</div>
                            </div>
                        </div>
                        
                        <div class="holding-cost" style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.1); margin-bottom:10px;">
                            <div>
                                <div style="font-size:10px; color:rgba(255,255,255,0.5);">ğŸ’° ä»˜å‡ºç¸½åƒ¹</div>
                                <div style="font-size:16px; font-weight:bold; color:#ffd700;">$${paidTotal > 0 ? Math.round(paidTotal).toLocaleString() : '-'}</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:10px; color:rgba(255,255,255,0.5);">ğŸ“Š ç›®å‰å¸‚å€¼</div>
                                <div style="font-size:16px; font-weight:bold;">$${h.currentPrice && totalShares ? Math.round(h.currentPrice * totalShares).toLocaleString() : '-'}</div>
                            </div>
                        </div>
                        
                        <div class="holding-profit" style="${h.is_won ? '' : 'opacity:0.5;'}">
                            <span class="profit-label">æç›Š${h.is_won ? '' : 'ï¼ˆå¾—æ¨™å¾Œè¨ˆç®—ï¼‰'}</span>
                            <span class="profit-value ${profitClass}">
                                ${h.is_won ? `${isUp ? 'â–²' : 'â–¼'} $${h.profit ? Math.abs(Math.round(h.profit)).toLocaleString() : 0} (${h.profitPercent >= 0 ? '+' : ''}${h.profitPercent || 0}%)` : '-'}
                            </span>
                        </div>
                        
                        <div class="holding-targets">
                            <div class="target-item">
                                <label>ğŸ“ˆ ä¸Šæ¼²ç›®æ¨™åƒ¹</label>
                                <input type="number" class="target-high" value="${h.target_price_high || ''}" placeholder="æœªè¨­å®š" step="0.01">
                            </div>
                            <div class="target-item">
                                <label>ğŸ“‰ ä¸‹è·Œç›®æ¨™åƒ¹</label>
                                <input type="number" class="target-low" value="${h.target_price_low || ''}" placeholder="æœªè¨­å®š" step="0.01">
                            </div>
                        </div>
                        
                        <div class="holding-actions">
                            <button class="notify-btn ${h.notify_enabled ? '' : 'off'}" onclick="toggleNotify(${h.id}, ${!h.notify_enabled})">
                                ${h.notify_enabled ? 'ğŸ”” é€šçŸ¥é–‹' : 'ğŸ”• é€šçŸ¥é—œ'}
                            </button>
                            <button class="save-btn" onclick="saveHolding(${h.id})">ğŸ’¾ å„²å­˜</button>
                            ${h.is_won ? '<button class="sell-btn" data-id="' + h.id + '" data-name="' + (h.stock_name || h.stock_id) + '" data-price="' + (h.won_price || 0) + '" data-lots="' + lots + '" data-odd="' + oddShares + '" onclick="showSellModal(this)" style="background:linear-gradient(135deg,#4CAF50,#2E7D32);color:#fff;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;">ğŸ’° è³£å‡º</button>' : ''}
                            <button class="ai-btn" onclick="analyzeStock('${h.stock_id}')" style="background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;">ğŸ¤– AI</button>
                            <button class="delete-btn" onclick="deleteHolding(${h.id})">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // æ¸²æŸ“å·²è³£å‡ºç´€éŒ„
        function renderSoldHoldings(holdings) {
            var container = document.getElementById('holdingsList');
            document.getElementById('holdingCount').textContent = '(' + holdings.length + 'ç­†)';
            
            if (!holdings.length) {
                container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“­</div><p>å°šç„¡å·²è³£å‡ºç´€éŒ„</p><p style="font-size:12px;margin-top:10px;">åœ¨ã€ŒæŒè‚¡ä¸­ã€æ¨™è¨˜è³£å‡ºå¾Œæœƒé¡¯ç¤ºåœ¨é€™è£¡</p></div>';
                return;
            }
            
            container.innerHTML = holdings.map(function(h) {
                var isUp = (h.netProfit || 0) >= 0;
                var lots = h.lots || 0;
                var oddShares = h.odd_shares || 0;
                var totalShares = lots * 1000 + oddShares;
                var lotsDisplay = formatLotsShares(totalShares);
                var soldDate = h.sold_date ? new Date(h.sold_date).toLocaleDateString('zh-TW') : '-';
                var color = isUp ? '#ff6b6b' : '#4CAF50';
                var priceDiff = ((h.sold_price || 0) - (h.won_price || 0)).toFixed(2);
                
                return '<div class="holding-card won" data-id="' + h.id + '" style="border-left:4px solid ' + color + ';">' +
                    '<div class="holding-header">' +
                        '<div>' +
                            '<div class="holding-name">' + (h.stock_name || h.stock_id) + '</div>' +
                            '<div class="holding-id">' + h.stock_id + ' | ' + lotsDisplay + ' | è³£å‡ºæ—¥ï¼š' + soldDate + '</div>' +
                        '</div>' +
                        '<span class="holding-status" style="background:' + (isUp ? 'rgba(211,47,47,0.2)' : 'rgba(56,142,60,0.2)') + ';color:' + color + ';">' + (isUp ? 'âœ… ç²åˆ©' : 'ğŸ“‰ è™§æ') + '</span>' +
                    '</div>' +
                    '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:15px;text-align:center;">' +
                        '<div><div style="font-size:10px;color:rgba(255,255,255,0.5);">å¾—æ¨™åƒ¹</div><div style="font-size:14px;">$' + (h.won_price || '-') + '</div></div>' +
                        '<div><div style="font-size:10px;color:rgba(255,255,255,0.5);">è³£å‡ºåƒ¹</div><div style="font-size:14px;color:' + color + ';font-weight:bold;">$' + (h.sold_price || '-') + '</div></div>' +
                        '<div><div style="font-size:10px;color:rgba(255,255,255,0.5);">åƒ¹å·®</div><div style="font-size:14px;color:' + color + ';">' + (isUp ? '+' : '') + '$' + priceDiff + '</div></div>' +
                    '</div>' +
                    '<div style="background:rgba(0,0,0,0.3);padding:12px;border-radius:8px;margin-bottom:10px;">' +
                        '<div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span style="font-size:12px;color:rgba(255,255,255,0.6);">è²·å…¥æ‰‹çºŒè²»</span><span style="font-size:12px;">$' + (h.buyFee || 0).toLocaleString() + '</span></div>' +
                        '<div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span style="font-size:12px;color:rgba(255,255,255,0.6);">è³£å‡ºæ‰‹çºŒè²»</span><span style="font-size:12px;">$' + (h.sellFee || 0).toLocaleString() + '</span></div>' +
                        '<div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span style="font-size:12px;color:rgba(255,255,255,0.6);">äº¤æ˜“ç¨…</span><span style="font-size:12px;">$' + (h.tax || 0).toLocaleString() + '</span></div>' +
                        '<div style="border-top:1px solid rgba(255,255,255,0.2);padding-top:8px;display:flex;justify-content:space-between;">' +
                            '<span style="font-size:14px;font-weight:bold;">ğŸ’µ å¯¦éš›æ·¨æç›Š</span>' +
                            '<span style="font-size:16px;font-weight:bold;color:' + color + ';">' + (isUp ? '+' : '') + '$' + Math.round(h.netProfit || 0).toLocaleString() + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="holding-actions" style="justify-content:flex-end;">' +
                        '<button class="delete-btn" onclick="deleteHolding(' + h.id + ')" style="background:rgba(255,68,68,0.2);color:#ff6b6b;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;">ğŸ—‘ï¸ åˆªé™¤ç´€éŒ„</button>' +
                    '</div>' +
                '</div>';
            }).join('');
        }
        
        // é¡¯ç¤ºè³£å‡ºå½ˆçª—
        function showSellModal(btn) {
            var id = btn.dataset.id;
            var stockName = btn.dataset.name;
            var wonPrice = parseFloat(btn.dataset.price) || 0;
            var lots = parseInt(btn.dataset.lots) || 0;
            var oddShares = parseInt(btn.dataset.odd) || 0;
            var totalShares = lots * 1000 + oddShares;
            var lotsDisplay = formatLotsShares(totalShares);
            
            // ç§»é™¤èˆŠå½ˆçª—
            var oldModal = document.getElementById('sellModal');
            if (oldModal) oldModal.remove();
            
            var modal = document.createElement('div');
            modal.id = 'sellModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;';
            
            modal.innerHTML = '<div style="background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:16px;padding:24px;max-width:400px;width:100%;border:1px solid rgba(255,255,255,0.1);">' +
                '<h3 style="color:#4CAF50;margin-bottom:20px;font-size:18px;">ğŸ’° è³£å‡º ' + stockName + '</h3>' +
                '<div style="margin-bottom:15px;">' +
                    '<div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span style="color:rgba(255,255,255,0.6);font-size:13px;">æŒè‚¡æ•¸é‡</span><span style="color:#fff;">' + lotsDisplay + '</span></div>' +
                    '<div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span style="color:rgba(255,255,255,0.6);font-size:13px;">å¾—æ¨™åƒ¹æ ¼</span><span style="color:#ffd700;">$' + wonPrice + '</span></div>' +
                '</div>' +
                '<div style="margin-bottom:20px;">' +
                    '<label style="display:block;color:rgba(255,255,255,0.7);font-size:12px;margin-bottom:6px;">è³£å‡ºåƒ¹æ ¼ï¼ˆæ¯è‚¡ï¼‰*</label>' +
                    '<input type="number" id="sellPriceInput" placeholder="è¼¸å…¥è³£å‡ºåƒ¹æ ¼" step="0.01" style="width:100%;padding:12px;border-radius:8px;border:1px solid #4CAF50;background:rgba(0,0,0,0.3);color:#fff;font-size:16px;">' +
                '</div>' +
                '<div id="sellPreview" style="background:rgba(0,0,0,0.3);padding:12px;border-radius:8px;margin-bottom:20px;display:none;">' +
                    '<div style="font-size:12px;color:rgba(255,255,255,0.6);margin-bottom:8px;">é ä¼°æ·¨æç›Š</div>' +
                    '<div id="sellProfitPreview" style="font-size:20px;font-weight:bold;"></div>' +
                '</div>' +
                '<div style="display:flex;gap:10px;">' +
                    '<button onclick="closeSellModal()" style="flex:1;padding:12px;border-radius:8px;border:1px solid #666;background:transparent;color:#888;cursor:pointer;">å–æ¶ˆ</button>' +
                    '<button onclick="confirmSell(' + id + ',' + wonPrice + ',' + totalShares + ')" style="flex:1;padding:12px;border-radius:8px;border:none;background:linear-gradient(135deg,#4CAF50,#2E7D32);color:#fff;font-weight:bold;cursor:pointer;">ç¢ºèªè³£å‡º</button>' +
                '</div>' +
            '</div>';
            
            document.body.appendChild(modal);
            
            // å³æ™‚é è¦½æç›Š
            var input = document.getElementById('sellPriceInput');
            input.addEventListener('input', function() {
                var sellPrice = parseFloat(input.value) || 0;
                if (sellPrice > 0) {
                    var cost = wonPrice * totalShares;
                    var value = sellPrice * totalShares;
                    var profit = value - cost;
                    var buyFee = Math.round(cost * 0.001425);
                    var sellFee = Math.round(value * 0.001425);
                    var tax = Math.round(value * 0.003);
                    var netProfit = profit - buyFee - sellFee - tax;
                    var isUp = netProfit >= 0;
                    
                    document.getElementById('sellPreview').style.display = 'block';
                    document.getElementById('sellProfitPreview').innerHTML = '<span style="color:' + (isUp ? '#ff6b6b' : '#4CAF50') + ';">' + (isUp ? '+' : '') + '$' + Math.round(netProfit).toLocaleString() + '</span><span style="font-size:12px;color:rgba(255,255,255,0.5);margin-left:8px;">(æ‰£é™¤æ‰‹çºŒè²»+ç¨…)</span>';
                } else {
                    document.getElementById('sellPreview').style.display = 'none';
                }
            });
            
            input.focus();
        }
        
        function closeSellModal() {
            var modal = document.getElementById('sellModal');
            if (modal) modal.remove();
        }
        
        async function confirmSell(id, wonPrice, totalShares) {
            var sellPrice = parseFloat(document.getElementById('sellPriceInput').value);
            if (!sellPrice || sellPrice <= 0) {
                showToast('âŒ è«‹è¼¸å…¥è³£å‡ºåƒ¹æ ¼');
                return;
            }
            
            try {
                var res = await fetch(API + '/' + id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        is_sold: true,
                        sold_price: sellPrice
                    })
                });
                var data = await res.json();
                if (data.success) {
                    showToast('âœ… å·²æ¨™è¨˜ç‚ºè³£å‡ºï¼');
                    closeSellModal();
                    loadHoldings();
                } else {
                    showToast('âŒ è³£å‡ºå¤±æ•—');
                }
            } catch (e) {
                showToast('âŒ ç¶²è·¯éŒ¯èª¤');
            }
        }
        
        // æ–°å¢æŒè‚¡
        async function addHolding() {
            const stockId = document.getElementById('stockId').value.trim().toUpperCase();
            if (!stockId) {
                showToast('âŒ è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼');
                return;
            }
            
            const lots = parseInt(document.getElementById('lots').value) || 0;
            const oddShares = parseInt(document.getElementById('oddShares').value) || 0;
            const totalShares = lots * 1000 + oddShares;
            const wonPrice = document.getElementById('wonPrice').value || null;
            
            const body = {
                stock_id: stockId,
                lots: lots,
                odd_shares: oddShares,
                shares: totalShares,
                bid_price: document.getElementById('bidPrice').value || null,
                won_price: wonPrice,
                // å¦‚æœæœ‰è¼¸å…¥å¾—æ¨™åƒ¹ï¼Œè‡ªå‹•è¨­ç‚ºå·²å¾—æ¨™ï¼›å¦å‰‡ç‚ºç«¶æ¨™ä¸­
                is_won: wonPrice && parseFloat(wonPrice) > 0 ? true : false,
                target_price_high: document.getElementById('targetHigh').value || null,
                target_price_low: document.getElementById('targetLow').value || null,
                notify_enabled: document.getElementById('notifyEnabled').checked
            };
            
            try {
                const res = await fetch(API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                
                if (data.success) {
                    const status = body.is_won ? 'å·²å¾—æ¨™' : 'ç«¶æ¨™ä¸­';
                    showToast(`âœ… å·²æ–°å¢ï¼š${data.holding.stock_name || stockId}ï¼ˆ${status}ï¼‰`);
                    // æ¸…ç©ºè¡¨å–®
                    document.getElementById('stockId').value = '';
                    document.getElementById('lots').value = '';
                    document.getElementById('oddShares').value = '';
                    document.getElementById('totalShares').value = '';
                    document.getElementById('bidPrice').value = '';
                    document.getElementById('wonPrice').value = '';
                    document.getElementById('targetHigh').value = '';
                    document.getElementById('targetLow').value = '';
                    document.getElementById('totalCostPreview').value = '';
                    document.getElementById('notifyEnabled').checked = true;
                    loadHoldings();
                } else {
                    showToast('âŒ ' + (data.error || 'æ–°å¢å¤±æ•—'));
                }
            } catch (e) {
                showToast('âŒ ç¶²è·¯éŒ¯èª¤');
            }
        }
        
        // å„²å­˜æŒè‚¡è¨­å®š
        async function saveHolding(id) {
            const card = document.querySelector(`[data-id="${id}"]`);
            
            // å–å¾—ç·¨è¼¯å¾Œçš„å€¼
            const lots = parseInt(card.querySelector('.edit-lots').value) || 0;
            const oddShares = parseInt(card.querySelector('.edit-odd-shares').value) || 0;
            const bidPrice = card.querySelector('.edit-bid-price').value || null;
            const wonPrice = card.querySelector('.edit-won-price').value || null;
            
            const body = {
                lots: lots,
                odd_shares: oddShares,
                bid_price: bidPrice,
                won_price: wonPrice,
                // å¦‚æœæœ‰è¼¸å…¥å¾—æ¨™åƒ¹ï¼Œè‡ªå‹•è¨­ç‚ºå·²å¾—æ¨™
                is_won: wonPrice && parseFloat(wonPrice) > 0 ? true : false,
                target_price_high: card.querySelector('.target-high').value || null,
                target_price_low: card.querySelector('.target-low').value || null
            };
            
            try {
                const res = await fetch(`${API}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                if (data.success) {
                    showToast(wonPrice ? 'âœ… å·²æ›´æ–°ç‚ºå¾—æ¨™ç‹€æ…‹' : 'âœ… è¨­å®šå·²å„²å­˜');
                    loadHoldings(); // é‡æ–°è¼‰å…¥ä»¥æ›´æ–°é¡¯ç¤º
                } else {
                    showToast('âŒ å„²å­˜å¤±æ•—');
                }
            } catch (e) {
                showToast('âŒ ç¶²è·¯éŒ¯èª¤');
            }
        }
        
        // åˆ‡æ›é€šçŸ¥
        async function toggleNotify(id, enabled) {
            try {
                const res = await fetch(`${API}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notify_enabled: enabled })
                });
                const data = await res.json();
                if (data.success) {
                    showToast(enabled ? 'ğŸ”” å·²é–‹å•Ÿé€šçŸ¥' : 'ğŸ”• å·²é—œé–‰é€šçŸ¥');
                    loadHoldings();
                }
            } catch (e) {
                showToast('âŒ ç¶²è·¯éŒ¯èª¤');
            }
        }
        
        // åˆªé™¤æŒè‚¡
        async function deleteHolding(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æŒè‚¡ç´€éŒ„ï¼Ÿ')) return;
            
            try {
                const res = await fetch(`${API}/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    showToast('âœ… å·²åˆªé™¤');
                    loadHoldings();
                }
            } catch (e) {
                showToast('âŒ ç¶²è·¯éŒ¯èª¤');
            }
        }
        
        // Toast
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }
        
        // AI åˆ†æ
        async function analyzeStock(stockId) {
            showToast('ğŸ¤– AI åˆ†æä¸­...');
            
            try {
                const res = await fetch(`/api/ai/analyze/${stockId}`);
                const data = await res.json();
                
                if (!data.success || !data.analysis?.combined) {
                    showToast('âŒ AI åˆ†æå¤±æ•—');
                    return;
                }
                
                const c = data.analysis.combined;
                const s = data.stockData;
                
                // é¡¯ç¤ºåˆ†æçµæœå½ˆçª—
                showAIModal(s, c, data.analysis);
                
            } catch (e) {
                showToast('âŒ ç¶²è·¯éŒ¯èª¤');
            }
        }
        
        // é¡¯ç¤º AI åˆ†æå½ˆçª—
        function showAIModal(stock, combined, fullAnalysis) {
            // ç§»é™¤èˆŠå½ˆçª—
            const oldModal = document.getElementById('aiModal');
            if (oldModal) oldModal.remove();
            
            const actionColors = {
                'strong_buy': '#D32F2F',
                'buy': '#FF5722',
                'hold': '#9E9E9E',
                'sell': '#4CAF50',
                'strong_sell': '#2E7D32'
            };
            
            const actionTexts = {
                'strong_buy': 'ğŸ”¥ å¼·åŠ›è²·å…¥',
                'buy': 'ğŸ“ˆ å»ºè­°è²·å…¥',
                'hold': 'â¸ï¸ æŒæœ‰è§€æœ›',
                'sell': 'ğŸ“‰ å»ºè­°è³£å‡º',
                'strong_sell': 'âš ï¸ å¼·åŠ›è³£å‡º'
            };
            
            const actionColor = actionColors[combined.action] || '#333';
            
            // AI ä¾†æºé¡¯ç¤º
            let aiSources = [];
            if (fullAnalysis.gemini) aiSources.push('ğŸ¤– Gemini');
            if (fullAnalysis.openai) aiSources.push('ğŸ§  GPT');
            const aiSourceText = aiSources.length > 0 ? aiSources.join(' + ') : 'ç„¡ AI å›æ‡‰';
            
            // å»ºç«‹å„ AI çš„è©³ç´°åˆ†æå¡ç‰‡
            const gemini = fullAnalysis.gemini;
            const openai = fullAnalysis.openai;
            
            // å»ºç«‹å–®å€‹ AI çš„è©³ç´°åˆ†æå¡ç‰‡
            function buildAICard(ai, name, icon, bgGradient) {
                if (!ai) {
                    return `
                        <div style="background:#333;padding:15px;border-radius:12px;margin-bottom:15px;text-align:center;">
                            <div style="font-size:14px;color:#888;">${icon} ${name}</div>
                            <div style="font-size:12px;color:#666;margin-top:5px;">æœªè¨­å®š API Key</div>
                        </div>
                    `;
                }
                
                const aColor = actionColors[ai.action] || '#666';
                
                return `
                    <div style="background:${bgGradient};padding:18px;border-radius:12px;margin-bottom:15px;">
                        <!-- æ¨™é ­ -->
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                            <div style="font-size:15px;font-weight:bold;color:#fff;">${icon} ${name}</div>
                            <div style="background:${aColor};padding:5px 12px;border-radius:12px;font-size:12px;color:#fff;font-weight:bold;">${actionTexts[ai.action] || ai.action}</div>
                        </div>
                        
                        <!-- ä¿¡å¿ƒåº¦ -->
                        <div style="font-size:13px;color:rgba(255,255,255,0.9);margin-bottom:12px;">
                            ğŸ¯ ä¿¡å¿ƒåº¦ï¼š<span style="font-weight:bold;font-size:16px;">${ai.confidence || '-'}%</span>
                        </div>
                        
                        <!-- åƒ¹æ ¼å»ºè­° -->
                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px;">
                            <div style="background:rgba(0,0,0,0.2);padding:10px;border-radius:8px;text-align:center;">
                                <div style="font-size:10px;color:rgba(255,255,255,0.6);">ğŸ’° è²·å…¥åƒ¹</div>
                                <div style="font-size:14px;color:#4CAF50;font-weight:bold;">${ai.buy_price ? '$' + ai.buy_price : '-'}</div>
                            </div>
                            <div style="background:rgba(0,0,0,0.2);padding:10px;border-radius:8px;text-align:center;">
                                <div style="font-size:10px;color:rgba(255,255,255,0.6);">ğŸ’µ è³£å‡ºåƒ¹</div>
                                <div style="font-size:14px;color:#F44336;font-weight:bold;">${ai.sell_price ? '$' + ai.sell_price : '-'}</div>
                            </div>
                            <div style="background:rgba(0,0,0,0.2);padding:10px;border-radius:8px;text-align:center;">
                                <div style="font-size:10px;color:rgba(255,255,255,0.6);">ğŸ›‘ åœæåƒ¹</div>
                                <div style="font-size:14px;color:#FF9800;font-weight:bold;">${ai.stop_loss ? '$' + ai.stop_loss : '-'}</div>
                            </div>
                        </div>
                        
                        <!-- æ”¯æ’å£“åŠ› -->
                        ${ai.support_price || ai.resistance_price ? `
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;">
                            <div style="background:rgba(76,175,80,0.2);padding:8px;border-radius:6px;text-align:center;">
                                <div style="font-size:10px;color:#81C784;">ğŸ“‰ æ”¯æ’åƒ¹ä½</div>
                                <div style="font-size:13px;color:#4CAF50;font-weight:bold;">${ai.support_price ? '$' + ai.support_price : '-'}</div>
                            </div>
                            <div style="background:rgba(244,67,54,0.2);padding:8px;border-radius:6px;text-align:center;">
                                <div style="font-size:10px;color:#E57373;">ğŸ“ˆ å£“åŠ›åƒ¹ä½</div>
                                <div style="font-size:13px;color:#F44336;font-weight:bold;">${ai.resistance_price ? '$' + ai.resistance_price : '-'}</div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- ç›®æ¨™åƒ¹ -->
                        ${ai.short_term_target || ai.mid_term_target ? `
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;">
                            <div style="background:rgba(255,255,255,0.1);padding:8px;border-radius:6px;text-align:center;">
                                <div style="font-size:10px;color:rgba(255,255,255,0.6);">ğŸ¯ çŸ­æœŸç›®æ¨™</div>
                                <div style="font-size:13px;color:#fff;font-weight:bold;">${ai.short_term_target ? '$' + ai.short_term_target : '-'}</div>
                            </div>
                            <div style="background:rgba(255,255,255,0.1);padding:8px;border-radius:6px;text-align:center;">
                                <div style="font-size:10px;color:rgba(255,255,255,0.6);">ğŸ† ä¸­æœŸç›®æ¨™</div>
                                <div style="font-size:13px;color:#fff;font-weight:bold;">${ai.mid_term_target ? '$' + ai.mid_term_target : '-'}</div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- è©³ç´°åˆ†æç†ç”± -->
                        ${ai.reason ? `
                        <div style="background:rgba(0,0,0,0.25);padding:12px;border-radius:8px;margin-bottom:10px;">
                            <div style="font-size:11px;color:rgba(255,255,255,0.6);margin-bottom:6px;">ğŸ’¬ åˆ†æç†ç”±</div>
                            <div style="font-size:13px;color:rgba(255,255,255,0.95);line-height:1.6;">${ai.reason}</div>
                        </div>
                        ` : ''}
                        
                        <!-- æŠ€è¡“é¢åˆ†æ -->
                        ${ai.technical_analysis ? `
                        <div style="background:rgba(0,0,0,0.2);padding:12px;border-radius:8px;margin-bottom:10px;">
                            <div style="font-size:11px;color:rgba(255,255,255,0.6);margin-bottom:6px;">ğŸ“Š æŠ€è¡“é¢åˆ†æ</div>
                            <div style="font-size:12px;color:rgba(255,255,255,0.9);line-height:1.5;">${ai.technical_analysis}</div>
                        </div>
                        ` : ''}
                        
                        <!-- è¶¨å‹¢åˆ†æ -->
                        ${ai.trend_analysis ? `
                        <div style="background:rgba(0,0,0,0.2);padding:12px;border-radius:8px;margin-bottom:10px;">
                            <div style="font-size:11px;color:rgba(255,255,255,0.6);margin-bottom:6px;">ğŸ“ˆ è¶¨å‹¢åˆ¤æ–·</div>
                            <div style="font-size:12px;color:rgba(255,255,255,0.9);line-height:1.5;">${ai.trend_analysis}</div>
                        </div>
                        ` : ''}
                        
                        <!-- æ“ä½œæ™‚æ©Ÿ -->
                        ${ai.timing ? `
                        <div style="background:rgba(255,193,7,0.2);padding:10px;border-radius:8px;margin-bottom:10px;">
                            <div style="font-size:12px;color:#FFD54F;">â° æ“ä½œæ™‚æ©Ÿ</div>
                            <div style="font-size:12px;color:#fff;margin-top:4px;line-height:1.5;">${ai.timing}</div>
                        </div>
                        ` : ''}
                        
                        <!-- é¢¨éšªå› ç´  -->
                        ${ai.risk_factors ? `
                        <div style="background:rgba(244,67,54,0.15);padding:10px;border-radius:8px;">
                            <div style="font-size:12px;color:#EF9A9A;">âš ï¸ é¢¨éšªå› ç´ </div>
                            <div style="font-size:12px;color:rgba(255,255,255,0.85);margin-top:4px;">${ai.risk_factors}</div>
                        </div>
                        ` : ''}
                        
                        <!-- æŒè‚¡å»ºè­° -->
                        ${ai.holding_advice ? `
                        <div style="background:rgba(33,150,243,0.2);padding:10px;border-radius:8px;margin-top:10px;">
                            <div style="font-size:12px;color:#64B5F6;">ğŸ’¼ æŒè‚¡å»ºè­°</div>
                            <div style="font-size:12px;color:#fff;margin-top:4px;line-height:1.5;">${ai.holding_advice}</div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // Gemini åˆ†æå¡ç‰‡
            const geminiCard = buildAICard(gemini, 'Gemini åˆ†æ', 'ğŸ¤–', 'linear-gradient(135deg,#1a237e,#283593)');
            
            // OpenAI åˆ†æå¡ç‰‡
            const openaiCard = buildAICard(openai, 'OpenAI GPT åˆ†æ', 'ğŸ§ ', 'linear-gradient(135deg,#004d40,#00695c)');
            
            const modal = document.createElement('div');
            modal.id = 'aiModal';
            modal.innerHTML = `
                <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:flex-start;justify-content:center;padding:15px;overflow-y:auto;">
                    <div style="background:#1a1a2e;border-radius:16px;max-width:500px;width:100%;margin:20px 0;">
                        <!-- æ¨™é ­ -->
                        <div style="background:${actionColor};padding:20px;border-radius:16px 16px 0 0;position:sticky;top:0;z-index:10;">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <div>
                                    <div style="font-size:12px;color:rgba(255,255,255,0.8);">ğŸ¤– é›™ AI æ·±åº¦åˆ†æ</div>
                                    <div style="font-size:20px;font-weight:bold;color:#fff;margin-top:5px;">${stock.name}ï¼ˆ${stock.id}ï¼‰</div>
                                </div>
                                <button onclick="document.getElementById('aiModal').remove()" style="background:rgba(255,255,255,0.2);border:none;color:#fff;width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:18px;">âœ•</button>
                            </div>
                            <div style="margin-top:10px;font-size:12px;color:rgba(255,255,255,0.7);">${aiSourceText} ${combined.consensus ? 'âœ… é›™AIæ„è¦‹ä¸€è‡´' : 'âš–ï¸ AIæ„è¦‹ä¸åŒ'}</div>
                        </div>
                        
                        <div style="padding:20px;">
                            <!-- ç¶œåˆå»ºè­° -->
                            <div style="background:linear-gradient(135deg,#2d2d44,#1a1a2e);padding:20px;border-radius:12px;margin-bottom:20px;border:2px solid ${actionColor};">
                                <div style="text-align:center;">
                                    <div style="font-size:12px;color:#888;">ğŸ“Š ç¶œåˆå»ºè­°</div>
                                    <div style="font-size:32px;font-weight:bold;color:${actionColor};margin:10px 0;">${combined.actionText}</div>
                                    <div style="font-size:14px;color:#aaa;">ç¶œåˆä¿¡å¿ƒåº¦ï¼š<span style="color:#fff;font-weight:bold;font-size:18px;">${combined.finalConfidence}%</span></div>
                                </div>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:15px;">
                                    <div style="background:#222;padding:12px;border-radius:8px;text-align:center;">
                                        <div style="font-size:10px;color:#888;">ğŸ“Š ç¾åƒ¹</div>
                                        <div style="font-size:18px;font-weight:bold;color:#00bcd4;">$${stock.price}</div>
                                    </div>
                                    <div style="background:#222;padding:12px;border-radius:8px;text-align:center;">
                                        <div style="font-size:10px;color:#888;">ğŸ“ˆ æ¼²è·Œ</div>
                                        <div style="font-size:18px;font-weight:bold;color:${stock.change >= 0 ? '#ff4444' : '#00C851'};">${stock.change >= 0 ? '+' : ''}${stock.changePercent}%</div>
                                    </div>
                                </div>
                                
                                <!-- ç¶œåˆåƒ¹æ ¼å»ºè­° -->
                                <div style="margin-top:15px;padding-top:15px;border-top:1px solid #444;">
                                    <div style="font-size:11px;color:#888;text-align:center;margin-bottom:10px;">ğŸ’° ç¶œåˆåƒ¹æ ¼å»ºè­°ï¼ˆå–å¹³å‡å€¼ï¼‰</div>
                                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
                                        <div style="text-align:center;">
                                            <div style="font-size:10px;color:#888;">è²·å…¥åƒ¹</div>
                                            <div style="font-size:15px;font-weight:bold;color:#4CAF50;">${combined.buyPrice ? '$' + combined.buyPrice : '-'}</div>
                                        </div>
                                        <div style="text-align:center;">
                                            <div style="font-size:10px;color:#888;">è³£å‡ºåƒ¹</div>
                                            <div style="font-size:15px;font-weight:bold;color:#F44336;">${combined.sellPrice ? '$' + combined.sellPrice : '-'}</div>
                                        </div>
                                        <div style="text-align:center;">
                                            <div style="font-size:10px;color:#888;">åœæåƒ¹</div>
                                            <div style="font-size:15px;font-weight:bold;color:#FF9800;">${combined.stopLoss ? '$' + combined.stopLoss : '-'}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- åˆ†éš”ç·šæ¨™é¡Œ -->
                            <div style="display:flex;align-items:center;margin-bottom:15px;">
                                <div style="flex:1;height:1px;background:#444;"></div>
                                <div style="padding:0 15px;font-size:12px;color:#888;">ğŸ“‹ å„ AI è©³ç´°åˆ†æ</div>
                                <div style="flex:1;height:1px;background:#444;"></div>
                            </div>
                            
                            <!-- Gemini åˆ†æå¡ç‰‡ -->
                            ${geminiCard}
                            
                            <!-- OpenAI åˆ†æå¡ç‰‡ -->
                            ${openaiCard}
                            
                            <!-- é¢¨éšªæç¤º -->
                            <div style="text-align:center;padding-top:15px;border-top:1px solid #333;">
                                <div style="font-size:11px;color:#888;">âš ï¸ AI å»ºè­°åƒ…ä¾›åƒè€ƒï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°</div>
                                <div style="font-size:11px;color:#666;margin-top:5px;">é¢¨éšªç­‰ç´šï¼š${combined.riskLevel || 'ä¸­'} | è«‹è‡ªè¡Œè©•ä¼°é¢¨éšªæ‰¿å—èƒ½åŠ›</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Enter éµæ–°å¢
        document.getElementById('stockId').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addHolding();
        });
        
        // åˆå§‹è¼‰å…¥
        loadHoldings();
    </script>
</body>
</html>
